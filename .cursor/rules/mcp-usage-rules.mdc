---
description: MCP運用ルール（cipher/serenaの使い分け、記録先、手順）
globs:
alwaysApply: false
---
version: "1.0.0"

# MCP運用ルール（cipher / serena）

本プロジェクトにおける MCP ベースAI支援の運用ルールを定義する。設計/仕様/進行に関する参照は `.serena/memories/` を起点とし、メモリ運用は [memory.mdc](mdc:.cursor/rules/memory.mdc)、ロギングは [logging-rules.mdc](mdc:.cursor/rules/logging-rules.mdc)、コーディングは [coding-rules.mdc](mdc:.cursor/rules/coding-rules.mdc) に従う。

## 1. 目的
- PLAN/ACT モードに準拠し、serena と cipher を役割分担して効率よく開発を進める。
- 機械メモリと人間計画の境界を明確化し、重複や齟齬を防ぐ。

## 2. エージェントの役割
- **serena（読む・まとめる）**
  - 役割: コード/メモリの読解、要約、差分把握、計画草案作成。
  - 入出力: `.serena/memories/`（機械メモリ）にのみ書き込み。コードや `tasks/` には直接書かない。
  - 制約: 副作用のある操作（コード編集、コマンド実行、外部MCPの呼出）は行わない。
- **cipher（記憶を提供する）**
  - 役割: 長期設計知識・意思決定ログの保存、他MCPツールのルーティング、メモリ検索結果の提供。
  - 入出力: 長期記憶（Cipher Memory）への追加・更新、および外部MCPへの橋渡し。

## 3. 保存場所と原本
- **機械メモリの原本**: `.serena/memories/`（serenaが管理）
- **人間向け計画の原本**: `.serena/memories/`（`mcp__serena__read_memory active-development-tasks` などを参照、Serena が管理）
- **設計/仕様の原本**: `.serena/memories/`（長期設計知識は Cipher 記憶に集約）

## 4. 運用フロー（概要）
- **PLAN（調査/設計）**
  1. serena が `.serena/memories/` や `src/` を読んで要約/差分/計画草案を `.serena/memories/` に記録。
  2. コーディングエージェント（Cursor / Claude Code / Gemini CLI 等）が `.serena/memories/` を参照し、実装タスクを決定。
- **ACT（実装/検証）**
  1. コーディングエージェントがコード編集/コマンド実行/テスト・Lint/必要なファイル更新を行う。
  2. 重要知見と決定事項を serena が `.serena/memories/` に記録し、長期的な教訓は Cipher 記憶へ反映する。

## 5. 使い分け判断基準
- 「読む/理解/棚卸/比較/計画案作成」→ serena
- 「編集/実行/検証/公開」→ コーディングエージェント（Cursor / Claude Code / Gemini CLI 等）
- 「記録反映（短期）」→ serena
- 「記録反映（長期）」→ cipher
- 「他MCP（web検索等）が必要」→ cipher
- 不明点が多い場合は serena で解像度を上げ、その結果を受けて cipher が実行。

## 6. 禁止事項
- serena がコードや `tasks/` を直接編集すること。
- コーディングエージェントが `.serena/memories/` / Cipher 記憶を確認せずに編集を開始すること。
- シークレットや API キーをMCPログ/プロンプトに出力すること（[logging-rules.mdc](mdc:.cursor/rules/logging-rules.mdc) 参照）。

## 7. 実行ガイドライン（連携フロー）
- コーディングエージェントが実施した作業結果は serena が `.serena/memories/` に反映する。
- 長期的に共有すべき知見は Cipher 記憶に保存し、後続タスクで再利用できるようにする。
- 追加でファイルを編集した場合は、その理由と影響をメモリに明記する。

## 8. メモリ更新義務
- 設計/仕様変更時は `.serena/memories/` および Cipher 長期記憶（必要に応じて）を更新。
- 進行状況や次アクションは `.serena/memories/`（例: `current-project-status`, `active-development-tasks`）を更新・参照。
- serena の学習結果は `.serena/memories/` に保存（必要に応じて Cipher 記憶へ移送）。

## 9. チェックリスト
- [ ] PLAN: serena が `.serena/memories/` に最新の要約/計画を保存したか？
- [ ] ACT: コーディングエージェントが必要作業を実施し、結果と決定事項を `.serena/memories/` / Cipher 記憶へ反映したか？
- [ ] シークレットや機微情報を出力/記録していないか？
- [ ] 共有すべき長期知識を Cipher 記憶に追加したか？

## 10. 例シナリオ
- 仕様と実装の乖離調査: serena が差分を `.serena/memories/` に記録 → コーディングエージェントが修正を実施し、結果を `.serena/memories/` / Cipher 記憶で共有。
- 新機能スパイク: serena が影響範囲/設計案 → コーディングエージェントが最小実装と検証を行い、成果と仕様を `.serena/memories/` / Cipher 記憶に反映。
- ビルド失敗: コーディングエージェントがログ収集・修正・再実行 → serena が原因と再発防止策を `.serena/memories/` に記録。
