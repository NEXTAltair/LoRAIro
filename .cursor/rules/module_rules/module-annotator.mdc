---
description: AI annotation module development guidelines for LoRAIro
globs: **/*annota*/*,**/local_packages/image-annotator-lib/**/*,**/src/lorairo/annotations/**/*,**/src/lorairo/services/annotation_service.py
alwaysApply: false
---
version: "2.0.0"
# LoRAIro AI Annotation Module Guidelines

## å‚ç…§ãƒ¡ãƒ¢ãƒª
- å…¨ä½“è¨ˆç”»: `.serena/memories/image_annotator_lib_completion_master_plan`
- è¨­è¨ˆæ•´ç†: `.serena/memories/annotator_lib_memory_reorganization_design_2025_10_30`
- æ•™è¨“ãƒ»ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹: `.serena/memories/annotator_lib_lessons_learned`
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£/æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: `.serena/memories/architecture_structure`, `.serena/memories/tech_stack`

## ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿: Local Package Integration
- **image-annotator-lib**: å¤–éƒ¨AIã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®çµ±åˆå®Œäº†
- **çµ±åˆãƒã‚¤ãƒ³ãƒˆ**: [ai_annotator.py](mdc:src/lorairo/annotations/ai_annotator.py)
- **ä¸»è¦æ©Ÿèƒ½**:
  - `get_available_annotator_models()`: åˆ©ç”¨å¯èƒ½ãªAIãƒ¢ãƒ‡ãƒ«å–å¾—
  - `call_annotate_library()`: ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  - `AiAnnotatorError`: ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ğŸ”„ é€²è¡Œä¸­: Service Layer Integration
- **AnnotationService**: [annotation_service.py](mdc:src/lorairo/services/annotation_service.py)
- **AnnotationWorker**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ç”¨ãƒ¯ãƒ¼ã‚«ãƒ¼
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: GUI â†’ Service â†’ Worker â†’ ai_annotator â†’ image-annotator-lib

### ğŸ“ ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 
```
src/lorairo/annotations/
â”œâ”€â”€ ai_annotator.py          # âœ… image-annotator-libçµ±åˆ
â”œâ”€â”€ caption_tags.py          # ğŸ”„ ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ»ã‚¿ã‚°å‡¦ç†
â”œâ”€â”€ cleanup_txt.py           # âœ… genai-tag-db-toolsçµ±åˆ
â””â”€â”€ image_text_reader.py     # ğŸ“– ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿

src/lorairo/services/
â””â”€â”€ annotation_service.py    # ğŸ”„ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹

local_packages/
â”œâ”€â”€ image-annotator-lib/     # âœ… å¤–éƒ¨AIã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
â””â”€â”€ genai-tag-db-tools/      # âœ… ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†
```

## é–‹ç™ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### AI Provider Integration
- **çµ±åˆæ–¹æ³•**: `image-annotator-lib`çµŒç”±ã§çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä½¿ç”¨
- **ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: OpenAI, Anthropic, Google, Local models
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: `PHashAnnotationResults`ã§æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: `AiAnnotatorError`ã§çµ±ä¸€çš„ãªä¾‹å¤–å‡¦ç†

### Tag Processing Integration
- **çµ±åˆæ–¹æ³•**: `genai-tag-db-tools`ã®ã‚¿ã‚°ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ä½¿ç”¨
- **ä¸»è¦æ©Ÿèƒ½**: `initialize_tag_searcher()`ã«ã‚ˆã‚‹ã‚¿ã‚°æ­£è¦åŒ–
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: `tags_v3.db`ã®ã‚¿ã‚°åˆ†é¡ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨
- **ãƒ‘ã‚¹è§£æ±º**: [db_core.py](mdc:src/lorairo/database/db_core.py)çµŒç”±

### Code Quality Standards
```python
# è‰¯ã„ä¾‹: çµ±åˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨
from image_annotator_lib import annotate, list_available_annotators
from genai_tag_db_tools import initialize_tag_searcher

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
try:
    results = call_annotate_library(images, models, phashes)
except AiAnnotatorError as e:
    logger.error(f"Annotation failed: {e}")
```

### Testing Requirements
- **å˜ä½“ãƒ†ã‚¹ãƒˆ**: ãƒ¢ãƒƒã‚¯ä½¿ç”¨ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜ã‚’åˆ†é›¢
- **çµ±åˆãƒ†ã‚¹ãƒˆ**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã®å®Ÿéš›ã®çµ±åˆã‚’ãƒ†ã‚¹ãƒˆ
- **GUIãƒ†ã‚¹ãƒˆ**: ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®UIè¡¨ç¤ºã‚’ãƒ†ã‚¹ãƒˆ

## ç¦æ­¢äº‹é …
- âŒ ç›´æ¥çš„ãªAI Provider APIå‘¼ã³å‡ºã—ï¼ˆimage-annotator-libçµŒç”±ã‚’ä½¿ç”¨ï¼‰
- âŒ ç‹¬è‡ªã®ã‚¿ã‚°ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆgenai-tag-db-toolsä½¿ç”¨ï¼‰
- âŒ legacy `src/annotations/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‚ç…§ã‚„ä½¿ç”¨

## æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
- âœ… çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- âœ… æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›
- âœ… å‹ãƒ’ãƒ³ãƒˆå®Œå‚™
- âœ… éåŒæœŸå‡¦ç†ã§UIå¿œç­”æ€§ç¶­æŒ
