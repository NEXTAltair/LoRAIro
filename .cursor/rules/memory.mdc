---
description: 
globs: 
alwaysApply: false
---
# LoRAIro Project Context

This file, located at .cursor/rules/memory.mdc, serves as the central context repository for the LoRAIro project, maintaining context across development sessions.

## Project Overview
# LoRAIro Project Context File

## „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ¶ÇË¶Å

LoRAIro is an AI-powered image annotation and management application designed for machine learning dataset preparation. It automates image annotation using multiple AI providers and provides quality assessment for training datasets.

## Context File Structure

„Åì„Çå„ÅØ„ÄÅ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„ÇíÁî®„ÅÑ„Å¶„Éâ„Ç≠„É•„É°„É≥„ÉàÂåñ„Éª„É°„É¢„É™Á∂≠ÊåÅ„ÇíË°å„ÅÜ„Åü„ÇÅ„ÅÆÂü∫Êú¨ÂéüÂâá„ÄÅÂøÖË¶Å„Éï„Ç°„Ç§„É´„ÄÅ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÊßãÊàê„ÄÅ„Åä„Çà„Å≥ÈáçË¶ÅÊâãÈ†Ü„Çí„Åæ„Å®„ÇÅ„Åü„ÇÇ„ÅÆ„Åß„Åô„ÄÇ
„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅØ„ÄÅÂøÖÈ†à„ÅÆ„Ç≥„Ç¢„Éï„Ç°„Ç§„É´„Å®„Ç™„Éó„Ç∑„Éß„É≥„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅßÊßãÊàê„Åï„Çå„Åæ„Åô„ÄÇ„Éï„Ç°„Ç§„É´„ÅØÊòéÁ¢∫„Å™ÈöéÂ±§ÊßãÈÄ†„ÅßÁ©ç„Åø‰∏ä„Åí„Çâ„Çå„Åæ„Åô„ÄÇ

```mermaid
flowchart TD
    PB[ [product_requirement_docs.md](mdc:docs/product_requirement_docs.md) ] --> PC[ [technical.md](mdc:docs/technical.md) ]
    PB --> SP[ [architecture.md](mdc:docs/architecture.md) ]

    SP --> TC[ [tasks_plan.md](mdc:tasks/tasks_plan.md) ]
    PC --> TC
    PB --> TC

    TC --> AC[ [active_context.md](mdc:tasks/active_context.md) ]

    AC --> ER[ [error-documentation.mdc](mdc:.cursor/rules/error-documentation.mdc)]
    AC --> LL[ [lessons-learned.mdc](mdc:.cursor/rules/lessons-learned.mdc) ]

    subgraph LIT[ @docs/literature ]
        L1[...]
        L2[...]
    end

    subgraph RFC[ @tasks/rfc/ ]
        R1[...]
        R2[...]
    end

    PC --o LIT
    TC --o RFC
```

## „Ç≥„Ç¢„Éï„Ç°„Ç§„É´(ÂøÖÈ†à)
7„Éï„Ç°„Ç§„É´:
1. [product_requirement_docs.md](mdc:docs/product_requirement_docs.md) (docs/product_requirement_docs.md): „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆPRD(Ë£ΩÂìÅË¶ÅÊ±Ç‰ªïÊßòÊõ∏)„Åæ„Åü„ÅØSOP„ÄÇ
   - „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ≠òÂú®ÁêÜÁî±
   - Ëß£Ê±∫„Åô„ÇãÂïèÈ°å
   - „Ç≥„Ç¢Ë¶Å‰ª∂„Å®ÁõÆÊ®ô„ÇíÂÆöÁæ©
   - ‰ªñ„Éï„Ç°„Ç§„É´„ÇíÂΩ¢Êàê„Åô„ÇãÂü∫Á§éÊñáÊõ∏
   - „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çπ„Ç≥„Éº„Éó„ÅÆÂîØ‰∏Ä„ÅÆÊ≠£ÂÖ∏
   - Â≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈñãÂßãÊôÇ„Å´‰ΩúÊàê

2. [architecture.md](mdc:docs/architecture.md) (docs/architecture.md): „Ç∑„Çπ„ÉÜ„É†„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£
   - „Å©„ÅÆ„Çà„ÅÜ„Å´Âãï‰Ωú„Åô„Åπ„Åç„Åã
   - „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÈñì„ÅÆÈñ¢‰øÇ
   - ‰æùÂ≠òÈñ¢‰øÇ
   - „ÇΩ„É™„É•„Éº„Ç∑„Éß„É≥„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„Éº
   - Mermaid„Å´„Çà„Çã„ÇΩ„É™„É•„Éº„Ç∑„Éß„É≥Ê¶ÇË¶ÅÂõ≥:ÂêÑ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Ç≥„Éº„Éâ„Éï„É≠„Éº

3. [technical.md](mdc:docs/technical.md) (docs/technical.md): ÈñãÁô∫Áí∞Â¢É„Å®„Çπ„Çø„ÉÉ„ÇØ
   - ‰ΩøÁî®ÊäÄË°ì
   - ÈñãÁô∫„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
   - ‰∏ªË¶ÅÊäÄË°ìÊ±∫ÂÆö
   - ‰ΩøÁî®‰∏≠„ÅÆ„Éá„Ç∂„Ç§„É≥„Éë„Çø„Éº„É≥
   - ÊäÄË°ìÁöÑÂà∂Á¥Ñ

4. [tasks_plan.md](mdc:tasks/tasks_plan.md) (tasks/tasks_plan.md): Ë©≥Á¥∞„Çø„Çπ„ÇØ„Éê„ÉÉ„ÇØ„É≠„Ç∞
   - Ë©≥Á¥∞„Å™„Çø„Çπ„ÇØ„É™„Çπ„Éà„Å®ÈÄ≤Ë°åÁä∂Ê≥Å
   - ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„Åì„Å®
   - ÊÆã„Å£„Å¶„ÅÑ„ÇãÊßãÁØâ‰ΩúÊ•≠
   - ÁèæÂú®„ÅÆÁä∂Ê≥Å
   - Êó¢Áü•„ÅÆÂïèÈ°åÁÇπ

5. [active_context.md](mdc:tasks/active_context.md) (tasks/active_context.md): ÈñãÁô∫„ÅÆÁèæÂú®Áä∂ÊÖã
   - ÁèæÂú®„ÅÆ‰ΩúÊ•≠ÁÑ¶ÁÇπ
   - ÈÄ≤Ë°å‰∏≠„ÅÆÊ±∫ÂÆö„ÉªÊ§úË®é‰∫ãÈ†Ö
   - ÊúÄËøë„ÅÆÂ§âÊõ¥
   - Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó

6. [error-documentation.mdc](mdc:.cursor/rules/error-documentation.mdc) (.cursor/rules/error-documentation.mdc):
   - „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏≠„Å´Áô∫Ë¶ã„Åó„Åü‰øÆÊ≠£„ÇÑÂÜçÂà©Áî®„Åß„Åç„Çã‰øÆÊ≠£„ÅØ @error-documentation.mdc „Å´Ë®òÈå≤„Åó„ÄÅÂêå„Åò„Éü„Çπ„ÇíÁπ∞„ÇäËøî„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã„ÄÇ
   - Êó¢Áü•„ÅÆÂïèÈ°å:Áä∂ÊÖã„ÄÅËÉåÊôØ„ÄÅËß£Ê±∫Á≠ñ

7. [lessons-learned.mdc](mdc:.cursor/rules/lessons-learned.mdc) (.cursor/rules/lessons-learned.mdc): ÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ≠¶ÁøíË®òÈå≤
   - ÈáçË¶Å„Å™„Éë„Çø„Éº„É≥„ÄÅÂ•Ω„Åø„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁü•Ë≠ò„ÇíÂèéÈõÜ
   - @lessons-learned.mdc „Å´Ë©≥Á¥∞Ë®òËºâ

## „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´(„Ç™„Éó„Ç∑„Éß„É≥)
Ë©≥Á¥∞„Éâ„Ç≠„É•„É°„É≥„Éà„ÄÇÂøÖË¶ÅÊôÇ„Å´ÂèÇÁÖß„Åô„Çã„ÄÇ

1. docs/literature/ :
   - ÊñáÁåÆË™øÊüª„ÇÑÁ†îÁ©∂Ë®òÈå≤Áî®
   - ÂêÑÊñáÁåÆ„Éà„Éî„ÉÉ„ÇØ„ÅØ LaTeX „Éï„Ç°„Ç§„É´ (docs/literature/*.tex)

2. tasks/rfc/ :
   - @tasks_plan.md „Å´„ÅÇ„ÇãÂêÑ„Çø„Çπ„ÇØ„ÅÆRFC„ÇíÊ†ºÁ¥ç
   - RFC„ÅØLaTeX„Éï„Ç°„Ç§„É´ÂΩ¢Âºè (tasks/*.tex)

## ËøΩÂä†„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà
ÂøÖË¶Å„Å´Âøú„Åò„Å¶ docs/ „Åæ„Åü„ÅØ tasks/ „Å´ËøΩÂä†„Éï„Ç°„Ç§„É´„Éª„Éï„Ç©„É´„ÉÄ‰ΩúÊàêÂèØËÉΩ„ÄÇ
- Áµ±Âêà‰ªïÊßò
- „ÉÜ„Çπ„ÉàÊà¶Áï•
- „Éô„É≥„ÉÅ„Éû„Éº„ÇØÁí∞Â¢É
- Êã°ÂºµÊ°à
- „Éá„Éó„É≠„Ç§ÊâãÈ†Ü

# „Ç≥„Ç¢„ÉØ„Éº„ÇØ„Éï„É≠„Éº

„Åì„Çå„Çà„Çä„ÄÅ„É°„É¢„É™„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøÊõ∏„ÅçÊâãÈ†Ü„ÇíÂÆöÁæ©„Åô„Çã„ÄÇ
„Ç∑„Çπ„ÉÜ„É†„ÅØÊòéÁ¢∫„Å™„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åô„Çã:(PLAN/ACT)„ÄÅÂà•Âêç(Architect/Code)„ÄÇ„É¢„Éº„Éâ„ÅØ„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„Åæ„Åü„ÅØ„É™„ÇØ„Ç®„Çπ„ÉàÂÜÖÂÆπ„ÅßÊ±∫ÂÆö„ÄÇÂÖ•Âäõ„Å´„ÄåMODE = PLAN MODE / Architect MODE„Äç„ÇÑ„ÄåMODE = ACT MODE / Code MODE„Äç„ÅåÊòéÁ§∫„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Åù„Çå„Å´Âæì„ÅÜ„ÄÇ‰∏çÊòéÁ¢∫„Å™Â†¥Âêà„ÅØ„É¢„Éº„Éâ„ÇíË≥™Âïè„Åô„Çã„ÄÇ

## PLAN„Åæ„Åü„ÅØArchitect MODE
```mermaid
flowchart TD
    Start[ÈñãÂßã] --> ReadFiles[„É°„É¢„É™„Éï„Ç°„Ç§„É´„ÇíË™≠„ÇÄ ("docs/"„Å®"tasks/"„ÄÇÂøÖË¶Å„Å™„Çâ"docs/literature"„ÇÑ"tasks/rfc"„ÇÇ)]
    ReadFiles --> CheckFiles{„Éï„Ç°„Ç§„É´„ÅØÊèÉ„Å£„Å¶„ÅÑ„Çã„Åã?}

    CheckFiles -->|„ÅÑ„ÅÑ„Åà| Plan[Ë®àÁîª‰ΩúÊàê]
    Plan --> DocumentChat[„ÉÅ„É£„ÉÉ„Éà„ÅßË®òÈå≤]

    CheckFiles -->|„ÅØ„ÅÑ| VerifyContext[„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊ§úË®º]
    VerifyContext --> Strategy[Êà¶Áï•Á≠ñÂÆö]
    Strategy --> Present[ÊèêÊ°àÊèêÁ§∫]

    Present --> Verification{ÊèêÊ°à„ÅØÁ¢∫Ë™ç„Åï„Çå„Åü„Åã?}

    Verification -->|„ÅÑ„ÅÑ„Åà| Clarify[ÊòéÁ¢∫ÂåñË¶ÅÊ±Ç]
    Clarify --> Strategy[Êà¶Áï•Á≠ñÂÆö]

    Verification -->|„ÅØ„ÅÑ| DocumentMemory[„É°„É¢„É™„Éï„Ç°„Ç§„É´„Å´Ë®òÈå≤]
```

## ACT„Åæ„Åü„ÅØCode MODE
```mermaid
flowchart TD
    Start[ÈñãÂßã] --> Context[„É°„É¢„É™„Éï„Ç°„Ç§„É´„ÉÅ„Çß„ÉÉ„ÇØ]
    Context --> Update[„Éâ„Ç≠„É•„É°„É≥„ÉàÊõ¥Êñ∞]
    Update --> Rules[[lessons-learned.mdc]„Å®[error-documentation.mdc]„ÇíÊõ¥Êñ∞]
    Rules --> Execute[„Çø„Çπ„ÇØÂÆüË°å]
    Execute --> Document[Â§âÊõ¥„Çí„É°„É¢„É™„Éï„Ç°„Ç§„É´„Å´Ë®òÈå≤]
```

# „Éâ„Ç≠„É•„É°„É≥„ÉàÊõ¥Êñ∞

„É°„É¢„É™„Éï„Ç°„Ç§„É´„ÅÆÊõ¥Êñ∞„ÅØ‰ª•‰∏ã„ÅÆÊôÇ„Å´Áô∫Áîü„Åô„Çã„ÄÇ
1. Êñ∞„Åó„ÅÑ„Éë„Çø„Éº„É≥Áô∫Ë¶ãÊôÇ
2. ÈáçË¶Å„Å™Â§âÊõ¥Âæå
3. „É¶„Éº„Ç∂„Éº„Åå**„É°„É¢„É™„Éï„Ç°„Ç§„É´Êõ¥Êñ∞**„Çí‰æùÈ†º„Åó„ÅüÊôÇ(„Åô„Åπ„Å¶„ÅÆ„Ç≥„Ç¢„Éï„Ç°„Ç§„É´„Çí„É¨„Éì„É•„Éº)
4. „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÊòéÁ¢∫Âåñ„ÅåÂøÖË¶Å„Å™ÊôÇ
5. Ë®àÁîª„ÅÆ‰∏ªË¶ÅÈÉ®ÂàÜ„ÅåÊ§úË®º„Åï„Çå„ÅüÊôÇ

```mermaid
flowchart TD
    Start[Êõ¥Êñ∞„Éó„É≠„Çª„ÇπÈñãÂßã]

    subgraph Process
        P1[„Ç≥„Ç¢„Éï„Ç°„Ç§„É´„Çí„É¨„Éì„É•„Éº]
        P2[[active_context.md]„Å®[tasks_plan.md]„Å´ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíË®òÈå≤]
        P3[Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊòéÁ¢∫Âåñ„Åó[tasks_plan.md]„Å´Ë®òÈå≤]
        P4[[lessons-learned.mdc]„Å®[error-documentation.mdc]„ÇíÊõ¥Êñ∞]
        P5[[architecture.md]„ÇÇÊõ¥Êñ∞]

        P1 --> P2 --> P3 --> P4
    end

    Start --> Process
```

Ê≥®: **„É°„É¢„É™„Éï„Ç°„Ç§„É´Êõ¥Êñ∞**„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅÂøÖ„Åö„Åô„Åπ„Å¶„ÅÆ„Ç≥„Ç¢„Éï„Ç°„Ç§„É´„Çí„É¨„Éì„É•„Éº„ÄÇÁâπ„Å´ [active_context.md]„ÄÅ[tasks_plan.md]„ÄÅ[architecture.md] „ÇíÈáçÁÇπÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÄÇ

# „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁü•Ë≠ò ( [lessons-learned.mdc](mdc:.cursor/rules/lessons-learned.mdc) )

[lessons-learned.mdc] „ÅØÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ≠¶ÁøíË®òÈå≤„ÄÇ
„Ç≥„Éº„Éâ„Åã„Çâ„ÅØË¶ã„Åà„Å™„ÅÑÈáçË¶Å„Å™Áü•Ë¶ã„ÇíË®òÈå≤„Åó„ÄÅ‰ªäÂæå„ÅÆ‰ΩúÊ•≠ÂäπÁéáÂåñ„Å´ÂΩπÁ´ã„Å¶„Çã„ÄÇ

```mermaid
flowchart TD
    Start{Êñ∞„Åó„ÅÑ„Éë„Çø„Éº„É≥„ÇíÁô∫Ë¶ã}

    subgraph Learn [Â≠¶Áøí„Éó„É≠„Çª„Çπ]
        D1[„Éë„Çø„Éº„É≥ÁâπÂÆö]
        D2[„É¶„Éº„Ç∂„Éº„Å®Á¢∫Ë™ç]
        D3[[lessons-learned.mdc]„Å´Ë®òÈå≤]
    end

    subgraph Apply [ÈÅ©Áî®„Éó„É≠„Çª„Çπ]
        A1[[lessons-learned.mdc]„ÇíË™≠„ÇÄ]
        A2[Â≠¶„Çì„Å†„Éë„Çø„Éº„É≥„ÇíÈÅ©Áî®]
        A3[Â∞ÜÊù•„ÅÆ‰ΩúÊ•≠„ÇíÊîπÂñÑ]
    end

    Start --> Learn
    Learn --> Apply
```

## Ë®òÈå≤„Åô„Åπ„Åç‰∫ãÈ†Ö
- ÈáçË¶Å„Å™ÂÆüË£Ö„Éë„Çπ
- „É¶„Éº„Ç∂„Éº„ÅÆÂ•Ω„Åø„ÇÑ„ÉØ„Éº„ÇØ„Éï„É≠„Éº
- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁâπÊúâ„ÅÆ„Éë„Çø„Éº„É≥
- Êó¢Áü•„ÅÆË™≤È°å
- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊ±∫ÂÆö„ÅÆÊé®Áßª
- „ÉÑ„Éº„É´‰ΩøÁî®„Éë„Çø„Éº„É≥

„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅØÊüîËªü„ÄÇÂäπÊûúÁöÑ„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÄ≤„ÇÅ„Çã„Åü„ÇÅ„Å´ÂΩπÁ´ã„Å§Áü•Ë¶ã„Çí‰∏≠ÂøÉ„Å´Ë®òÈå≤„Åô„Çã„ÄÇ[lessons-learned.mdc]„ÅØ‰ΩúÊ•≠„ÇíÈáç„Å≠„Çã„Åî„Å®„Å´Ë≥¢„ÅèÊàêÈï∑„Åô„Çã„ÄåÁîü„Åç„Åü„Éâ„Ç≠„É•„É°„É≥„Éà„Äç„Å®ËÄÉ„Åà„Çã„ÄÇ

---

# LoRAIro ÊäÄË°ì‰ªïÊßò

## Core Architecture

### Application Layer
- **Entry Point**: `src/lorairo/main.py` - Qt application initialization
- **Main Window**: `src/lorairo/gui/window/main_window.py` - Primary GUI orchestrator
- **Configuration**: `config/lorairo.toml` - Application settings

### Service Layer
- **ImageProcessingService**: Image manipulation, resizing, format conversion
- **ConfigurationService**: Application configuration management
- **AnnotationService**: AI-powered image annotation coordination

### Data Layer
- **Database**: SQLite with SQLAlchemy ORM
- **Schema**: `src/lorairo/database/schema.py` - Database models
- **Repository**: `src/lorairo/database/db_repository.py` - Data access
- **Manager**: `src/lorairo/database/db_manager.py` - High-level operations

### GUI Architecture
- **Framework**: PySide6 (Qt for Python)
- **Designer Files**: `src/lorairo/gui/designer/` - Auto-generated UI
- **Widgets**: `src/lorairo/gui/widgets/` - Custom components
- **Windows**: `src/lorairo/gui/window/` - Window controllers

## Technology Stack

### Core Technologies
- **Python 3.11+**: Primary development language
- **PySide6**: GUI framework (Qt for Python)
- **SQLAlchemy**: ORM for database operations
- **SQLite**: Local database storage
- **Alembic**: Database migration management
- **uv**: Package management and virtual environments

### AI Integration
- **OpenAI GPT-4**: Image captioning and tagging
- **Anthropic Claude**: Advanced image analysis
- **Google Gemini**: Multi-modal AI processing
- **Local Models**: CLIP, DeepDanbooru for offline processing

### Development Tools
- **Ruff**: Linting and code formatting
- **mypy**: Static type checking
- **pytest**: Testing framework with coverage
- **Loguru**: Structured logging

## Key Design Patterns

### Repository Pattern
Database access is abstracted through repository layer for clean separation of concerns.

### Service Layer Pattern
Business logic is separated from GUI and data access through dedicated service classes.

### Dependency Injection
Services are injected into GUI components to maintain loose coupling.

### Configuration-Driven Development
All settings are externalized to TOML configuration files.

## Project Structure

```mermaid
flowchart TD
    Root[LoRAIro/] --> Config[config/]
    Root --> Src[src/lorairo/]
    Root --> Local[local_packages/]
    Root --> Tests[tests/]
    Root --> Docs[docs/]
    Root --> Tasks[tasks/]
    
    Config --> ConfigFile[lorairo.toml]
    
    Src --> Gui[gui/]
    Src --> Services[services/]
    Src --> Database[database/]
    Src --> Annotations[annotations/]
    Src --> ScoreModule[score_module/]
    Src --> Storage[storage/]
    
    Local --> GenaiTag[genai-tag-db-tools/]
    Local --> ImageAnnotator[image-annotator-lib/]
    
    Gui --> GuiDesigner[designer/]
    Gui --> GuiWidgets[widgets/]
    Gui --> GuiWindow[window/]
    
    Services --> ImageProcessing[ImageProcessingService]
    Services --> Configuration[ConfigurationService]
    Services --> Annotation[AnnotationService]
    
    Database --> Schema[schema.py]
    Database --> Repository[db_repository.py]
    Database --> Manager[db_manager.py]
    Database --> Core[db_core.py]
    Database --> Migrations[migrations/]
    
    Annotations --> AIAnnotator[ai_annotator.py]
    Annotations --> CaptionTags[caption_tags.py]
    Annotations --> CleanupTxt[cleanup_txt.py]
    Annotations --> ImageTextReader[image_text_reader.py]
    
    ScoreModule --> ClipAesthetic[clip_aesthetic_score.py]
    ScoreModule --> MusiqModule[musiq_module.py]
    ScoreModule --> RewardFunction[rewardfunction_score.py]
    ScoreModule --> Scorer[scorer.py]
    
    Storage --> FileSystem[file_system.py]
    
    classDef configClass fill:#e1f5fe
    classDef sourceClass fill:#f3e5f5
    classDef localClass fill:#e8f5e8
    classDef testClass fill:#fff3e0
    classDef docClass fill:#fce4ec
    
    class Config,ConfigFile configClass
    class Src,Gui,Services,Database,Annotations,ScoreModule,Storage,GuiDesigner,GuiWidgets,GuiWindow,ImageProcessing,Configuration,Annotation,Schema,Repository,Manager,Migrations,AIAnnotator,CaptionTags,CleanupTxt,ImageTextReader,ClipAesthetic,MusiqModule,RewardFunction,Scorer,FileSystem sourceClass
    class Local,GenaiTag,ImageAnnotator localClass
    class Tests testClass
    class Docs,Tasks docClass
```

## Development Environment

### Package Management
- Uses `uv` for dependency management
- Local packages linked via `uv.sources` in `pyproject.toml`
- Editable installs for development packages

### Code Quality
- **Line Length**: 108 characters
- **Type Hints**: Required for all functions
- **Import Style**: Modern Python types (list/dict not typing.List/Dict)
- **Path Operations**: Use pathlib, not os module

### Testing Strategy
- **Unit Tests**: Fast, isolated with mocking (`pytest -m unit`)
- **Integration Tests**: Service interactions (`pytest -m integration`)
- **GUI Tests**: PySide6 components (`pytest -m gui`)
- **Coverage Target**: Minimum 75%

## Local Dependencies

### genai-tag-db-tools
- **Purpose**: Tag database management utilities
- **Entry Point**: `tag-db` command
- **Location**: `local_packages/genai-tag-db-tools/`

### image-annotator-lib
- **Purpose**: Core image annotation functionality
- **Features**: Multi-provider AI annotation, local ML models
- **Location**: `local_packages/image-annotator-lib/`

## Configuration Management

### Main Configuration (`config/lorairo.toml`)
- Application settings and parameters
- AI provider configurations
- Database connection settings
- Logging configuration

### Environment Variables
- API keys for AI providers
- Development/production flags
- Debug settings

## Database Schema

### Core Tables
- **Images**: Image metadata and file paths
- **Annotations**: AI-generated captions and tags
- **Processing Status**: Track annotation progress
- **Quality Scores**: Aesthetic and technical assessments

### Migration Management
- Use Alembic for schema changes
- Migrations stored in `src/lorairo/database/migrations/`
- Auto-generate with: `alembic revision --autogenerate -m "description"`

## AI Provider Integration

### Supported Providers
- **OpenAI**: GPT-4 Vision for image analysis
- **Anthropic**: Claude for detailed descriptions
- **Google**: Gemini for multi-modal processing
- **Local Models**: CLIP, DeepDanbooru for offline work

### Configuration Pattern
```toml
[ai_providers.openai]
api_key_env = "OPENAI_API_KEY"
model = "gpt-4-vision-preview"
timeout = 30
retry_attempts = 3
```

## File Type Conventions

- **`.caption`**: AI-generated image captions
- **`.txt`**: Tag annotations for training
- **`.toml`**: Configuration files
- **`.ui`**: Qt Designer interface definitions
- **`.py`**: Python source code
- **`.md`**: Documentation (Markdown)

## Current Implementation Status

### ‚úÖ Completed Components
- **Local Package Integration**: Both `image-annotator-lib` and `genai-tag-db-tools` fully integrated
- **Database Layer**: Complete repository pattern with SQLAlchemy + Alembic
- **Service Layer**: Configuration, Image Processing, and Annotation services implemented
- **AI Integration**: Unified interface via `ai_annotator.py` for multi-provider support
- **Tag Processing**: Integrated tag cleaning and normalization via `genai-tag-db-tools`

### üîÑ In Progress
- **Legacy Code Cleanup**: Removing old `src/` implementations
- **GUI Integration**: Connecting new services to existing UI components
- **Documentation**: Updating all documentation to reflect current architecture

### ‚ö†Ô∏è Pending Items
- **Legacy File Removal**: Clean up redundant code in old `src/` structure
- **Test Suite Updates**: Update tests for new architecture
- **Migration Guide**: Document transition from old to new structure

## Development Commands

### Environment Setup
```bash
uv sync --dev                  # Install dependencies
uv add package-name           # Add dependency
uv add --dev package-name     # Add dev dependency
```

### Running Application
```bash
lorairo                       # Main command
python -m lorairo.main       # Alternative execution
```

### Testing
```bash
pytest                        # All tests
pytest -m unit               # Unit tests only
pytest -m integration        # Integration tests
pytest -m gui                # GUI tests
pytest --cov=src --cov-report=html  # With coverage
```

### Code Quality
```bash
ruff check                    # Linting
ruff format                   # Code formatting
mypy src/                     # Type checking
```

### Database Operations
```bash
alembic upgrade head          # Apply migrations
```
