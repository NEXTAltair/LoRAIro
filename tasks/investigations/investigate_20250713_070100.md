# AutoCrop アルゴリズム機能不全調査報告

**調査日時:** 2025/07/13 07:01  
**調査者:** Claude Code  
**ブランチ:** feature/investigate-autocrop-algorithm-failure  
**問題:** 実際の画像をクロップすると全く使い物にならないアルゴリズムであることが判明した  

## 📊 Executive Summary

AutoCropアルゴリズムが実画像で機能不全を起こしている根本原因を特定。設計前提と実際の画像特性の乖離が主因。クロップ率0.001-0.003という極小値は、アルゴリズムが正常に境界検出を行えていないことを示す。

## 🔍 調査結果

### 1. 現状分析

**テスト結果:**
- image_0001.png (2840x2160): クロップ率 0.001 (ほぼ全体が背景判定)
- image_0006.png (1280x720): クロップ率 0.002-0.003 (ほぼ全体が背景判定)

**実画像特性:**
- image_0001.png: 上下に黒いレターボックス帯がある画像
- image_0006.png: 暗いゲーム画面（境界のないコンテンツ）

### 2. Git履歴分析

**関連コミット:**
- `fb53d10`: auto_crop_image_with_letterbox関数の追加（2024/09/22）
- `d850f15`: 詳細エラーロギング追加
- `a7f145c`: PyTorch遅延読み込み最適化

**変更パターン:**
- 過去からレターボックス対応が意図されていた
- しかし実装は補色差分ベースのコンテンツ検出

### 3. コードベース分析

**現在のAutoCropアルゴリズム** (`src/lorairo/editor/image_processor.py:381-458`):

```python
# 問題のある実装部分
complementary_color = [255 - np.mean(np_image[..., i]) for i in range(3)]  # ← 補色計算
background = np.full(np_image.shape, complementary_color, dtype=np.uint8)  # ← 仮想背景作成
diff = cv2.absdiff(np_image, background)  # ← 差分計算
```

**根本的な設計問題:**
1. **補色差分検出**: 画像平均色の補色を「想定背景」として使用
2. **実背景無視**: 実際の画像背景（白、黒、透明等）を考慮しない
3. **境界検出の前提**: 明確な色彩境界の存在を仮定

### 4. 問題特定

#### 設計前提と実際の乖離

| 設計前提 | 実際の画像 | 結果 |
|---------|-----------|------|
| 補色背景との差分でコンテンツ検出 | レターボックス（黒帯除去が目的） | 補色（明るい色）では黒帯を適切に検出できない |
| 明確な色彩境界の存在 | 境界のない暗いコンテンツ | 差分ベースでは全体が検出対象になる |
| 平均色ベースの背景推定 | 多様な背景色・パターン | 実際の背景色と一致しない |

#### 失敗パターン分析

**パターン1: レターボックス画像**
- **期待**: 上下の黒帯を除去
- **実際**: 暗い画像の補色（明るい色）との差分で、画像全体が検出対象に
- **結果**: 極小クロップ率（0.001）

**パターン2: 境界のない画像** 
- **期待**: 適切なコンテンツ境界の検出
- **実際**: 全体がコンテンツのため、差分では境界を特定できない
- **結果**: 極小クロップ率（0.002-0.003）

### 5. 技術的考慮事項

#### アーキテクチャ的問題
- **単一アルゴリズム依存**: 1つの手法に依存し、画像タイプ別の適応がない
- **パラメータ最適化の限界**: 根本的な手法の問題はパラメータ調整では解決不可
- **エラーハンドリング不足**: 検出失敗時のフォールバック機能がない

#### パフォーマンス影響
- **処理時間**: 現在のアルゴリズムは計算コストが高い（複数の画像処理ステップ）
- **メモリ使用量**: 画像サイズと同じサイズの仮想背景画像を作成
- **スケーラビリティ**: 大きな画像では更に性能が悪化

#### セキュリティ・品質
- **データ損失リスク**: 誤った境界検出により重要なコンテンツを除去する可能性
- **一貫性の欠如**: 画像タイプにより結果が大きく変動
- **予測不可能性**: ユーザーが期待する結果と実際の結果の乖離

### 6. 代替手法の検討

#### 1. 複数手法の組み合わせ
```python
# 疑似コード例
def intelligent_autocrop(image):
    # 1. エッジベース境界検出
    if has_clear_borders(image):
        return edge_based_crop(image)
    
    # 2. 色彩均一性による背景検出
    if has_uniform_background(image):
        return background_removal_crop(image)
    
    # 3. レターボックス特化検出
    if is_letterbox_format(image):
        return letterbox_crop(image)
    
    # 4. フォールバック: 元画像返却
    return image
```

#### 2. 機械学習ベースの境界検出
- **セマンティックセグメンテーション**: 背景/前景の精密な分離
- **物体検出**: 主要オブジェクトの境界ボックス抽出
- **既存モデル活用**: SAM (Segment Anything Model) 等の利用

#### 3. ルールベースの特化手法
- **レターボックス検出**: 上下/左右の暗い帯の統計的検出
- **白背景除去**: 実際の白色領域の境界検出
- **透明背景対応**: アルファチャンネル活用

### 7. 影響範囲

#### 直接的影響
- **ImageProcessingManager**: AutoCrop機能が無効化状態
- **ユーザーワークフロー**: 手動クロップが必要
- **品質評価**: 不正確な処理による品質低下

#### 間接的影響
- **ユーザビリティ**: 自動化の恩恵を受けられない
- **処理効率**: 手動作業の増加
- **システム信頼性**: 自動機能への不信

### 8. 次ステップ

#### 緊急対応 (高優先度)
1. **AutoCrop機能の一時無効化**: 誤った結果を防ぐ
2. **フォールバック実装**: 元画像をそのまま返す安全な動作
3. **ユーザー通知**: AutoCrop機能の制限事項を明示

#### 短期対応 (中優先度)
1. **レターボックス特化アルゴリズム**: 黒帯検出に特化した手法
2. **背景色検出改善**: 実際の背景色を推定する手法
3. **複数手法の並行実装**: 画像タイプ別の適応的処理

#### 長期対応 (低優先度)
1. **ML-basedソリューション**: セマンティックセグメンテーションの導入
2. **ユーザー設定オプション**: 手動でのクロップ方式選択
3. **プレビュー機能**: クロップ結果の事前確認

## 🏁 結論

現在のAutoCropアルゴリズムは設計段階で実画像の特性を適切に考慮しておらず、実用性に欠ける。根本的な手法の見直しが必要であり、パラメータ調整のみでは解決不可能。

**推奨アクション:**
1. 機能の一時無効化による安全性確保
2. 画像タイプ別の特化手法の段階的実装
3. 長期的にはML-basedソリューションの検討

**次コマンド:** `@plan AutoCrop機能の根本的改善戦略`

---

**調査完了時刻:** 2025/07/13 07:01  
**関連ファイル:** 
- `src/lorairo/editor/image_processor.py` (AutoCropクラス)
- `scripts/test_autocrop_effectiveness.py` (効果検証スクリプト)
- `autocrop_test_results/` (テスト結果画像)