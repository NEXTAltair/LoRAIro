# LoRAIro GUI完全刷新 実装計画書

**策定日時**: 2025年7月17日  
**計画ブランチ**: `feature/investigate-gui-usability-20250717_031851`  
**対象**: LoRAIro アプリケーションGUI抜本的見直し  
**実装方針**: 完全刷新アプローチ (Qt Designer継続使用)

## 計画概要

### 問題定義
investigateフェーズで特定された問題:
1. **ワークフロー vs 画面構造の不一致** - 実際の使用パターンと7ページ構造の乖離
2. **状態管理分散** - 各Widget独自のデータ管理による状態不整合  
3. **レスポンシブ動作の問題** - リサイズ時の一貫性ない動作
4. **ページ間移動の煩雑さ** - データセット概要中心のワークフローが実現できない

### 成功基準
- **ワークフロー効率化**: データセット選択→検索→確認→エクスポートが1画面で完結
- **レスポンシブ改善**: ウィンドウリサイズ時の自然な動作
- **状態一貫性**: 全Widget間での状態同期確保
- **既存機能保持**: 全ての既存機能の互換性維持

---

## 推奨ソリューション: ワークフロー中心完全刷新

### アーキテクチャ設計

#### 新しいレイアウト構成
```
MainWorkspaceWindow (新設計)
├── DatasetSelector (継続使用)
├── WorkflowNavigator (新規) - 進捗・ステップ表示
└── MainWorkArea (新規) - 3分割レスポンシブレイアウト
    ├── FilterSearchPanel (左) - 統合検索・フィルター
    ├── ThumbnailGrid (中央) - メイン作業エリア
    ├── PreviewDetailPanel (右) - プレビュー・編集・詳細
    └── ActionToolbar (下) - エクスポート・設定・ステータス
```

#### 中央状態管理システム
```python
class DatasetStateManager(QObject):
    # 全Widget間で共有される単一状態
    dataset_changed = Signal(str)
    images_filtered = Signal(list) 
    selection_changed = Signal(list)
    current_image_changed = Signal(int)
    
    # ワークフローステップ管理
    workflow_step_changed = Signal(str)
```

#### 既存Widget再利用戦略
- **再利用**: `ThumbnailSelectorWidget`, `ImagePreviewWidget`, `DirectoryPickerWidget`
- **統合**: `TagFilterWidget` → `FilterSearchPanel`
- **簡略化**: `DatasetExportWidget` → `ActionToolbar`
- **廃止**: 独立ページ (`ImageEditWidget`, `ImageTaggerWidget` 等)

---

## 詳細実装計画

### Phase 1: 基盤リファクタリング (2-3週間)

#### Week 1-2: 状態管理基盤
**新規ファイル**:
- `src/lorairo/gui/state/dataset_state.py` - 中央状態管理
- `src/lorairo/gui/state/workflow_state.py` - ワークフロー管理

**主要タスク**:
1. `DatasetStateManager` 実装 (3-4日)
2. 既存Widget状態管理依存への変更 (4-5日)
3. 基本テスト実装 (2-3日)

#### Week 3: 基本Widget最適化
**修正ファイル**:
- `src/lorairo/gui/widgets/thumbnail.py` - 状態管理統合
- `src/lorairo/gui/widgets/image_preview.py` - 状態管理統合

**レスポンシブ動作統一**:
```python
# 統一的なレスポンシブWidget基底クラス
class ResponsiveWidget(QWidget):
    def resizeEvent(self, event):
        super().resizeEvent(event)
        self.adjust_layout_for_size(event.size())
```

### Phase 2: 新コンポーネント実装 (3-4週間)

#### Week 4-5: コアコンポーネント
**新規UIファイル (Qt Designer)**:
- `MainWorkspaceWindow.ui` - メインワークスペース
- `WorkflowNavigatorWidget.ui` - ワークフロー表示
- `FilterSearchPanel.ui` - 統合検索パネル

**新規Pythonクラス**:
- `MainWorkspaceWindow` - 全体統括
- `WorkflowNavigatorWidget` - ステップ表示・ナビゲーション
- `FilterSearchPanel` - 検索・フィルター統合

#### Week 6-7: 統合パネル実装
**新規ファイル**:
- `PreviewDetailPanel.ui` / `.py` - プレビュー・詳細・編集統合
- `ActionToolbar.ui` / `.py` - アクション・ステータス統合

**統合機能**:
- 既存プレビュー機能
- インライン編集 (Tagger機能統合)
- メタデータ表示 (Overview機能統合)
- エクスポート (Export機能統合)

### Phase 3: 統合・最適化 (2-3週間)

#### Week 8-9: 全体統合
**メイン統合作業**:
- `MainWorkspaceWindow` 完全実装
- 全コンポーネント統合・連携テスト
- レスポンシブ動作最終調整

**パフォーマンス最適化**:
- 大量画像対応 (1000+ 枚)
- メモリ使用量最適化
- UI応答性改善

#### Week 10: データ移行・互換性
**互換性確保**:
- 既存設定ファイル対応
- 既存データベース互換性
- 段階的移行機能

### Phase 4: テスト・完成化 (1-2週間)

#### Week 11-12: 包括的テスト
**テスト実装**:
```bash
# 単体テスト
UV_PROJECT_ENVIRONMENT=.venv_linux uv run pytest -m unit tests/unit/gui/

# 統合テスト  
UV_PROJECT_ENVIRONMENT=.venv_linux uv run pytest -m integration tests/integration/gui/

# GUIテスト (ヘッドレス)
UV_PROJECT_ENVIRONMENT=.venv_linux uv run pytest -m gui tests/gui/
```

**品質保証**:
- 全テストスイート成功率 100%
- カバレッジ 80% 以上
- パフォーマンス基準値維持
- ユーザビリティテスト

---

## リスク管理・対策

### 高リスク項目

#### 1. 状態管理複雑性
**リスク**: Widget間状態同期の複雑性による不具合
**対策**: 
- 段階的Widget移行 (一度に全部変更しない)
- 包括的状態テスト (状態不整合検出)
- フォールバック機能 (既存状態管理への復帰)

#### 2. 既存機能回帰
**リスク**: 既存機能の予期しない動作変更
**対策**:
- 回帰テストスイート強化
- 既存API互換性維持
- 段階的機能移行

#### 3. パフォーマンス劣化  
**リスク**: 新アーキテクチャによる性能低下
**対策**:
- パフォーマンス基準値設定・監視
- メモリプロファイリング
- 最適化専用期間設定

### 中リスク項目

#### Qt Designer統合課題
**対策**: 
- カスタムWidget登録スクリプト
- デザイナープラグイン文書化
- 標準Widget代替手順

#### 開発スケジュール遅延
**対策**:
- 週次進捗レビュー
- クリティカルパス監視
- 機能優先度調整余地

---

## 品質保証計画

### テスト戦略

#### 段階別テスト
| Phase | テスト種別 | 目標 | 実行 |
|-------|-----------|------|------|
| Phase 1 | 単体テスト | カバレッジ 80%+ | 毎コミット |
| Phase 2 | 統合テスト | 機能間連携確認 | 毎週 |
| Phase 3 | GUIテスト | ワークフロー動作確認 | 隔週 |
| Phase 4 | 総合テスト | 全機能・性能確認 | リリース前 |

#### パフォーマンス基準
| 項目 | 現在 | 目標 | 上限 |
|------|------|------|------|
| 起動時間 | 3秒 | 3秒 | 5秒 |
| サムネイル表示 | 1秒 | 1秒 | 2秒 |
| フィルター応答 | 200ms | 200ms | 500ms |
| メモリ使用量 | 1.5GB | 1.5GB | 2GB |

### 継続的品質監視
- 自動テスト実行 (CI/CD)
- パフォーマンストレンド監視
- ユーザビリティメトリクス

---

## 実装スケジュール・マイルストーン

### 全体スケジュール
```
Phase 1: 基盤リファクタリング    [Week 1-3]   ████████░░░░
Phase 2: 新コンポーネント実装   [Week 4-7]   ░░░░████████
Phase 3: 統合・最適化          [Week 8-10]  ░░░░░░░░████
Phase 4: テスト・完成化        [Week 11-12] ░░░░░░░░░░██
```

### 主要マイルストーン
- **M1 (Week 3)**: 状態管理基盤完成・既存Widget統合
- **M2 (Week 7)**: 新UI完全実装・基本動作確認
- **M3 (Week 10)**: 統合完了・パフォーマンス目標達成
- **M4 (Week 12)**: 品質保証完了・リリース準備

### クリティカルパス
```
状態管理基盤 → Widget統合 → メイン画面実装 → 全体統合 → テスト
```

---

## 成果物・デリバリー

### 技術成果物
1. **新GUIアーキテクチャ**: ワークフロー中心設計の実装
2. **状態管理システム**: Widget間統一状態管理
3. **レスポンシブレイアウト**: 一貫したリサイズ動作
4. **テストスイート**: 包括的品質保証テスト

### ドキュメント
1. **アーキテクチャ更新**: 新設計の文書化
2. **ユーザーガイド**: 新UI操作方法
3. **開発者ガイド**: Widget開発・カスタマイズ方法
4. **移行ガイド**: 旧UIからの移行手順

### 品質指標
- **ユーザビリティ**: ワークフロー効率化 (測定予定)
- **安定性**: クラッシュ率 <0.1%
- **性能**: 既存性能水準維持
- **保守性**: コード複雑度削減

---

## 次ステップ・引き継ぎ事項

### Implementフェーズ準備
1. **開発環境準備**: 必要ツール・ライブラリ確認
2. **タスク詳細化**: 各Phaseの日次タスク分割
3. **チーム体制**: 開発・テスト・レビュー役割分担

### 承認事項
- [ ] アーキテクチャ設計承認
- [ ] 実装スケジュール承認
- [ ] リスク対策承認
- [ ] 品質基準承認

### 実装開始条件
- [ ] 現在進行中の機能開発完了
- [ ] 開発環境準備完了
- [ ] バックアップ・ロールバック手順確認
- [ ] ステークホルダー承認取得

---

## 付録

### 参考情報
- **Investigation Report**: `tasks/investigations/investigate_20250717_043019.md`
- **Current Architecture**: `docs/architecture.md`
- **Development Rules**: `.cursor/rules/plan.mdc`

### 関連コミット・ブランチ
- **調査ブランチ**: `feature/investigate-gui-usability-20250717_031851`
- **ベースコミット**: `ee9d0c0`

---

**📋 プランニング完了通知**: LoRAIro GUI完全刷新の詳細実装計画が策定されました。

**📊 作成ファイル**: `/workspaces/LoRAIro/tasks/plans/plan_20250717_044752.md`

**🚀 次フェーズ**: `@implement` コマンドで実装開始準備