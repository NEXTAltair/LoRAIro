# アプリケーション層ワーカー 仕様書

version: "1.0.0"

## 1. 目的

本仕様書は、`lorairo` アプリケーションのサービス層 (`src/lorairo/services`) における非同期処理を担当するワーカークラス群の設計と実装に関する仕様を定義します。

主な目的は以下の通りです。

- UIスレッドをブロックすることなく、時間のかかるタスク（ファイルI/O、ネットワーク通信、重い計算処理など）を実行する。
- 各非同期タスクの責務を明確にし、コードのモジュール性と保守性を向上させる。
- 非同期処理の共通パターンを提供し、開発効率を高める。

## 2. 基本設計

- **基底クラス:** 全てのアプリケーション層ワーカーは、`src.lorairo.services.base_worker.BaseWorker` クラスを継承します。
- **`BaseWorker` の役割:**
    - `QObject` を継承し、PySide6 のシグナル/スロット機構およびスレッド親和性を提供します。
    - 共通のシグナル (`finished(result: object)`, `progress(percentage: int)`) を定義します。
    - 基本的なキャンセル処理 (`cancel()` メソッド、`_is_cancelled` フラグ) の枠組みを提供します。
    - スレッドプールまたは個別の `QThread` 上で実行されるエントリーポイント (`run()` メソッド) を提供します。`run()` はキャンセルチェック、抽象メソッド `run_task()` の呼び出し、例外処理、`finished` シグナルの発行を行います。
- **サブクラスの役割:**
    - `BaseWorker` を継承し、具体的な非同期タスクを `run_task()` メソッド内に実装します。
    - 必要に応じて `progress` シグナルを発行します。
    - 必要に応じて `cancel()` メソッドをオーバーライドし、タスク固有のキャンセルロジックを追加します（例: 実行中プロセスの停止、ループの中断）。オーバーライドする場合は `super().cancel()` を呼び出す必要があります。
- **サービスとの連携:**
    - 各サービスクラス（例: `AnnotationService`）は、対応するワーカークラス（例: `AnnotationWorker`）のインスタンスを生成します。
    - サービスは `QThread` を作成し、ワーカーをそのスレッドに移動 (`moveToThread`) します。
    - スレッドの `started` シグナルをワーカーの `run` スロットに接続します。
    - ワーカーの `finished` および `progress` シグナルを、サービス内の適切なスロット（またはUIコンポーネントのスロット）に接続して、結果や進捗を処理します。
    - サービスはワーカーの `cancel()` メソッドを呼び出して、タスクの中断を要求できます。

## 3. 責務

- **タスク実行:** 割り当てられた特定の非同期タスク（AI アノテーション、画像読み込み、設定の保存など）を実行します。
- **結果通知:** タスク完了時、`finished` シグナルを通じて結果オブジェクトまたは発生した例外をサービスに通知します。
- **進捗通知:** (任意) タスク実行中に、`progress` シグナルを通じて進捗状況（通常 0-100 のパーセンテージ）を通知します。
- **キャンセル処理:** サービスからのキャンセル要求を受け付け、可能な範囲でタスクを安全に中断します。中断した場合も `finished` シグナルは発行されます（結果は `None` や特定のキャンセル状態を示すオブジェクトになる場合があります）。

## 4. 実装ガイドライン

- **`run_task()` の実装:**
    - 具体的な処理ロジックを実装します。
    - 正常完了時は結果オブジェクトを返します。
    - 処理中にエラーが発生した場合は、例外を送出します (`BaseWorker.run` で捕捉されます)。特定のビジネスロジックエラーは、`run_task` 内で捕捉し、エラーを示す特定のオブジェクトを返すことも可能です。
- **エラーハンドリング:**
    - `BaseWorker.run()` が一般的な `Exception` を捕捉し、`finished` シグナルで通知します。
    - `run_task()` 内で、特定の予期される例外（例: `FileNotFoundError`, `ValueError`）を捕捉し、より具体的なエラー情報を含む結果を返すことも検討します。
- **状態管理:** ワーカーは自身の状態（実行中、キャンセル済みなど）を管理しますが、サービスやUIに直接依存しないようにします。状態の通知はシグナルを使用します。
- **リソース管理:** ワーカーがファイルハンドルやネットワーク接続などのリソースを使用する場合、`run_task()` 内または `finally` ブロックで適切に解放するようにします。
- **UI非依存:** ワーカークラスはUIコンポーネントに直接アクセスしません。UIとのやり取りは、サービス層を経由してシグナル/スロットで行います。

## 5. 命名規則

- ワーカークラス名は、対応するサービス名に基づいて `[ServiceName]Worker` とします (例: `AnnotationWorker`, `ImageLoadingWorker`)。

## 6. 改訂履歴

- 1.0.0 (2025-04-18): 初版作成
