# データベース管理機能 仕様書 (SQLAlchemyベース)

## 1. 概要

本ドキュメントは、`lorairo` における画像メタデータ、アノテーション（タグ、キャプション、スコア、**レーティング**）、モデル情報、処理ステータス等を管理するためのデータベース機能の仕様を定義する。標準 `sqlite3` から SQLAlchemy ORM へ移行し、コードの可読性、保守性、および `genai-tag-db-tools` との技術的整合性を向上させる。また、画像レーティング機能と手動編集情報の管理に対応する。

## 2. 技術選定

-   **データベース:** SQLite
-   **ORM:** SQLAlchemy (Core API および ORM を使用)
-   **マイグレーション:** Alembic (導入決定)

## 3. データベーススキーマ (SQLAlchemy モデル定義)

`docs/Plan/database_schema_plan.md` に基づく最終スキーマ案。

```mermaid
erDiagram
    images ||--o{ processed_images : "has processed"
    images ||--o{ tags : "has"
    images ||--o{ captions : "has"
    images ||--o{ scores : "has score"
    images ||--o{ ratings : "has rating"

    models ||--o{ tags : "generated by"
    models ||--o{ captions : "generated by"
    models ||--o{ scores : "generated by"
    models ||--o{ ratings : "generated by"

    # tag_db.TAGS は外部DBのため直接のリレーションは定義しないが概念的に示す
    # TAGS }o..|| TAG_DB.TAGS : "references (optional)"

    images {
        int id PK
        string uuid UK "UNIQUE NOT NULL"
        string phash "Nullable"
        string original_image_path "NOT NULL"
        string stored_image_path "NOT NULL"
        int width "NOT NULL"
        int height "NOT NULL"
        string format "NOT NULL"
        string mode "Nullable"
        bool has_alpha "Nullable"
        string filename "Nullable"
        string extension "NOT NULL"
        string color_space "Nullable"
        string icc_profile "Nullable"
        string manual_rating "TEXT, Nullable (Civitai基準)"
        timestamp created_at
        timestamp updated_at
    }

    processed_images {
        int id PK
        int image_id FK "NOT NULL"
        string stored_image_path "NOT NULL"
        int width "NOT NULL"
        int height "NOT NULL"
        string mode "Nullable"
        bool has_alpha "NOT NULL"
        string filename "Nullable"
        string color_space "Nullable"
        string icc_profile "Nullable"
        timestamp created_at
        timestamp updated_at
    }

    models {
        int id PK
        string name UK "UNIQUE NOT NULL"
        string type "NOT NULL"
        string provider "Nullable"
        timestamp created_at
        timestamp updated_at
    }

    tags {
        int id PK
        int tag_id "Nullable, conceptually references tag_db.TAGS.tag_id (No FK Constraint)" // FK制約なし
        int image_id FK "Nullable"
        int model_id FK "Nullable"
        string tag "NOT NULL"
        bool existing "NOT NULL DEFAULT 0, 元ファイル由来か"
        bool is_edited_manually "BOOLEAN, DEFAULT 0, NOT NULL"
        float confidence_score "REAL, Nullable"
        timestamp created_at
        timestamp updated_at
    }

    captions {
        int id PK
        int image_id FK "Nullable"
        int model_id FK "Nullable"
        string caption "NOT NULL"
        bool existing "NOT NULL DEFAULT 0, 元ファイル由来か"
        bool is_edited_manually "BOOLEAN, DEFAULT 0, NOT NULL"
        timestamp created_at
        timestamp updated_at
    }

    scores {
        int id PK
        int image_id FK "Nullable"
        int model_id FK "Nullable"
        float score "NOT NULL"
        bool is_edited_manually "BOOLEAN, DEFAULT 0, NOT NULL"
        timestamp created_at
        timestamp updated_at
    }

    ratings {
        int id PK
        int image_id FK "NOT NULL"
        int model_id FK "NOT NULL"
        string raw_rating_value "TEXT"
        string normalized_rating "TEXT (Civitai基準)"
        float confidence_score "REAL, Nullable"
        timestamp created_at
        timestamp updated_at
    }

```

*(ここに各テーブルに対応する SQLAlchemy モデルクラスの定義を記述)*
-   `Image` モデル ( `manual_rating` 追加)
-   `ProcessedImage` モデル
-   `Model` モデル
-   `Tag` モデル ( `is_edited_manually`, `confidence_score` 追加, `tag_id` は FK 制約なし)
-   `Caption` モデル ( `is_edited_manually` 追加)
-   `Score` モデル ( `is_edited_manually` 追加)
-   `Rating` モデル (**新規追加**)

*(リレーションシップ (`relationship`) も定義)*

## 4. データアクセス (Repository パターン)

`ImageRepository` クラス (SQLAlchemyベースに改修) がデータベース操作を担当する。

### 4.1. 主要なメソッド (想定)

-   `add_original_image(info: dict)`: オリジナル画像情報を登録 ( `manual_rating` も考慮)。
-   `add_processed_image(info: dict)`: 処理済み画像情報を登録。
-   `save_annotations(image_id: int, annotations: dict)`: タグ、キャプション、スコア、**レーティング**を一括保存/更新。
    -   **タグ保存時の処理:**
        1.  各タグについて `genai-tag-db-tools` を使用して `tag_db` 内の `tag_id` を検索。
        2.  **存在しない場合:** `genai-tag-db-tools` の機能で新しいタグを `tag_db` に登録し、新しい `tag_id` を取得。**(新規要件)**
        3.  取得した `tag_id` (または存在しない場合は `None`) と共に、`lorairo` の `TAGS` テーブルにタグ情報 (手動編集フラグ、確信度スコア含む) を保存/更新。
    -   キャプション、スコア、レーティングの保存処理 (手動編集フラグも考慮)。
-   `update_manual_rating(image_id: int, rating: str)`: 手動レーティングを更新。
-   `update_annotation_manual_edit_flag(annotation_type: str, annotation_id: int, is_edited: bool)`: 各アノテーションの手動編集フラグを更新。
-   `get_image_metadata(image_id: int)`: 画像メタデータを取得 ( `manual_rating` 含む)。
-   `get_processed_metadata(image_id: int, resolution: int = 0, all_data: bool = False)`: 処理済み画像メタデータを取得。
-   `get_image_annotations(image_id: int)`: 画像のアノテーションを取得 (手動編集フラグ、確信度スコア、レーティング含む)。
-   `get_models(model_type: Optional[str] = None)`: モデル情報を取得。
-   `find_duplicate_image(phash: str)`: pHash で重複画像を検索。
-   `get_image_id_by_name(image_name: str)`: ファイル名で画像IDを検索。
-   `get_images_by_filter(...)`: タグ、キャプション、日付、**レーティング**等で画像を検索 (手動編集フラグでのフィルタも考慮)。
-   `delete_image(image_id: int)`: 画像と関連データを削除。
-   (その他必要なメソッド)

### 4.2. セッション管理

-   `SessionLocal` ファクトリパターンを使用し、各操作でセッションを生成・クローズする。
-   スレッドセーフティのため `threading.local` または SQLAlchemy の `scoped_session` を検討。

## 5. データベース初期化・マイグレーション

-   初回起動時およびスキーマ変更時は **Alembic** を使用してデータベーススキーマを管理・適用する。(導入決定)
-   `models` テーブルに初期データを投入する処理は、Alembic のマイグレーションスクリプト内、またはアプリケーション初期化処理の一部として実装する。

---