# 画像データベース スキーマ変更計画

## 1. 概要

画像レーティング機能の追加、およびタグ、キャプション、スコアの手動編集情報を区別して保存可能にするためのスキーマ変更計画。

## 2. 変更点

### 2.1. `ratings` テーブルの新規作成

*   **目的:** AI モデルによるレーティング結果（生データとCivitai基準の統一データ、確信度スコア）を保存。
*   **カラム:**
    *   `id` (INTEGER PRIMARY KEY)
    *   `image_id` (INTEGER, FOREIGN KEY references images(id) ON DELETE CASCADE, NOT NULL)
    *   `model_id` (INTEGER, FOREIGN KEY references models(id) ON DELETE SET NULL, NOT NULL)
    *   `raw_rating_value` (TEXT): モデルが出力した生のレーティング値。
    *   `normalized_rating` (TEXT): Civitai 基準 ('PG', 'PG-13', 'R', 'X', 'XXX') に変換した値。
    *   `confidence_score` (REAL, Nullable): AI モデルが判定したレーティングに対する確信度スコア。
    *   `created_at` (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)
    *   `updated_at` (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)
*   **制約:** `UNIQUE (image_id, model_id)`

### 2.2. `images` テーブルへのカラム追加

*   **目的:** 手動評価（Civitai基準）を保存。
*   **追加カラム:** `manual_rating` (TEXT, Nullable)

### 2.3. `tags` テーブルへのカラム追加

*   **目的:** 手動編集フラグと確信度スコアを保存。
*   **追加カラム:**
    *   `is_edited_manually` (BOOLEAN, DEFAULT 0, NOT NULL)
    *   `confidence_score` (REAL, Nullable)

### 2.4. `captions` テーブルへのカラム追加

*   **目的:** 手動編集フラグを保存。
*   **追加カラム:** `is_edited_manually` (BOOLEAN, DEFAULT 0, NOT NULL)

### 2.5. `scores` テーブルへのカラム追加

*   **目的:** 手動編集フラグを保存。
*   **追加カラム:** `is_edited_manually` (BOOLEAN, DEFAULT 0, NOT NULL)

## 3. 最終スキーマ（案）

```mermaid
erDiagram
    images ||--o{ processed_images : "has processed"
    images ||--o{ tags : "has"
    images ||--o{ captions : "has"
    images ||--o{ scores : "has score"
    images ||--o{ ratings : "has rating"

    models ||--o{ tags : "generated by"
    models ||--o{ captions : "generated by"
    models ||--o{ scores : "generated by"
    models ||--o{ ratings : "generated by"

    images {
        int id PK
        string uuid UK "UNIQUE NOT NULL"
        string phash "Nullable"
        string original_image_path "NOT NULL"
        string stored_image_path "NOT NULL"
        int width "NOT NULL"
        int height "NOT NULL"
        string format "NOT NULL"
        string mode "Nullable"
        bool has_alpha "Nullable"
        string filename "Nullable"
        string extension "NOT NULL"
        string color_space "Nullable"
        string icc_profile "Nullable"
        string manual_rating "TEXT, Nullable (Civitai基準)"
        timestamp created_at
        timestamp updated_at
    }

    processed_images {
        int id PK
        int image_id FK "NOT NULL"
        string stored_image_path "NOT NULL"
        int width "NOT NULL"
        int height "NOT NULL"
        string mode "Nullable"
        bool has_alpha "NOT NULL"
        string filename "Nullable"
        string color_space "Nullable"
        string icc_profile "Nullable"
        timestamp created_at
        timestamp updated_at
    }

    models {
        int id PK
        string name UK "UNIQUE NOT NULL"
        string type "NOT NULL"
        string provider "Nullable"
        timestamp created_at
        timestamp updated_at
    }

    tags {
        int id PK
        int tag_id "Nullable, conceptually FK to tag_db.TAGS"
        int image_id FK "Nullable"
        int model_id FK "Nullable"
        string tag "NOT NULL"
        bool existing "NOT NULL DEFAULT 0"
        bool is_edited_manually "BOOLEAN, DEFAULT 0, NOT NULL"
        float confidence_score "REAL, Nullable"
        timestamp created_at
        timestamp updated_at
    }

    captions {
        int id PK
        int image_id FK "Nullable"
        int model_id FK "Nullable"
        string caption "NOT NULL"
        bool existing "NOT NULL DEFAULT 0"
        bool is_edited_manually "BOOLEAN, DEFAULT 0, NOT NULL"
        timestamp created_at
        timestamp updated_at
    }

    scores {
        int id PK
        int image_id FK "Nullable"
        int model_id FK "Nullable"
        float score "NOT NULL"
        bool is_edited_manually "BOOLEAN, DEFAULT 0, NOT NULL"
        timestamp created_at
        timestamp updated_at
    }

    ratings {
        int id PK
        int image_id FK "NOT NULL"
        int model_id FK "NOT NULL"
        string raw_rating_value "TEXT"
        string normalized_rating "TEXT (Civitai基準)"
        float confidence_score "REAL, Nullable"
        timestamp created_at
        timestamp updated_at
    }

```

## 4. 実装ステップ

1.  **スキーマ変更:** `src/lorairo/database/database.py` の `create_tables` メソッドを修正。
2.  **データアクセス層の修正:** `ImageRepository` クラスのメソッドを修正・追加。
3.  **ビジネスロジック層の修正:** `ImageDatabaseManager` クラスなどのロジックを修正。
4.  **UI/API 層の修正:** GUI や API を修正。