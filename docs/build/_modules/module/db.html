<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>module.db &#8212; lora_dataset_toolsy 1.01 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=c058f7c8" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=e77f40a7"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=91613774"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>module.db のソースコード</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">imagehash</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">module.log</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">module.file_sys</span> <span class="kn">import</span> <span class="n">FileSystemManager</span>

<div class="viewcode-block" id="calculate_phash">
<a class="viewcode-back" href="../../module.db.html#module.db.calculate_phash">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">calculate_phash</span><span class="p">(</span><span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">imagehash</span><span class="o">.</span><span class="n">phash</span><span class="p">(</span><span class="n">img</span><span class="p">))</span></div>


<div class="viewcode-block" id="SQLiteManager">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">SQLiteManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_db_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">tag_db_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;SQLiteManager&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_db_path</span> <span class="o">=</span> <span class="n">img_db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_db_path</span> <span class="o">=</span> <span class="n">tag_db_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<div class="viewcode-block" id="SQLiteManager.dict_factory">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.dict_factory">[ドキュメント]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dict_factory</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span></div>


<div class="viewcode-block" id="SQLiteManager.connect">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.connect">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img_db_path</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ATTACH DATABASE &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tag_db_path</span><span class="si">}</span><span class="s2">&#39; AS tag_db&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = ON&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_factory</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span></div>


<div class="viewcode-block" id="SQLiteManager.close">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.close">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="s1">&#39;connection&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SQLiteManager.get_connection">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.get_connection">[ドキュメント]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">conn</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;データベース操作に失敗しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="SQLiteManager.execute">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.execute">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span></div>


<div class="viewcode-block" id="SQLiteManager.executemany">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.executemany">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">executemany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span></div>


<div class="viewcode-block" id="SQLiteManager.fetch_one">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.fetch_one">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">fetch_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span></div>


<div class="viewcode-block" id="SQLiteManager.fetch_all">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.fetch_all">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">fetch_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>


<div class="viewcode-block" id="SQLiteManager.create_tables">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.create_tables">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                -- images テーブル：オリジナル画像の情報を格納</span>
<span class="s1">                CREATE TABLE IF NOT EXISTS images (</span>
<span class="s1">                    id INTEGER PRIMARY KEY,</span>
<span class="s1">                    uuid TEXT UNIQUE NOT NULL,</span>
<span class="s1">                    phash TEXT,</span>
<span class="s1">                    stored_image_path TEXT NOT NULL,</span>
<span class="s1">                    width INTEGER NOT NULL,</span>
<span class="s1">                    height INTEGER NOT NULL,</span>
<span class="s1">                    format TEXT NOT NULL,</span>
<span class="s1">                    mode TEXT NULL,</span>
<span class="s1">                    has_alpha BOOLEAN,</span>
<span class="s1">                    filename TEXT NULL,</span>
<span class="s1">                    extension TEXT NOT NULL,</span>
<span class="s1">                    color_space TEXT,</span>
<span class="s1">                    icc_profile TEXT,</span>
<span class="s1">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    UNIQUE (uuid, phash)</span>
<span class="s1">                );</span>

<span class="s1">                -- processed_images テーブル：処理済み画像の情報を格納</span>
<span class="s1">                CREATE TABLE IF NOT EXISTS processed_images (</span>
<span class="s1">                    id INTEGER PRIMARY KEY,</span>
<span class="s1">                    image_id INTEGER NOT NULL,</span>
<span class="s1">                    stored_image_path TEXT NOT NULL,</span>
<span class="s1">                    width INTEGER NOT NULL,</span>
<span class="s1">                    height INTEGER NOT NULL,</span>
<span class="s1">                    mode TEXT NULL,</span>
<span class="s1">                    has_alpha BOOLEAN NOT NULL,</span>
<span class="s1">                    filename TEXT NULL,</span>
<span class="s1">                    color_space TEXT,</span>
<span class="s1">                    icc_profile TEXT,</span>
<span class="s1">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,</span>
<span class="s1">                    UNIQUE (image_id, width, height, filename)</span>
<span class="s1">                );</span>

<span class="s1">                -- models テーブル：モデル情報を格納</span>
<span class="s1">                CREATE TABLE IF NOT EXISTS models (</span>
<span class="s1">                    id INTEGER PRIMARY KEY,</span>
<span class="s1">                    name TEXT UNIQUE NOT NULL,</span>
<span class="s1">                    type TEXT NOT NULL,</span>
<span class="s1">                    provider TEXT,</span>
<span class="s1">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span>
<span class="s1">                );</span>

<span class="s1">                -- tags テーブル：画像に関連付けられたタグを格納</span>
<span class="s1">                CREATE TABLE IF NOT EXISTS tags (</span>
<span class="s1">                    id INTEGER PRIMARY KEY,</span>
<span class="s1">                    tag_id INTEGER,</span>
<span class="s1">                    image_id INTEGER,</span>
<span class="s1">                    model_id INTEGER,</span>
<span class="s1">                    tag TEXT NOT NULL,</span>
<span class="s1">                    existing BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="s1">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,</span>
<span class="s1">                    FOREIGN KEY (model_id) REFERENCES models(id) ON DELETE SET NULL,</span>
<span class="s1">                    UNIQUE (image_id, tag, tag_id, model_id)</span>
<span class="s1">                );</span>

<span class="s1">                -- captions テーブル：画像に関連付けられたキャプションを格納</span>
<span class="s1">                CREATE TABLE IF NOT EXISTS captions (</span>
<span class="s1">                    id INTEGER PRIMARY KEY,</span>
<span class="s1">                    image_id INTEGER,</span>
<span class="s1">                    model_id INTEGER,</span>
<span class="s1">                    caption TEXT NOT NULL,</span>
<span class="s1">                    existing BOOLEAN NOT NULL DEFAULT 0,</span>
<span class="s1">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,</span>
<span class="s1">                    FOREIGN KEY (model_id) REFERENCES models(id) ON DELETE SET NULL,</span>
<span class="s1">                    UNIQUE (image_id, caption, model_id)</span>
<span class="s1">                );</span>

<span class="s1">                -- scores テーブル：画像に関連付けられたスコアを格納</span>
<span class="s1">                CREATE TABLE IF NOT EXISTS scores (</span>
<span class="s1">                    id INTEGER PRIMARY KEY,</span>
<span class="s1">                    image_id INTEGER,</span>
<span class="s1">                    model_id INTEGER,</span>
<span class="s1">                    score FLOAT NOT NULL,</span>
<span class="s1">                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,</span>
<span class="s1">                    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,</span>
<span class="s1">                    FOREIGN KEY (model_id) REFERENCES models(id) ON DELETE SET NULL,</span>
<span class="s1">                    UNIQUE (image_id, score, model_id)</span>
<span class="s1">                );</span>

<span class="s1">            -- インデックスの作成</span>
<span class="s1">            CREATE INDEX IF NOT EXISTS idx_images_uuid ON images(uuid);</span>
<span class="s1">            CREATE INDEX IF NOT EXISTS idx_images_phash ON images(phash);</span>
<span class="s1">            CREATE INDEX IF NOT EXISTS idx_processed_images_image_id ON processed_images(image_id);</span>
<span class="s1">            CREATE INDEX IF NOT EXISTS idx_tags_image_id ON tags(image_id);</span>
<span class="s1">            CREATE INDEX IF NOT EXISTS idx_captions_image_id ON captions(image_id);</span>
<span class="s1">            CREATE INDEX IF NOT EXISTS idx_scores_image_id ON scores(image_id);</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="p">)</span></div>


    <span class="c1"># def migrate_tables(self):</span>
    <span class="c1">#     &quot;&quot;&quot;既存のテーブルに不足しているカラムを追加し、必要に応じてテーブルを再作成する&quot;&quot;&quot;</span>
    <span class="c1">#     with self.get_connection() as conn:</span>
    <span class="c1">#         cursor = conn.cursor()</span>
    <span class="c1">#         # テーブルごとの新しい定義</span>
    <span class="c1">#         table_definitions = {</span>
    <span class="c1">#             &#39;tags&#39;: [</span>
    <span class="c1">#                 (&#39;id&#39;, &#39;INTEGER PRIMARY KEY&#39;),</span>
    <span class="c1">#                 (&#39;tag_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;image_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;model_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;tag&#39;, &#39;TEXT NOT NULL&#39;),</span>
    <span class="c1">#                 (&#39;existing&#39;, &#39;BOOLEAN NOT NULL DEFAULT 0&#39;),</span>
    <span class="c1">#                 (&#39;created_at&#39;, &#39;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;),</span>
    <span class="c1">#                 (&#39;updated_at&#39;, &#39;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;),</span>
    <span class="c1">#                 (&#39;FOREIGN KEY(image_id)&#39;, &#39;REFERENCES images(id) ON DELETE CASCADE&#39;),</span>
    <span class="c1">#                 (&#39;FOREIGN KEY(model_id)&#39;, &#39;REFERENCES models(id) ON DELETE SET NULL&#39;),</span>
    <span class="c1">#                 (&#39;UNIQUE(image_id, tag, tag_id, model_id)&#39;, &#39;&#39;)</span>
    <span class="c1">#             ],</span>
    <span class="c1">#             # 他のテーブルも同様に定義</span>
    <span class="c1">#             &#39;captions&#39;: [</span>
    <span class="c1">#                 (&#39;id&#39;, &#39;INTEGER PRIMARY KEY&#39;),</span>
    <span class="c1">#                 (&#39;image_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;model_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;caption&#39;, &#39;TEXT NOT NULL&#39;),</span>
    <span class="c1">#                 (&#39;existing&#39;, &#39;BOOLEAN NOT NULL DEFAULT 0&#39;),</span>
    <span class="c1">#                 (&#39;created_at&#39;, &#39;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;),</span>
    <span class="c1">#                 (&#39;updated_at&#39;, &#39;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;),</span>
    <span class="c1">#                 (&#39;FOREIGN KEY(image_id)&#39;, &#39;REFERENCES images(id) ON DELETE CASCADE&#39;),</span>
    <span class="c1">#                 (&#39;FOREIGN KEY(model_id)&#39;, &#39;REFERENCES models(id) ON DELETE SET NULL&#39;),</span>
    <span class="c1">#                 (&#39;UNIQUE(image_id, caption, model_id)&#39;, &#39;&#39;)</span>
    <span class="c1">#             ],</span>
    <span class="c1">#             &#39;scores&#39;: [</span>
    <span class="c1">#                 (&#39;id&#39;, &#39;INTEGER PRIMARY KEY&#39;),</span>
    <span class="c1">#                 (&#39;image_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;model_id&#39;, &#39;INTEGER&#39;),</span>
    <span class="c1">#                 (&#39;score&#39;, &#39;FLOAT NOT NULL&#39;),</span>
    <span class="c1">#                 (&#39;created_at&#39;, &#39;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;),</span>
    <span class="c1">#                 (&#39;updated_at&#39;, &#39;TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#39;),</span>
    <span class="c1">#                 (&#39;FOREIGN KEY(image_id)&#39;, &#39;REFERENCES images(id) ON DELETE CASCADE&#39;),</span>
    <span class="c1">#                 (&#39;FOREIGN KEY(model_id)&#39;, &#39;REFERENCES models(id) ON DELETE SET NULL&#39;),</span>
    <span class="c1">#                 (&#39;UNIQUE(image_id, score, model_id)&#39;, &#39;&#39;)</span>
    <span class="c1">#             ]</span>
    <span class="c1">#         }</span>

    <span class="c1">#         for table_name, columns in table_definitions.items():</span>
    <span class="c1">#             # 既存テーブルのカラムを取得</span>
    <span class="c1">#             cursor.execute(f&quot;PRAGMA table_info({table_name});&quot;)</span>
    <span class="c1">#             existing_columns_info = cursor.fetchall()</span>
    <span class="c1">#             existing_column_names = {col[&#39;name&#39;] for col in existing_columns_info}</span>

    <span class="c1">#             # 必要なカラムがすべて存在するか確認</span>
    <span class="c1">#             required_columns = [col[0] for col in columns if not col[0].startswith(&#39;FOREIGN KEY&#39;) and not col[0].startswith(&#39;UNIQUE&#39;)]</span>
    <span class="c1">#             missing_columns = set(required_columns) - existing_column_names</span>

    <span class="c1">#             # カラムが不足している場合、テーブルを再作成</span>
    <span class="c1">#             if missing_columns or self.need_to_recreate_table(table_name, columns, existing_columns_info):</span>
    <span class="c1">#                 self.logger.info(f&quot;テーブル &#39;{table_name}&#39; を再作成します。&quot;)</span>
    <span class="c1">#                 self.recreate_table(conn, table_name, columns)</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 self.logger.info(f&quot;テーブル &#39;{table_name}&#39; は再作成の必要がありません。&quot;)</span>

    <span class="c1"># def need_to_recreate_table(self, table_name, columns, existing_columns_info):</span>
    <span class="c1">#     &quot;&quot;&quot;テーブルの再作成が必要かどうかを判断する&quot;&quot;&quot;</span>
    <span class="c1">#     # FOREIGN KEY や UNIQUE 制約の変更が必要かどうかをチェックする</span>
    <span class="c1">#     # この例では簡略化のため、常に False を返す</span>
    <span class="c1">#     # 必要に応じて実装を追加する</span>
    <span class="c1">#     return True  # 常に再作成する</span>

    <span class="c1"># def recreate_table(self, conn, table_name, columns):</span>
    <span class="c1">#     &quot;&quot;&quot;テーブルを再作成してデータを移行する&quot;&quot;&quot;</span>
    <span class="c1">#     cursor = conn.cursor()</span>

    <span class="c1">#     # 一時テーブル名を生成</span>
    <span class="c1">#     temp_table_name = f&quot;{table_name}_backup&quot;</span>

    <span class="c1">#     # テーブルをリネーム（バックアップ）</span>
    <span class="c1">#     cursor.execute(f&quot;ALTER TABLE {table_name} RENAME TO {temp_table_name};&quot;)</span>
    <span class="c1">#     self.logger.info(f&quot;テーブル &#39;{table_name}&#39; を &#39;{temp_table_name}&#39; にリネームしました。&quot;)</span>

    <span class="c1">#     # 新しいテーブルを作成</span>
    <span class="c1">#     columns_definitions = []</span>
    <span class="c1">#     for col_name, col_def in columns:</span>
    <span class="c1">#         if col_def:  # 制約や FOREIGN KEY も含む</span>
    <span class="c1">#             columns_definitions.append(f&quot;{col_name} {col_def}&quot;)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             columns_definitions.append(f&quot;{col_name}&quot;)</span>

    <span class="c1">#     create_table_sql = f&quot;CREATE TABLE {table_name} (\n&quot; + &quot;,\n&quot;.join(columns_definitions) + &quot;\n);&quot;</span>
    <span class="c1">#     cursor.execute(create_table_sql)</span>
    <span class="c1">#     self.logger.info(f&quot;テーブル &#39;{table_name}&#39; を新しい定義で作成しました。&quot;)</span>

    <span class="c1">#     # データを移行</span>
    <span class="c1">#     old_columns = [col[&#39;name&#39;] for col in cursor.execute(f&quot;PRAGMA table_info({temp_table_name});&quot;)]</span>
    <span class="c1">#     new_columns = [col[0] for col in columns if not col[0].startswith(&#39;FOREIGN KEY&#39;) and not col[0].startswith(&#39;UNIQUE&#39;)]</span>
    <span class="c1">#     common_columns = set(old_columns) &amp; set(new_columns)</span>
    <span class="c1">#     common_columns_str = &quot;, &quot;.join(common_columns)</span>

    <span class="c1">#     cursor.execute(f&quot;INSERT INTO {table_name} ({common_columns_str}) SELECT {common_columns_str} FROM {temp_table_name};&quot;)</span>
    <span class="c1">#     self.logger.info(f&quot;データを &#39;{temp_table_name}&#39; から &#39;{table_name}&#39; に移行しました。&quot;)</span>

    <span class="c1">#     # 一時テーブルを削除</span>
    <span class="c1">#     cursor.execute(f&quot;DROP TABLE {temp_table_name};&quot;)</span>
    <span class="c1">#     self.logger.info(f&quot;一時テーブル &#39;{temp_table_name}&#39; を削除しました。&quot;)</span>

    <span class="c1">#     conn.commit()</span>

<div class="viewcode-block" id="SQLiteManager.insert_models">
<a class="viewcode-back" href="../../module.db.html#module.db.SQLiteManager.insert_models">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">insert_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        モデル情報の初期設定をデータベースに追加</span>

<span class="sd">        Args:</span>
<span class="sd">            model_name (str): モデルの名前。</span>
<span class="sd">            model_type (str): モデルのタイプ。</span>
<span class="sd">            provider (str): モデルのプロバイダ。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT OR IGNORE INTO models (name, type, provider) VALUES (?, ?, ?)</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;gpt-4o&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenAI&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;gpt-4-turbo&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenAI&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;laion&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;cafe&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;gpt-4o-mini&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenAI&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;gemini-1.5-pro-exp-0801&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Google&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;gemini-1.5-pro-preview-0409&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Google&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;gemini-1.0-pro-vision&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Google&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;claude-3-5-sonnet-20240620&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Anthropic&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;claude-3-opus-20240229&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Anthropic&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;claude-3-sonnet-20240229&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Anthropic&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;claude-3-haiku-20240307&#39;</span><span class="p">,</span> <span class="s1">&#39;vision&#39;</span><span class="p">,</span> <span class="s1">&#39;Anthropic&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RealESRGAN_x4plus&#39;</span><span class="p">,</span> <span class="s1">&#39;upscaler&#39;</span><span class="p">,</span> <span class="s1">&#39;xinntao&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="ImageRepository">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">ImageRepository</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    画像関連のデータベース操作を担当するクラス。</span>
<span class="sd">    このクラスは、画像メタデータの保存、取得、アノテーションの管理などを行います。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_manager</span><span class="p">:</span> <span class="n">SQLiteManager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ImageRepositoryクラスのコンストラクタ。</span>

<span class="sd">        Args:</span>
<span class="sd">            db_manager (SQLiteManager): データベース接続を管理するオブジェクト。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;ImageRepository&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span> <span class="o">=</span> <span class="n">db_manager</span>

<div class="viewcode-block" id="ImageRepository.add_original_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.add_original_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">add_original_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        オリジナル画像のメタデータを images テーブルに追加します。</span>

<span class="sd">        Args:</span>
<span class="sd">            info (dict[str, Any]): 画像情報を含む辞書。</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 挿入された画像のID。</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: 必須情報が不足している場合。</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pHashの計算と重複チェック</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phash</span> <span class="o">=</span> <span class="n">calculate_phash</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;stored_image_path&#39;</span><span class="p">]))</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;phash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phash</span>
            <span class="n">duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_duplicate_image</span><span class="p">(</span><span class="n">phash</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duplicate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像が既に存在します: ID </span><span class="si">{</span><span class="n">duplicate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">duplicate</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pHashの処理中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="s1">&#39;stored_image_path&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;has_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;extension&#39;</span><span class="p">,</span> <span class="s1">&#39;color_space&#39;</span><span class="p">,</span> <span class="s1">&#39;icc_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;phash&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">):</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;必須情報が不足しています: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO images (uuid, stored_image_path, width, height, format, mode, has_alpha,</span>
<span class="s2">                            filename, extension, color_space, icc_profile, phash, created_at, updated_at)</span>
<span class="s2">        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">updated_at</span> <span class="o">=</span> <span class="n">created_at</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stored_image_path&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;has_alpha&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;extension&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;color_space&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;icc_profile&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;phash&#39;</span><span class="p">],</span>
                <span class="n">created_at</span><span class="p">,</span>
                <span class="n">updated_at</span>
            <span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;オリジナル画像をDBに追加しました: UUID=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;オリジナル画像の追加中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageRepository.add_processed_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.add_processed_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">add_processed_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        処理済み画像のメタデータを images テーブルに追加します。</span>

<span class="sd">        Args:</span>
<span class="sd">            info (dict[str, Any]): 処理済み画像情報を含む辞書。</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 挿入された処理済み画像のID。</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: 必須情報が不足している場合。</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stored_image_path&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;has_alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;color_space&#39;</span><span class="p">,</span> <span class="s1">&#39;icc_profile&#39;</span><span class="p">,</span> <span class="s1">&#39;image_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">):</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;必須情報が不足しています: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO processed_images (image_id, stored_image_path, width, height, mode, has_alpha,</span>
<span class="s2">                                filename, color_space, icc_profile, created_at, updated_at)</span>
<span class="s2">        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">updated_at</span> <span class="o">=</span> <span class="n">created_at</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stored_image_path&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;has_alpha&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;color_space&#39;</span><span class="p">],</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;icc_profile&#39;</span><span class="p">],</span>
                <span class="n">created_at</span><span class="p">,</span>
                <span class="n">updated_at</span>
            <span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;処理済み画像をDBに追加しました: 親画像ID=</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;処理済み画像の追加中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageRepository.get_image_metadata">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_image_metadata">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_image_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたIDの画像メタデータを取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 取得する画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[dict[str, Any]]: 画像メタデータを含む辞書。画像が見つからない場合はNone。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM images WHERE id = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
            <span class="k">return</span> <span class="n">metadata</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">current_method</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_method</span><span class="si">}</span><span class="s2"> 画像メタデータの取得中にエラーが発生しました : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageRepository.save_annotations">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.save_annotations">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">save_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">annotations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        画像のアノテーション（タグ、キャプション、スコア）を保存します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): アノテーションを追加する画像のID。</span>
<span class="sd">            annotations (dict): アノテーションデータ。</span>
<span class="sd">            {</span>
<span class="sd">                &#39;tags&#39;: list[dict[tag: model_id]],</span>
<span class="sd">                &#39;captions&#39;: list[caption: model_id],</span>
<span class="sd">                &#39;score&#39;: dict[score: model_id]</span>
<span class="sd">                &#39;model_id&#39;: int</span>
<span class="sd">                &#39;image_path&#39;: str</span>
<span class="sd">            }</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">            ValueError: 必要なデータが不足している場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_exists</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;指定されたimage_id </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> は存在しません。&quot;</span><span class="p">)</span>

        <span class="c1"># 各値を取得</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">captions</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;captions&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">score_data</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">model_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">caption</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="n">captions</span> <span class="k">if</span> <span class="n">caption</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;model_idはすべてNoneで保存されます。&quot;</span><span class="p">)</span>

        <span class="n">tags_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag_dict</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
        <span class="n">caption_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">caption_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">caption_dict</span> <span class="ow">in</span> <span class="n">captions</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_tags</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">tags_list</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_captions</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">caption_list</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score_data</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">score_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">score_model_id</span> <span class="o">=</span> <span class="n">score_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_score</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">score_model_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">current_method</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_method</span><span class="si">}</span><span class="s2"> アノテーションの保存中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_save_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">model_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;タグとそのIDを保存する内部メソッド</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): タグを追加する画像のID。</span>
<span class="sd">            tags (list[str]): タグのリスト。</span>
<span class="sd">            model_id (Optional[int]): タグ付けに使用されたモデルのID。Noneの場合は既存タグとして扱う。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_save_tags called with image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">, tags: </span><span class="si">{</span><span class="n">tags</span><span class="si">}</span><span class="s2">, model_id: </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type of tags: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のタグリストが空のため、保存をスキップします。&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO tags (image_id, tag_id, tag, model_id, existing, created_at, updated_at)</span>
<span class="s2">                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)</span>
<span class="s2">                ON CONFLICT(image_id, tag, tag_id, model_id) DO UPDATE SET</span>
<span class="s2">                    existing = EXCLUDED.existing,</span>
<span class="s2">                    updated_at = CURRENT_TIMESTAMP</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">tag_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_tag_id</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># None の場合は明示的に NULL を設定</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_id</span><span class="p">,</span> <span class="n">tag_id</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">existing</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_id</span><span class="p">,</span> <span class="n">tag_id</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">existing</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ImageRepository._save_tags_with_ids: tag=</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">, tag_id=</span><span class="si">{</span><span class="n">tag_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> に </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> 個のタグとIDを保存しました&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;タグとIDの保存中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_save_captions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">captions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">model_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;キャプションを保存する</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): キャプションを追加する画像のID。</span>
<span class="sd">            captions (list[str]): キャプションのリスト。</span>
<span class="sd">            model_id (Optional[int]): キャプションに関連付けられたモデルのID。Noneの場合は既存キャプションとして扱う。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">captions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のキャプションリストが空のため、保存をスキップします。&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO captions (image_id, caption, model_id, existing, created_at, updated_at)</span>
<span class="s2">                VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)</span>
<span class="s2">                ON CONFLICT(image_id, caption, model_id) DO UPDATE SET</span>
<span class="s2">                    existing = EXCLUDED.existing,</span>
<span class="s2">                    updated_at = CURRENT_TIMESTAMP</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="n">captions</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">model_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_id</span><span class="p">,</span> <span class="n">caption</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">existing</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_id</span><span class="p">,</span> <span class="n">caption</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">existing</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ImageRepository._save_captions: </span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> に </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> 個のキャプションを保存しました&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;キャプションの保存中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="ImageRepository.save_score">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.save_score">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">save_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;スコアを保存</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): スコアを追加する画像のID。</span>
<span class="sd">            score (float): スコアの値。</span>
<span class="sd">            model_id (int): スコアに関連付けられたモデルのID。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">            ValueError: 必要なデータが不足している場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;スコアが0のため、保存をスキップします。&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;INSERT OR IGNORE INTO scores (image_id, score, model_id) VALUES (?, ?, ?)&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Score saved: image_id=</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">, score=</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">, model_id=</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save score: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span> <span class="nf">_get_model_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;モデル名からモデルIDを取得するメソッド&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM models WHERE name = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;モデル名 &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; が見つかりません。&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">current_method</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_method</span><span class="si">}</span><span class="s2"> エラー: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_image_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された画像IDが存在するかを確認します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 確認する画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: 画像が存在する場合はTrue、存在しない場合はFalse。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT 1 FROM images WHERE id = ?&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImageRepository.find_duplicate_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.find_duplicate_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">find_duplicate_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたpHashに一致する画像をデータベースから検索しImage IDを返します。</span>

<span class="sd">        Args:</span>
<span class="sd">            phash (str): 検索するpHash。</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[int]: 重複する画像のメタデータ。見つからない場合はNone。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM images WHERE phash = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">duplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">phash</span><span class="p">,))</span>
            <span class="n">image_id</span> <span class="o">=</span> <span class="n">duplicate</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">duplicate</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">duplicate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;重複画像が見つかりました: ID </span><span class="si">{</span><span class="n">duplicate</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, UUID </span><span class="si">{</span><span class="n">duplicate</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image_id</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;重複画像の検索中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageRepository.get_image_annotations">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_image_annotations">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_image_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された画像IDのアノテーション（タグ、キャプション、スコア）を取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): アノテーションを取得する画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, list[dict[str, Any]]]: アノテーションデータを含む辞書。</span>
<span class="sd">            画像が存在しない場合は空の辞書を返します。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 画像の存在確認</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_exists</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;指定されたimage_id </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> の画像が存在しません。&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;captions&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="p">[]}</span>

            <span class="c1"># アノテーションの取得</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tags</span><span class="p">(</span><span class="n">image_id</span><span class="p">),</span>
                <span class="s1">&#39;captions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_captions</span><span class="p">(</span><span class="n">image_id</span><span class="p">),</span>
                <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_scores</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">annotations</span>

        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;アノテーションの取得中にデータベースエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;予期せぬエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="k">def</span> <span class="nf">_get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;image_idからタグを取得する内部メソッド&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT tag, model_id, tag_id, updated_at FROM tags WHERE image_id = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;タグを取得するimage_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> にタグは登録されていません。&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のタグを取得中にデータベースエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_get_captions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;image_idからキャプションを取得する内部メソッド&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT caption, model_id, updated_at FROM captions WHERE image_id = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;キャプションを取得するimage_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> にキャプションは登録されていません。&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のキャプションを取得中にデータベースエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_get_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;image_idからスコアを取得する内部メソッド&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT score, model_id FROM scores WHERE image_id = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;スコアを取得するimage_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> にスコアは登録されていません。&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のスコアを取得中にデータベースエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="ImageRepository.escape_special_characters">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.escape_special_characters">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">escape_special_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SQLの特殊文字（% と _）をエスケープし、ワイルドカードの * を % に置換する。</span>
<span class="sd">        ダブルクオートで囲まれた部分は完全一致として扱う。</span>

<span class="sd">        Args:</span>
<span class="sd">            input_string (str): エスケープする入力文字列</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: エスケープされた文字列</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ダブルクオートで囲まれた部分は完全一致として扱う</span>
        <span class="k">if</span> <span class="n">input_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">input_string</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="c1"># ダブルクオートを外してそのまま戻す</span>
            <span class="k">return</span> <span class="n">input_string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># 特殊文字のエスケープとワイルドカードの置換</span>
        <span class="n">escaped_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\%&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\_&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">escaped_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageRepository.get_images_by_tag">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_images_by_tag">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_images_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された日付の範囲で更新されたタグを持つ画像のIDリストを取得する</span>
<span class="sd">        （部分一致とワイルドカードに対応）</span>

<span class="sd">        Args:</span>
<span class="sd">            tag (str): 検索するタグ（ワイルドカード &#39;*&#39; を含むことができます）</span>
<span class="sd">            start_date (str): 検索開始日時（UTCタイムスタンプ）</span>
<span class="sd">            end_date (str): 検索終了日時（UTCタイムスタンプ）</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[int]: タグを持つ画像IDのリスト か 空リスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="c1"># 完全一致検索用のクエリ</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT i.id</span>
<span class="s2">            FROM images i</span>
<span class="s2">            JOIN tags t ON i.id = t.image_id</span>
<span class="s2">            WHERE t.tag = ?</span>
<span class="s2">            AND t.updated_at BETWEEN ? AND ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="c1"># ダブルクオートを外したタグで検索</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ワイルドカードなしでも部分一致検索にする</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_special_characters</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
                <span class="c1"># &#39;*&#39; がない場合も部分一致のLIKEを使う</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;%</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1">%&#39;</span>

            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT i.id</span>
<span class="s2">            FROM images i</span>
<span class="s2">            JOIN tags t ON i.id = t.image_id</span>
<span class="s2">            WHERE t.tag LIKE ? ESCAPE &#39;</span><span class="se">\\</span><span class="s2">&#39;</span>
<span class="s2">            AND t.updated_at BETWEEN ? AND ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="c1"># タイムスタンプをパラメータに追加</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> を含む画像はありません&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImageRepository.get_untagged_images">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_untagged_images">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_untagged_images</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT id</span>
<span class="s2">        FROM images</span>
<span class="s2">        WHERE id NOT IN (SELECT DISTINCT image_id FROM tags WHERE image_id)</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">())]</span></div>


<div class="viewcode-block" id="ImageRepository.get_images_by_caption">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_images_by_caption">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_images_by_caption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caption</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたキャプションを含む画像のIDリストを取得する（部分一致、ワイルドカード、完全一致に対応）</span>

<span class="sd">        Args:</span>
<span class="sd">            caption (str): 検索するキャプション（ワイルドカード &#39;*&#39; やダブルクオートを含むことができます）</span>
<span class="sd">            start_date (str): 検索開始日時(&#39;%Y-%m-%d %H:%M:%S&#39;)</span>
<span class="sd">            end_date (str): 検索終了日時</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[int]: キャプションを持つ画像IDのリスト か 空リスト</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># キャプションがダブルクオートで囲まれている場合は完全一致検索を行う</span>
        <span class="k">if</span> <span class="n">caption</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">caption</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="c1"># 完全一致検索用のクエリ</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT DISTINCT i.id</span>
<span class="s2">            FROM images i</span>
<span class="s2">            JOIN captions c ON i.id = c.image_id</span>
<span class="s2">            WHERE c.caption = ?</span>
<span class="s2">            AND c.updated_at BETWEEN ? AND ?</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="c1"># ダブルクオートを外したキャプションで検索</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">caption</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 部分一致検索用のパターン作成</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">escape_special_characters</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">caption</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;%</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s1">%&#39;</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT DISTINCT i.id</span>
<span class="s2">            FROM images i</span>
<span class="s2">            JOIN captions c ON i.id = c.image_id</span>
<span class="s2">            WHERE c.caption LIKE ? ESCAPE &#39;</span><span class="se">\\</span><span class="s2">&#39;</span>
<span class="s2">            AND c.updated_at BETWEEN ? AND ?</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; を含むキャプションを持つ画像はありません&quot;</span><span class="p">,</span> <span class="n">caption</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImageRepository.get_processed_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_processed_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_processed_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        image_idから関連する全ての処理済み画像のメタデータを取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 元画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]]: 処理済み画像のメタデータのリスト。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT * FROM processed_images</span>
<span class="s2">        WHERE image_id = ?</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ID </span><span class="si">%s</span><span class="s2"> の処理済み画像メタデータを取得しました: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">current_method</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="k">raise</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">current_method</span><span class="si">}</span><span class="s2"> 処理済み画像の取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageRepository.get_total_image_count">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_total_image_count">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_total_image_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) FROM images&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;COUNT(*)&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;総画像数の取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="ImageRepository.get_image_id_by_name">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_image_id_by_name">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_image_id_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        オリジナル画像の重複チェック用 画像名からimage_idを取得</span>

<span class="sd">        Args:</span>
<span class="sd">            image_name (str): 画像名</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[int]: image_id。画像が見つからない場合はNone。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM images WHERE filename = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_name</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">image_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像名 </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> のimage_id </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> を取得しました&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">image_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像名 </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2"> のimage_idを取得できませんでした&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像IDの取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageRepository.get_image_id_by_phash">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.get_image_id_by_phash">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_image_id_by_phash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phash</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pHashからimage_idを取得</span>

<span class="sd">        Args:</span>
<span class="sd">            phash (str): pHash</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[int]: image_id。画像が見つからない場合はNone。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">THRESHOLD</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># この値は調整可能です。小さいほど厳密な一致を要求します。</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id, phash FROM images&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">db_id</span><span class="p">,</span> <span class="n">db_phash</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;phash&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">imagehash</span><span class="o">.</span><span class="n">hex_to_hash</span><span class="p">(</span><span class="n">phash</span><span class="p">)</span> <span class="o">-</span> <span class="n">imagehash</span><span class="o">.</span><span class="n">hex_to_hash</span><span class="p">(</span><span class="n">db_phash</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">THRESHOLD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;類似画像が見つかりました: ID </span><span class="si">{</span><span class="n">db_id</span><span class="si">}</span><span class="s2">, 元のpHash: </span><span class="si">{</span><span class="n">phash</span><span class="si">}</span><span class="s2">, DB内pHash: </span><span class="si">{</span><span class="n">db_phash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">db_id</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;類似画像は見つかりませんでした: pHash </span><span class="si">{</span><span class="n">phash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;類似画像の検索中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageRepository.update_image_metadata">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.update_image_metadata">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">update_image_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">updated_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された画像IDのメタデータを更新します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 更新する画像のID。</span>
<span class="sd">            updated_info (dict[str, Any]): 更新するメタデータの辞書。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;更新する情報が提供されていません。&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> = ?&quot;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">updated_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">updated_info</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;UPDATE images SET </span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">, updated_at = ? WHERE id = ?&quot;</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>  <span class="c1"># updated_atを追加</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>  <span class="c1"># image_idを追加</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のメタデータを更新しました。&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像メタデータの更新中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageRepository.delete_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.delete_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">delete_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された画像IDの画像と関連するデータを削除します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 削除する画像のID。</span>

<span class="sd">        Raises:</span>
<span class="sd">            sqlite3.Error: データベース操作でエラーが発生した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM images WHERE id = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> と関連するデータを削除しました。&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像の削除中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageRepository.find_tag_id">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageRepository.find_tag_id">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">find_tag_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;tags_v3.db TAGSテーブルからタグを完全一致で検索</span>

<span class="sd">        Args:</span>
<span class="sd">            keyword (str): 検索キーワード</span>
<span class="sd">        Returns:</span>
<span class="sd">            tag_id (Optional[int]): タグID</span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: 複数または0件のタグが見つかった場合</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT tag_id FROM tag_db.TAGS WHERE tag = ?&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_one</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">keyword</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;タグ &#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&#39; に対して複数のIDが見つかりました。</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tag_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tag_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;tag_id&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;タグ &#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&#39; のtag_id </span><span class="si">{</span><span class="n">tag_id</span><span class="si">}</span><span class="s2"> を取得しました&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">tag_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;タグ &#39;</span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="s2">&#39; のtag_idを取得できませんでした&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;タグIDの取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>
</div>


<div class="viewcode-block" id="ImageDatabaseManager">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">ImageDatabaseManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    画像データベース操作の高レベルインターフェースを提供するクラス。</span>
<span class="sd">    このクラスは、ImageRepositoryを使用して、画像メタデータとアノテーションの</span>
<span class="sd">    保存、取得、更新などの操作を行います。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;ImageDatabaseManager&quot;</span><span class="p">)</span>
        <span class="n">img_db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;Image_database&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;image_database.db&quot;</span>
        <span class="n">tag_db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;module&quot;</span> <span class="o">/</span> <span class="s2">&quot;genai-tag-db-tools&quot;</span> <span class="o">/</span> <span class="s2">&quot;tags_v3.db&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span> <span class="o">=</span> <span class="n">SQLiteManager</span><span class="p">(</span><span class="n">img_db_path</span><span class="p">,</span> <span class="n">tag_db_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository</span> <span class="o">=</span> <span class="n">ImageRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">create_tables</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">insert_models</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;初期化&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ImageDatabaseManager使用中にエラー: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># 例外を伝播させる</span>

<div class="viewcode-block" id="ImageDatabaseManager.register_original_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.register_original_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">register_original_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">fsm</span><span class="p">:</span> <span class="n">FileSystemManager</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;オリジナル画像を保存し、メタデータをデータベースに登録</span>

<span class="sd">        Args:</span>
<span class="sd">            image_path (Path): 画像パス</span>
<span class="sd">            fsm (FileSystemManager): FileSystemManager のインスタンス</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[tuple]: 登録成功時は (image_id, original_metadata)、失敗時は None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">original_image_metadata</span> <span class="o">=</span> <span class="n">fsm</span><span class="o">.</span><span class="n">get_image_info</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="n">db_stored_original_path</span> <span class="o">=</span> <span class="n">fsm</span><span class="o">.</span><span class="n">save_original_image</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
            <span class="c1"># UUIDの生成</span>
            <span class="n">image_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="c1"># メタデータにUUIDと保存パスを追加</span>
            <span class="n">original_image_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">image_uuid</span><span class="p">,</span>
                <span class="s1">&#39;stored_image_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_stored_original_path</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="c1"># データベースに挿入</span>
            <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">add_original_image</span><span class="p">(</span><span class="n">original_image_metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">original_image_metadata</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;オリジナル画像の登録中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.register_processed_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.register_processed_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">register_processed_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">processed_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        処理済み画像を保存し、メタデータをデータベースに登録します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 元画像のID。</span>
<span class="sd">            processed_path (Path): 処理済み画像の保存パス。</span>
<span class="sd">            info (dict[str, Any]): 処理済み画像のメタデータ。</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[int]: 保存された処理済み画像のID。失敗時は None。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 必須情報を確認</span>
            <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;has_alpha&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;color_space&#39;</span><span class="p">,</span> <span class="s1">&#39;icc_profile&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">):</span>
                <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;必須情報が不足しています: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># メタデータに親画像IDを追加</span>
            <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
                <span class="s1">&#39;stored_image_path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">processed_path</span><span class="p">),</span>
            <span class="p">})</span>

            <span class="c1"># データベースに挿入</span>
            <span class="n">processed_image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">add_processed_image</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">processed_image_id</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;処理済み画像メタデータの保存中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.save_annotations">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.save_annotations">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">save_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">annotations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        画像のアノテーション（タグ、キャプション、スコア）を保存します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): アノテーションを追加する画像のID。</span>
<span class="sd">            annotations (dict[str, list[Any, Any]]): アノテーションデータ。</span>
<span class="sd">                &#39;tags&#39;, &#39;captions&#39;, &#39;score&#39; をキーとし、それぞれリストを値とする辞書。</span>
<span class="sd">                各リストの要素は {&#39;value&#39;: str, &#39;model&#39;: str} の形式。</span>
<span class="sd">        Raises:</span>
<span class="sd">            Exception: アノテーションの保存に失敗した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save_annotations called with image_id: </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">, annotations: </span><span class="si">{</span><span class="n">annotations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type of annotations: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">save_annotations</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像 ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のアノテーション</span><span class="si">{</span><span class="n">annotations</span><span class="si">}</span><span class="s2">を保存しました&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;アノテーションの保存中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.save_score">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.save_score">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">save_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">score_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        画像のスコアを保存します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): スコアを追加する画像のID。</span>
<span class="sd">            score (dict[str, Any]): スコアの値と算出に使ったモデルのID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score_float</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;model_id&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">save_score</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">score_float</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像 ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> のスコア</span><span class="si">{</span><span class="n">score_float</span><span class="si">}</span><span class="s2">を保存しました&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;スコアの保存中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_low_res_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_low_res_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_low_res_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたIDで長辺が最小の処理済み画像のパスを取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 取得する元画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: 長辺が最小の処理済み画像のパス。見つからない場合はNone。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">processed_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_processed_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">processed_images</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> に対する処理済み画像が見つかりません。&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># 長辺が最小の画像を見つける</span>
            <span class="n">min_long_edge</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">min_image_path</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">processed_images</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
                <span class="n">long_edge</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">long_edge</span> <span class="o">&lt;</span> <span class="n">min_long_edge</span><span class="p">:</span>
                    <span class="n">min_long_edge</span> <span class="o">=</span> <span class="n">long_edge</span>
                    <span class="n">min_image_path</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;stored_image_path&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">min_image_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> の最小長辺画像（</span><span class="si">{</span><span class="n">min_long_edge</span><span class="si">}</span><span class="s2">px）を取得しました。&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">min_image_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> に対する適切な低解像度画像が見つかりません。&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;低解像度画像の取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_image_metadata">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_image_metadata">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_image_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定されたIDの画像メタデータを取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 取得する画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[dict[str, Any]]: 画像メタデータを含む辞書。画像が見つからない場合はNone。</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: メタデータの取得に失敗した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_image_metadata</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> の画像が見つかりません。&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像メタデータ取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_processed_metadata">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_processed_metadata">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_processed_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された元画像IDに関連する全ての処理済み画像のメタデータを取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 元画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict[str, Any]]: 処理済み画像のメタデータのリスト。</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: メタデータの取得に失敗した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">processed_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_processed_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">processed_images</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> の元画像に関連する処理済み画像が見つかりません。&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">processed_images</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;処理済み画像メタデータ取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_image_annotations">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_image_annotations">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_image_annotations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された画像IDのアノテーション（タグ、キャプション、スコア）を取得します。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): アノテーションを取得する画像のID。</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, list[dict[str, Any]]]: アノテーションデータを含む辞書。</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: アノテーションの取得に失敗した場合。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_image_annotations</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">annotations</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> の画像にアノテーションが見つかりません。&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">annotations</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像アノテーション取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_models">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_models">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: データベースに問い合わせるのでImageRepositoryに移動したほうがキレイ その時処理は分割する</span>
<span class="sd">        データベースに登録されているモデルの情報を取得します。</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict[int, dict[str, Any]], dict[int, dict[str, Any]]]: (vision_models, score_models) のタプル。</span>
<span class="sd">            vision_models: {model_id: {&#39;name&#39;: model_name, &#39;provider&#39;: provider}},</span>
<span class="sd">            upscaler_models: {model_id: {&#39;name&#39;: model_name, &#39;provider&#39;: provider}}</span>
<span class="sd">            score_models: {model_id: {&#39;name&#39;: model_name, &#39;provider&#39;: provider}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id, name, provider, type FROM models&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">vision_models</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">score_models</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">upscaler_models</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
                <span class="n">model_id</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">provider</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;provider&#39;</span><span class="p">]</span>
                <span class="n">model_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;vision&#39;</span><span class="p">:</span>
                    <span class="n">vision_models</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span>
                    <span class="n">score_models</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;upscaler&#39;</span><span class="p">:</span>
                    <span class="n">upscaler_models</span><span class="p">[</span><span class="n">model_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">vision_models</span><span class="p">,</span> <span class="n">score_models</span><span class="p">,</span> <span class="n">upscaler_models</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;モデルの取得中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_images_by_filter">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_images_by_filter">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_images_by_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">caption</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
                             <span class="n">use_and</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                             <span class="n">include_untagged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">include_nsfw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            tags (list[str], optional): カンマ区切りをリスト化したタグ. Defaults to None.</span>
<span class="sd">            caption (str, optional): _キャプション</span>
<span class="sd">            resolution (int, optional): 検索する解像度x解像度の値が誤差20%以内の画像を取得. Defaults to 0.</span>
<span class="sd">            use_and (bool, optional): _description_. Defaults to True.</span>
<span class="sd">            start_date (str): 検索する画像の作成日時の下限(&#39;%Y-%m-%d %H:%M:%S&#39;)</span>
<span class="sd">            end_date (str,): 検索する画像の作成日時の上限</span>
<span class="sd">            include_untagged (bool, optional): タグが付いていない画像のみを取得. Defaults to False.</span>
<span class="sd">            include_nsfw (bool, optional): NSFW画像を含めるかどうか. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[list[dict[str, Any]], int]: 条件にマッチした画像データのリストとその数</span>
<span class="sd">            例:([</span>
<span class="sd">                {&#39;id&#39;: 516, &#39;image_id&#39;: 515, &#39;stored_image_path&#39;: &#39;psth&#39;, </span>
<span class="sd">                &#39;width&#39;: 1024, &#39;height&#39;: 768, &#39;mode&#39;: &#39;RGB&#39;, &#39;has_alpha&#39;: 0, &#39;filename&#39;: &#39;1_240925_00304.webp&#39;, &#39;color_space&#39;: &#39;RGB&#39;, &#39;icc_profile&#39;: &#39;Not present&#39;, &#39;created_at&#39;: &#39;2024-09-26T20:21:08.451199&#39;, &#39;updated_at&#39;: &#39;2024-09-26T20:21:08.451199&#39;},</span>
<span class="sd">                {&#39;id&#39;: 517, &#39;image_id&#39;: 516, &#39;stored_image_path&#39;: &#39;psth&#39;,...}</span>
<span class="sd">                ],</span>
<span class="sd">                2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">caption</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_untagged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;タグもキャプションも指定されていない&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># 現在の日付を取得</span>
        <span class="n">current_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">)</span>  <span class="c1"># 2020年1月1日</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="ow">or</span> <span class="n">current_datetime</span>  <span class="c1"># 現在</span>

        <span class="n">image_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">include_untagged</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="ow">or</span> <span class="n">caption</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;検索語句とinclude_untaggedが同時に指定されています。検索語句を無視します。&quot;</span><span class="p">)</span>
            <span class="n">untagged_image_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_untagged_images</span><span class="p">())</span>
            <span class="n">image_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">untagged_image_ids</span><span class="p">)</span>

        <span class="c1"># タグによるフィルタリング</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_untagged</span><span class="p">:</span>
            <span class="n">tag_results</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_images_by_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">))</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tag_results</span><span class="p">:</span>
                <span class="n">image_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">tag_results</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_and</span> <span class="k">else</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">tag_results</span><span class="p">)</span>

        <span class="c1"># キャプションによるフィルタリング</span>
        <span class="k">if</span> <span class="n">caption</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">include_untagged</span><span class="p">:</span>
            <span class="n">caption_results</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_images_by_caption</span><span class="p">(</span><span class="n">caption</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">))</span>
            <span class="n">image_ids</span> <span class="o">=</span> <span class="n">image_ids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">caption_results</span><span class="p">)</span> <span class="k">if</span> <span class="n">image_ids</span> <span class="k">else</span> <span class="n">caption_results</span>

        <span class="c1"># image_idsが空の場合は空リストを返す</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;条件に一致する画像が見つかりませんでした&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="mi">0</span>

        <span class="c1"># image_idsの画像のアノテーションを取得､キーワード一致するNSFWが含まれるimage_idを除外</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_nsfw</span><span class="p">:</span>
            <span class="n">exclude_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nsfw&#39;</span><span class="p">,</span> <span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;pussy&#39;</span><span class="p">,</span> <span class="s1">&#39;nude&#39;</span><span class="p">,</span> <span class="s1">&#39;penis&#39;</span><span class="p">,</span> <span class="s1">&#39;cum&#39;</span><span class="p">,</span> <span class="s1">&#39;bdsm&#39;</span><span class="p">]</span>  <span class="c1"># 除外したいキーワードのリスト</span>
            <span class="n">image_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_images_by_exclude_keywords</span><span class="p">(</span><span class="n">image_ids</span><span class="p">,</span> <span class="n">exclude_keywords</span><span class="p">)</span>

        <span class="c1"># 画像メタデータの取得</span>
        <span class="n">metadata_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_processed_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="n">metadata_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># 解像度によるフィルタリング</span>
        <span class="k">if</span> <span class="n">resolution</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">filtered_metadata_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_by_resolution</span><span class="p">(</span><span class="n">metadata_list</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered_metadata_list</span> <span class="o">=</span> <span class="n">metadata_list</span>

        <span class="n">list_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_metadata_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;フィルタリング後の画像数: </span><span class="si">{</span><span class="n">list_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_metadata_list</span><span class="p">,</span> <span class="n">list_count</span></div>


    <span class="k">def</span> <span class="nf">_filter_by_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            解像度に基づいてメタデータのリストをフィルタリングします。</span>

<span class="sd">            Args:</span>
<span class="sd">                metadata_list (list[dict[str, Any]]): メタデータの辞書のリスト。</span>
<span class="sd">                resolution (int): ディレクトリの解像度。</span>

<span class="sd">            Returns:</span>
<span class="sd">                list[dict[str, Any]]: フィルタリングされたメタデータの辞書のリスト。解像度が条件に一致するか、</span>
<span class="sd">                解像度の条件に誤差が0.2以下のメタデータが含まれます。</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">filtered_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">metadata</span> <span class="ow">in</span> <span class="n">metadata_list</span><span class="p">:</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
                <span class="n">long_side</span><span class="p">,</span> <span class="n">short_side</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">long_side</span> <span class="o">==</span> <span class="n">resolution</span><span class="p">:</span>
                    <span class="n">filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">target_area</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">*</span> <span class="n">resolution</span>
                    <span class="n">actual_area</span> <span class="o">=</span> <span class="n">long_side</span> <span class="o">*</span> <span class="n">short_side</span>
                    <span class="n">error_ratio</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">target_area</span> <span class="o">-</span> <span class="n">actual_area</span><span class="p">)</span> <span class="o">/</span> <span class="n">target_area</span>

                    <span class="k">if</span> <span class="n">error_ratio</span> <span class="o">&lt;=</span> <span class="mf">0.2</span><span class="p">:</span>
                        <span class="n">filtered_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filtered_list</span>

    <span class="k">def</span> <span class="nf">_filter_images_by_exclude_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">exclude_keywords</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された除外キーワードがタグまたはキャプションに含まれる画像IDを除外して、フィルタリングされた画像IDのセットを返します。</span>

<span class="sd">        引数:</span>
<span class="sd">            image_ids (set[int]): フィルタリング対象の画像IDのセット。</span>
<span class="sd">            exclude_keywords (list[str]): 除外キーワードのリスト。これらのキーワードを含む画像は除外されます。</span>

<span class="sd">        戻り値:</span>
<span class="sd">            set[int]: 除外キーワードが一致しない画像IDのセット。</span>

<span class="sd">        方法:</span>
<span class="sd">            1. `image_ids` の各画像IDに対して、その画像のタグとキャプションのアノテーションを取得します。</span>
<span class="sd">            2. タグとキャプションを小文字に変換し、大文字小文字を区別せずに比較します。</span>
<span class="sd">            3. 除外キーワードのいずれかがタグまたはキャプションに含まれているかを確認します。</span>
<span class="sd">            4. 除外キーワードが一致する場合、その画像IDを `image_ids` から削除します。</span>
<span class="sd">            5. フィルタリングされた画像IDのセットを返します。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_ids_copy</span> <span class="o">=</span> <span class="n">image_ids</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># `set` のコピーを作成します</span>
        <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids_copy</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_image_annotations</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[])]</span>
            <span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="n">caption</span><span class="p">[</span><span class="s1">&#39;caption&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;captions&#39;</span><span class="p">,</span> <span class="p">[])]</span>
            <span class="c1"># 除外キーワードのチェック</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="n">tags</span> <span class="o">+</span> <span class="n">captions</span>
            <span class="n">exclude_match</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">annotation</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">exclude_keywords</span> <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exclude_match</span><span class="p">:</span>
                <span class="n">image_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>  <span class="c1"># `set` から直接削除します</span>

        <span class="k">return</span> <span class="n">image_ids</span>

<div class="viewcode-block" id="ImageDatabaseManager.detect_duplicate_image">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.detect_duplicate_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">detect_duplicate_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        画像の重複を検出し、重複する場合はその画像のIDを返す。</span>
<span class="sd">        名前による高速な検索と、pHashによる正確な重複検知を組み合わせて使用。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_path (Path): 検査する画像ファイルのパス</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[int]: 重複する画像が見つかった場合はそのimage_id、見つからない場合はNone</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># まず名前で高速に検索</span>
        <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_image_id_by_name</span><span class="p">(</span><span class="n">image_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;画像名の一致を検出: </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image_id</span>

        <span class="c1"># 名前で見つからない場合、pHashを計算して検索</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
                <span class="n">phash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">imagehash</span><span class="o">.</span><span class="n">phash</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

            <span class="n">image_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_image_id_by_phash</span><span class="p">(</span><span class="n">phash</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pHashの一致を検出: </span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">image_id</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pHash計算中にエラーが発生: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.get_total_image_count">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.get_total_image_count">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_total_image_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;データベース内に登録された編集前画像の総数を取得&quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_total_image_count</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="ImageDatabaseManager.check_processed_image_exists">
<a class="viewcode-back" href="../../module.db.html#module.db.ImageDatabaseManager.check_processed_image_exists">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">check_processed_image_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">target_resolution</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        指定された画像IDと目標解像度に一致する処理済み画像が存在するかチェックします。</span>

<span class="sd">        Args:</span>
<span class="sd">            image_id (int): 元画像のID</span>
<span class="sd">            target_resolution (int): 目標解像度</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[dict]: 処理済み画像が存在する場合はそのメタデータ、存在しない場合はNone</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">processed_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">get_processed_image</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">processed_image</span> <span class="ow">in</span> <span class="n">processed_images</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">processed_image</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span>
                <span class="n">height</span> <span class="o">=</span> <span class="n">processed_image</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="n">target_resolution</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">==</span> <span class="n">target_resolution</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">processed_image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ID </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> の画像に解像度 </span><span class="si">{</span><span class="n">target_resolution</span><span class="si">}</span><span class="s2"> に一致する処理済み画像が見つかりませんでした&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;処理済み画像のチェック中にエラーが発生しました: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">lora_dataset_toolsy</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>ナビゲーション</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">モジュールコード</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, NEXTAltair.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.0.2</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>