<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>score_module.musiq_module &#8212; lora_dataset_toolsy 1.01 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=c058f7c8" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=e77f40a7"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=91613774"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>score_module.musiq_module のソースコード</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># 参考コード</span>
<span class="c1"># https://github.com/anse3832/MUSIQ</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">clip</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">tqdm</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;大規模データセットを取り扱うためのライブラリ(h5py)がインストールされていません&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">einops</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span>

<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">transforms</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">InterpolationMode</span>
    <span class="n">BICUBIC</span> <span class="o">=</span> <span class="n">InterpolationMode</span><span class="o">.</span><span class="n">BICUBIC</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">BICUBIC</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">BICUBIC</span>
<span class="k">def</span> <span class="nf">_transform</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">Normalize</span><span class="p">((</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">)),</span>
    <span class="p">])</span>
<div class="viewcode-block" id="get_image_preprocess">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.get_image_preprocess">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">get_image_preprocess</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_transform</span><span class="p">()</span></div>


<div class="viewcode-block" id="collate_fn">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.collate_fn">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">examples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="n">CONST_STR_KUGIRILINE_LEN</span> <span class="o">=</span> <span class="mi">24</span>
<div class="viewcode-block" id="get_property">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.get_property">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">get_property</span><span class="p">(</span><span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_patches</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_per</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">reso_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">hdf5</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdf5_resume</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdf5_add_load</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdf5_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;musiq&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">resnet_dir</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;./score_module&quot;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_resume</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataset_save_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;n_layer&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
        <span class="s2">&quot;h_dim&quot;</span><span class="p">:</span>  <span class="mi">384</span><span class="p">,</span> <span class="c1"># clip 768 def 384</span>
        <span class="s2">&quot;n_head&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;d_head&quot;</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span>
        <span class="s2">&quot;d_ff&quot;</span><span class="p">:</span> <span class="mi">1152</span><span class="p">,</span>
        <span class="s2">&quot;grid_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;dropout&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;layer_norm_epsilon&quot;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span>
        <span class="s2">&quot;score_model_dir&quot;</span><span class="p">:</span> <span class="n">resnet_dir</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">dataset_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;data_path&quot;</span><span class="p">:</span> <span class="n">data_path</span><span class="p">,</span>
        <span class="s2">&quot;reso_size&quot;</span><span class="p">:</span> <span class="n">reso_size</span> <span class="k">if</span> <span class="n">reso_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">832</span><span class="p">,</span>
        <span class="s2">&quot;divisible&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="s2">&quot;patche_size&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="s2">&quot;patche_stride&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="s2">&quot;grid_size&quot;</span><span class="p">:</span> <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;grid_size&quot;</span><span class="p">],</span>
        <span class="s2">&quot;scale_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">384</span><span class="p">,</span> <span class="mi">224</span><span class="p">],</span>
        <span class="s2">&quot;max_patches&quot;</span><span class="p">:</span> <span class="n">max_patches</span> <span class="k">if</span> <span class="n">max_patches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
        <span class="s2">&quot;save_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_save_name</span><span class="si">}</span><span class="s2">.hdf5&quot;</span> <span class="k">if</span> <span class="n">dataset_save_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;eval_per&quot;</span><span class="p">:</span> <span class="n">eval_per</span><span class="p">,</span>
        <span class="s2">&quot;hdf5&quot;</span><span class="p">:</span> <span class="n">hdf5</span><span class="p">,</span>
        <span class="s2">&quot;hdf5_resume&quot;</span><span class="p">:</span> <span class="n">hdf5_resume</span><span class="p">,</span>
        <span class="s2">&quot;hdf5_add_load&quot;</span><span class="p">:</span> <span class="n">hdf5_add_load</span><span class="p">,</span>
        <span class="s2">&quot;hdf5_path&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hdf5_path</span><span class="si">}</span><span class="s2">.hdf5&quot;</span> <span class="k">if</span> <span class="n">hdf5_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;resume&quot;</span><span class="p">:</span> <span class="n">dataset_resume</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">reso_size</span> <span class="o">=</span> <span class="n">dataset_params</span><span class="p">[</span><span class="s2">&quot;reso_size&quot;</span><span class="p">]</span>
    <span class="n">train_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">reso_size</span><span class="si">}</span><span class="s2">.pth&quot;</span> <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;musiq_score_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">reso_size</span><span class="si">}</span><span class="s2">.pth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;save_last_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">reso_size</span><span class="si">}</span><span class="s2">_last.pth&quot;</span> <span class="k">if</span> <span class="n">model_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;musiq_score_</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">reso_size</span><span class="si">}</span><span class="s2">_last.pth&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># fix model params</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;musiq_score&quot;</span><span class="p">:</span>
        <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;output_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;musiq_clip&quot;</span><span class="p">:</span>
        <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;h_dim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">384</span>
        <span class="n">model_params</span><span class="p">[</span><span class="s2">&quot;output_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1"># fix dataset params</span>
    <span class="k">if</span> <span class="n">dataset_resume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dataset_params</span><span class="p">[</span><span class="s2">&quot;resume&quot;</span><span class="p">]):</span>
            <span class="n">dataset_params</span><span class="p">[</span><span class="s2">&quot;hdf5_resume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">model_params</span><span class="p">,</span> <span class="n">dataset_params</span><span class="p">,</span> <span class="n">train_params</span></div>

<div class="viewcode-block" id="print_dict">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.print_dict">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">print_dict</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dict </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_pos_idx">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.create_pos_idx">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">create_pos_idx</span><span class="p">(</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">count_w</span><span class="p">,</span> <span class="n">count_h</span><span class="p">,</span> <span class="n">scale_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return:</span>
<span class="sd">        tensor(1, 1, h, w)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grid_emb_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">grid_emb_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">grid_emb_w</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count_w</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">grid_emb_w</span> <span class="o">=</span> <span class="n">grid_emb_w</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count_h</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">grid_emb_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">grid_emb_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">grid_emb_h</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">count_h</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">grid_emb_h</span> <span class="o">=</span> <span class="n">grid_emb_h</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count_w</span><span class="p">)</span>
    <span class="n">grid_emb</span> <span class="o">=</span> <span class="n">grid_emb_h</span> <span class="o">*</span> <span class="n">grid_size</span> <span class="o">+</span> <span class="n">grid_emb_w</span>
    <span class="n">scale_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">grid_emb</span><span class="p">,</span> <span class="n">scale_id</span><span class="p">)</span>
    <span class="n">cls_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">grid_emb</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">grid_emb</span><span class="p">,</span> <span class="n">scale_emb</span><span class="p">,</span> <span class="n">cls_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_pad_size">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.calculate_pad_size">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">calculate_pad_size</span><span class="p">(</span><span class="n">image_size</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_stride</span><span class="p">):</span>
  <span class="n">num_patches</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_size</span> <span class="o">-</span> <span class="n">patch_size</span><span class="p">)</span> <span class="o">//</span> <span class="n">patch_stride</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">remainder</span> <span class="o">=</span> <span class="n">image_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">num_patches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">patch_stride</span> <span class="o">-</span> <span class="n">patch_size</span>
  <span class="k">if</span> <span class="n">image_size</span> <span class="o">==</span> <span class="n">patch_stride</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">image_size</span> <span class="o">%</span> <span class="n">patch_size</span>
  <span class="k">elif</span> <span class="n">remainder</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">patch_size</span> <span class="o">-</span> <span class="n">remainder</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="extract_patches">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.extract_patches">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">extract_patches</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">output_mode</span><span class="o">=</span><span class="s1">&#39;tf&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract patches from an input image using PyTorch.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (torch.Tensor): Input image (shape: [batch_size, channels, height, width]).</span>
<span class="sd">        patch_size (int): Size of the patches (assumed to be square).</span>
<span class="sd">        patch_stride (int): Stride for patch extraction.</span>
<span class="sd">        padding (str): Padding mode (&#39;same&#39; or &#39;valid&#39;).</span>
<span class="sd">        output_mode: &#39;tf&#39; or &#39;else&#39; tfの場合tf.image.extract_patchesと同じ出力形式になる(b,patch_count, patch_size*patch_size*3) -&gt; patches.view(b,pc,h,w,c)</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: Extracted patches (tf shape: [batch_size, num_patches, channels * patch_size * patch_size]), (torch: [batch_size, num_pathes, pathe_size_h, pathe_size_w, channel]), other shape: [bs, channel, x, y, w, h]</span>
<span class="sd">        Int: count_w</span>
<span class="sd">        Int: count_h</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">padding</span> <span class="o">==</span> <span class="s1">&#39;same&#39;</span><span class="p">:</span>
        <span class="n">pad_w</span> <span class="o">=</span> <span class="n">calculate_pad_size</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_stride</span><span class="p">)</span>
        <span class="n">pad_h</span> <span class="o">=</span> <span class="n">calculate_pad_size</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_stride</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pad_w</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pad_h</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">patches</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pad_w</span><span class="p">))</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_stride</span><span class="p">)</span><span class="o">.</span><span class="n">unfold</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_stride</span><span class="p">)</span>
    <span class="n">count_h</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">count_w</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_mode</span><span class="o">==</span><span class="s2">&quot;tf&quot;</span><span class="p">:</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">patches</span><span class="o">.</span><span class="n">size</span><span class="p">()[:</span><span class="mi">3</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">output_mode</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">patches</span><span class="p">,</span> <span class="n">count_w</span><span class="p">,</span> <span class="n">count_h</span></div>


<div class="viewcode-block" id="round_to_steps">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.round_to_steps">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">round_to_steps</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">reso_steps</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span> <span class="o">%</span> <span class="n">reso_steps</span></div>

<div class="viewcode-block" id="resize_img_resos">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.resize_img_resos">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">resize_img_resos</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_resos</span><span class="p">,</span> <span class="n">reso_steps</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">image_resos</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>
    <span class="n">image_aspec</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>

    <span class="k">if</span> <span class="n">image_resos</span> <span class="o">&gt;</span> <span class="n">max_resos</span><span class="p">:</span>
        <span class="n">resize_w</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">max_resos</span> <span class="o">*</span> <span class="n">image_aspec</span><span class="p">)</span>
        <span class="n">resize_h</span> <span class="o">=</span> <span class="n">max_resos</span> <span class="o">/</span> <span class="n">resize_w</span>
        <span class="c1"># よりアス比が近いものを選ぶ</span>
        <span class="n">round_ww</span> <span class="o">=</span> <span class="n">round_to_steps</span><span class="p">(</span><span class="n">resize_w</span><span class="p">,</span> <span class="n">reso_steps</span><span class="p">)</span>
        <span class="n">round_wh</span> <span class="o">=</span> <span class="n">round_to_steps</span><span class="p">(</span><span class="n">round_ww</span> <span class="o">/</span> <span class="n">image_aspec</span><span class="p">,</span> <span class="n">reso_steps</span><span class="p">)</span>
        <span class="n">w_aspec</span> <span class="o">=</span> <span class="n">round_ww</span> <span class="o">/</span> <span class="n">round_wh</span>
        
        <span class="n">round_hh</span> <span class="o">=</span> <span class="n">round_to_steps</span><span class="p">(</span><span class="n">resize_h</span><span class="p">,</span> <span class="n">reso_steps</span><span class="p">)</span>
        <span class="n">round_hw</span> <span class="o">=</span> <span class="n">round_to_steps</span><span class="p">(</span><span class="n">round_hh</span> <span class="o">*</span> <span class="n">image_aspec</span><span class="p">,</span> <span class="n">reso_steps</span><span class="p">)</span>
        <span class="n">h_aspec</span> <span class="o">=</span> <span class="n">round_hw</span> <span class="o">/</span> <span class="n">round_hh</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w_aspec</span><span class="o">-</span><span class="n">image_aspec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h_aspec</span><span class="o">-</span><span class="n">image_aspec</span><span class="p">):</span>
            <span class="n">resized_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">round_ww</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_ww</span> <span class="o">/</span> <span class="n">image_aspec</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resized_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">round_hh</span> <span class="o">*</span> <span class="n">image_aspec</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">round_hh</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resized_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resized_size</span></div>

<div class="viewcode-block" id="resize_image">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.resize_image">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resize</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resize</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>       <span class="c1"># INTER_AREAでやりたいのでcv2でリサイズ</span></div>

<div class="viewcode-block" id="load_img">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.load_img">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_resize_latents">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.get_resize_latents">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">get_resize_latents</span><span class="p">(</span><span class="n">resnet</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">resos</span><span class="p">,</span> <span class="n">division</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">get_image_preprocess</span><span class="p">()</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">image_resos</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">resos</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">resize</span> <span class="o">=</span> <span class="n">resize_img_resos</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">division</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">image_resos</span> <span class="o">&gt;</span> <span class="n">area</span><span class="p">:</span>
        <span class="n">_img</span> <span class="o">=</span> <span class="n">resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_img</span> <span class="o">=</span> <span class="n">image</span>
    <span class="n">_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">_img</span><span class="p">)</span>
    <span class="n">_img</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">_img</span><span class="p">)</span>
    <span class="n">_latents</span> <span class="o">=</span> <span class="n">resnet</span><span class="p">(</span><span class="n">_img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="n">_latents</span> <span class="o">=</span> <span class="n">_latents</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_latents</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span></div>

<div class="viewcode-block" id="check_hash">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.check_hash">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">check_hash</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;md5&quot;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">hash_data</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hash_data</span></div>


<div class="viewcode-block" id="MUSIQ_Score_Dataset">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">MUSIQ_Score_Dataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reso_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">divisible</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">patche_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">patche_stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">scale_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                 <span class="n">max_patches</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eval_per</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">hdf5</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hdf5_resume</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdf5_add_load</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdf5_path</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">resume</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">use_cashe</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reso_size</span> <span class="o">=</span> <span class="n">reso_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_area</span> <span class="o">=</span> <span class="n">reso_size</span> <span class="o">*</span> <span class="n">reso_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">divisible</span> <span class="o">=</span> <span class="n">divisible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patche_size</span> <span class="o">=</span> <span class="n">patche_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patche_stride</span> <span class="o">=</span> <span class="n">patche_stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="n">grid_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_list</span> <span class="o">=</span> <span class="n">scale_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cashe</span> <span class="o">=</span> <span class="n">use_cashe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span> <span class="o">=</span> <span class="n">max_patches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_list</span> <span class="o">=</span> <span class="n">resume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_name</span> <span class="o">=</span> <span class="n">save_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span> <span class="o">=</span> <span class="n">hdf5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_resume</span> <span class="o">=</span> <span class="n">hdf5_resume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_add_load</span> <span class="o">=</span> <span class="n">hdf5_add_load</span>
        <span class="c1"># HDF5が使えるかチェック</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">__</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">__version__</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_path</span> <span class="o">=</span> <span class="n">data_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/dataset_</span><span class="si">{</span><span class="n">reso_size</span><span class="si">}</span><span class="s2">.hdf5&quot;</span> <span class="k">if</span> <span class="n">hdf5_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">hdf5_path</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_per</span> <span class="o">=</span> <span class="n">eval_per</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># dataset management</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_datalen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_return_len</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">key_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_key_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># transformers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">get_image_preprocess</span><span class="p">()</span>
        <span class="c1"># resnet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">device</span> <span class="o">==</span><span class="s2">&quot;auto&quot;</span> <span class="k">else</span> <span class="n">device</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># self.load_dataset(resume)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">files_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_list</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
        <span class="c1"># culc eval len</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_per</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_per</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span><span class="p">):</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">score_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_path</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_path</span><span class="p">[</span><span class="n">score_id</span><span class="p">][</span><span class="s2">&quot;paths&quot;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_path</span><span class="p">[</span><span class="n">score_id</span><span class="p">][</span><span class="s2">&quot;paths&quot;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_path</span><span class="p">[</span><span class="n">score_id</span><span class="p">][</span><span class="s2">&quot;paths&quot;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">score_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">score_id</span><span class="p">]:</span> <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">score_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">score_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="MUSIQ_Score_Dataset.load_dataset">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.load_dataset">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resume</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">resume</span><span class="p">):</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">]</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span></div>

<div class="viewcode-block" id="MUSIQ_Score_Dataset.save_dataset">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.save_dataset">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">save_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">],</span> <span class="n">save_name</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="MUSIQ_Score_Dataset.merge_hdf5">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.merge_hdf5">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">merge_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="MUSIQ_Score_Dataset.get_data_list">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.get_data_list">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_data_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">base_dir</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span><span class="nb">list</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">files_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">base_dir</span><span class="o">+</span><span class="s2">&quot;/*&quot;</span><span class="p">)</span>
            <span class="n">files_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dir_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
                    <span class="n">files_path</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">dir</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">dir</span><span class="o">+</span><span class="s2">&quot;/*.png&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">dir</span><span class="o">+</span><span class="s2">&quot;/*.jpg&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">dir</span><span class="o">+</span><span class="s2">&quot;/*.jpeg&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">dir</span><span class="o">+</span><span class="s2">&quot;/*.webp&quot;</span><span class="p">)})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;paths&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">files_path</span></div>

    <span class="k">def</span> <span class="nf">_load_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_path</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;RGB&quot;</span><span class="p">:</span>
            <span class="c1"># print(img_path)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">max_area</span><span class="p">):</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">image_resos</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>
        <span class="n">resize</span> <span class="o">=</span> <span class="n">resize_img_resos</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">max_area</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">divisible</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image_resos</span> <span class="o">&gt;</span> <span class="n">max_area</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resize_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">def</span> <span class="nf">_to_latents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">resnet</span><span class="p">):</span>
        <span class="c1"># image = [c, h, w] -&gt; [bs, c, h, w]</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="n">resnet</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="c1"># [bs, h, w, bs]</span>
        <span class="k">return</span> <span class="n">latents</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__to_latents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patches</span><span class="p">,</span> <span class="n">resnet</span><span class="p">):</span>
        <span class="c1"># img_pathes = [bs, x, y, h, w, channel]</span>
        <span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="c1"># img_pathes = [bs * x * y, channel, h, w]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">repeat_count</span> <span class="o">=</span> <span class="n">bs</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span> <span class="o">+</span> <span class="p">(</span><span class="n">bs</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span><span class="p">)</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat_count</span><span class="p">):</span>
            <span class="n">s_pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span>
            <span class="n">e_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_patches</span>
            <span class="k">if</span> <span class="n">e_pos</span> <span class="o">&gt;</span> <span class="n">bs</span><span class="p">:</span> <span class="n">e_pos</span> <span class="o">=</span> <span class="n">patches</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">latents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">latents</span> <span class="o">=</span> <span class="n">resnet</span><span class="p">(</span><span class="n">patches</span><span class="p">[</span><span class="n">s_pos</span><span class="p">:</span><span class="n">e_pos</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">latents</span><span class="p">,</span> <span class="n">resnet</span><span class="p">(</span><span class="n">patches</span><span class="p">[</span><span class="n">s_pos</span><span class="p">:</span><span class="n">e_pos</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latents</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_resize_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">scale_id</span><span class="p">,</span> <span class="n">resnet</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">area</span><span class="p">)</span>
        <span class="n">_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">_img</span><span class="p">)</span>
        <span class="n">_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="p">(</span><span class="n">_img</span><span class="p">)</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_latents</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">ppi</span> <span class="o">=</span> <span class="n">create_pos_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span><span class="p">,</span> <span class="n">scale_id</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span><span class="p">,</span> <span class="n">latents</span>
    <span class="k">def</span> <span class="nf">__create_resize_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">scale_id</span><span class="p">,</span> <span class="n">resnet</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">area</span><span class="p">)</span>
        <span class="n">patches</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span> <span class="o">=</span> <span class="n">extract_patches</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patche_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patche_stride</span><span class="p">,</span> <span class="n">output_mode</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">get_image_preprocess</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">resnet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_latents</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">patches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">latents</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ppi</span> <span class="o">=</span> <span class="n">create_pos_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span><span class="p">,</span> <span class="n">scale_id</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">patches</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="n">s_cw</span><span class="p">,</span> <span class="n">s_ch</span><span class="p">,</span> <span class="n">latents</span>
    
    <span class="k">def</span> <span class="nf">_create_data_id_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">eval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">target_key</span><span class="p">])]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shuffle_data_id_list</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="nb">eval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">target_key</span><span class="p">])]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shuffle_data_id_list</span><span class="p">(</span><span class="n">target_key</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_shuffle_data_id_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">eval</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_create_key_id_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">eval</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eval_key_id_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key_id_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key_id_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">count</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_id_list</span><span class="p">)</span>
    
<div class="viewcode-block" id="MUSIQ_Score_Dataset.create_datalist">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.create_datalist">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">create_datalist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resnet</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;create dataset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resnet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resnet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">resnet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">resnet</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_resume</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf5_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;train&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">:</span>
                    <span class="n">h5_train_data</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_add_load</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h5_train_data</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5_train_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data_list</span> <span class="o">=</span> <span class="n">h5_train_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;eval&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">:</span>
                    <span class="n">h5_eval_data</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_add_load</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h5_eval_data</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5_eval_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">data_list</span> <span class="o">=</span> <span class="n">h5_eval_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;data_info&quot;</span> <span class="ow">in</span> <span class="n">h5</span><span class="p">:</span>
                    <span class="n">h5_data_info</span> <span class="o">=</span> <span class="n">h5</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;data_info&quot;</span><span class="p">)</span>
                    <span class="n">h5_data_info_data</span> <span class="o">=</span> <span class="n">h5_data_info</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
                    <span class="n">h5_data_info_data</span> <span class="o">=</span> <span class="n">h5_data_info</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>
                    <span class="c1">#h5_data_info_hash = h5_data_info.create_group(&quot;hash&quot;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h5_data_info</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;data_info&quot;</span><span class="p">]</span>
                    <span class="n">h5_data_info_data</span> <span class="o">=</span> <span class="n">h5_data_info</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5_data_info_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5_data_info_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span> <span class="o">+=</span> <span class="n">h5_data_info_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">h5_data_info_data</span> <span class="o">=</span> <span class="n">h5_data_info</span><span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5_data_info_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5_data_info_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span> <span class="o">+=</span> <span class="n">h5_data_info_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1">#h5_data_info_hash = h5_data_info[&quot;hash&quot;]</span>
                <span class="c1"># データセット構築</span>
                <span class="k">for</span> <span class="n">target_score</span><span class="p">,</span> <span class="n">img_path_dic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_add_load</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">img_path_dic</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">img_path_dic</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">],</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)):</span>
                        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
                        <span class="c1"># scales</span>
                        <span class="n">scale_patches</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">scale_pos_idx</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">scale_latents</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">scale_count</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_list</span><span class="p">):</span>
                            <span class="n">scale_count</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">s_patches</span><span class="p">,</span> <span class="n">s_pos_idx</span><span class="p">,</span> <span class="n">scale_count</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">scale_count</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_resize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="o">*</span><span class="n">scale</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span>
                            <span class="n">scale_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_patches</span><span class="p">)</span>
                            <span class="n">scale_pos_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_pos_idx</span><span class="p">)</span>
                            <span class="n">scale_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>

                        <span class="c1"># img_pathes = [bs, x, y, h, w, channel] if resnet==None else None</span>
                        <span class="c1"># latents[bs, x, y, h_dim * w * h] if resnet is not None else None</span>
                        <span class="c1"># patche_pos_idx = [bs, x, y, pos_id + scale + cls]</span>
                        <span class="n">img_patches</span><span class="p">,</span> <span class="n">patche_pos_idx</span><span class="p">,</span> <span class="n">count_w</span><span class="p">,</span> <span class="n">count_h</span><span class="p">,</span> <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_resize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span>
                        <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_w</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">count_h</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">scale_count</span><span class="p">:</span>
                            <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_str</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        
                        <span class="n">eval_flag</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">target_score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_score</span><span class="p">]:</span>
                                <span class="n">eval_flag</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">if</span> <span class="n">eval_flag</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">res_str</span> <span class="ow">in</span> <span class="n">h5_eval_data</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">h5_eval_list</span> <span class="o">=</span> <span class="n">h5_eval_data</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">res_str</span><span class="p">)</span>
                                <span class="n">eval_h5_data_list</span> <span class="o">=</span> <span class="n">h5_eval_list</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">h5_eval_list</span> <span class="o">=</span> <span class="n">h5_eval_data</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span>
                                <span class="n">eval_h5_data_list</span> <span class="o">=</span> <span class="n">h5_eval_list</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]))</span>

                            <span class="n">eval_h5_data</span> <span class="o">=</span> <span class="n">eval_h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">score</span><span class="p">])</span>
                            <span class="n">eval_h5_latents</span> <span class="o">=</span> <span class="n">eval_h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;latents&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
                            <span class="n">eval_h5_scale_1_latents</span> <span class="o">=</span> <span class="n">eval_h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;scale_1&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
                            <span class="n">eval_h5_scale_2_latents</span> <span class="o">=</span> <span class="n">eval_h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;scale_2&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">+=</span><span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">res_str</span> <span class="ow">in</span> <span class="n">h5_train_data</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">data_list</span> <span class="o">=</span> <span class="n">h5_train_data</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">res_str</span><span class="p">)</span>
                                <span class="n">h5_data_list</span> <span class="o">=</span> <span class="n">data_list</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">data_list</span> <span class="o">=</span> <span class="n">h5_train_data</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span>
                                <span class="n">h5_data_list</span> <span class="o">=</span> <span class="n">data_list</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]))</span>

                            <span class="n">h5_data</span> <span class="o">=</span> <span class="n">h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">score</span><span class="p">])</span>
                            <span class="n">h5_latents</span> <span class="o">=</span> <span class="n">h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;latents&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
                            <span class="n">h5_scale_1_latents</span> <span class="o">=</span> <span class="n">h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;scale_1&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
                            <span class="n">h5_scale_2_latents</span> <span class="o">=</span> <span class="n">h5_data_list</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;scale_2&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span><span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1"># score count情報書き込み</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5_add_load</span><span class="p">:</span>
                    <span class="n">h5_data_info_data</span> <span class="o">=</span> <span class="n">h5_data_info</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5_data_info_data</span><span class="p">:</span>
                            <span class="n">h5_data_info_data_count</span> <span class="o">=</span> <span class="n">h5_data_info_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">h5_data_info_data_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">h5_data_info_data_count</span> <span class="o">=</span> <span class="n">h5_data_info_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
                    <span class="n">h5_data_info_data</span> <span class="o">=</span> <span class="n">h5_data_info</span><span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h5_data_info_data</span><span class="p">:</span>
                            <span class="n">h5_data_info_data_count</span> <span class="o">=</span> <span class="n">h5_data_info_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">h5_data_info_data_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">h5_data_info_data_count</span> <span class="o">=</span> <span class="n">h5_data_info_data</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target_score</span><span class="p">,</span> <span class="n">img_path_dic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_path</span><span class="p">):</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">img_path_dic</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">target_id</span><span class="p">,</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">img_path_dic</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">])):</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
                    <span class="c1"># scales</span>
                    <span class="n">scale_patches</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">scale_pos_idx</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">scale_latents</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">scale_count</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_list</span><span class="p">):</span>
                        <span class="n">scale_count</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">s_patches</span><span class="p">,</span> <span class="n">s_pos_idx</span><span class="p">,</span> <span class="n">scale_count</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">scale_count</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_resize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">scale</span><span class="o">*</span><span class="n">scale</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span>
                        <span class="n">scale_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_patches</span><span class="p">)</span>
                        <span class="n">scale_pos_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_pos_idx</span><span class="p">)</span>
                        <span class="n">scale_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>

                    <span class="c1"># img_pathes = [bs, x, y, h, w, channel] if resnet==None else None</span>
                    <span class="c1"># latents[bs, x, y, h_dim * w * h] if resnet is not None else None</span>
                    <span class="c1"># patche_pos_idx = [bs, x, y, pos_id + scale + cls]</span>
                    <span class="n">img_patches</span><span class="p">,</span> <span class="n">patche_pos_idx</span><span class="p">,</span> <span class="n">count_w</span><span class="p">,</span> <span class="n">count_h</span><span class="p">,</span> <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_resize_img</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resnet</span><span class="p">)</span>
                    <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_w</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">count_h</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">scale_count</span><span class="p">:</span>
                        <span class="n">res_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">res_str</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">sc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">eval_flag</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">target_score</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_score</span><span class="p">]:</span>
                            <span class="n">eval_flag</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">eval_flag</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s2">&quot;patches&quot;</span><span class="p">:</span> <span class="n">img_patches</span><span class="p">,</span> <span class="s2">&quot;latents&quot;</span><span class="p">:</span> <span class="n">latents</span><span class="p">,</span> <span class="s2">&quot;scale_patches&quot;</span><span class="p">:</span> <span class="n">scale_patches</span><span class="p">,</span> <span class="s2">&quot;scale_1_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;scale_2_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s2">&quot;patches&quot;</span><span class="p">:</span> <span class="n">img_patches</span><span class="p">,</span> <span class="s2">&quot;latents&quot;</span><span class="p">:</span> <span class="n">latents</span><span class="p">,</span> <span class="s2">&quot;scale_patches&quot;</span><span class="p">:</span> <span class="n">scale_patches</span><span class="p">,</span> <span class="s2">&quot;scale_1_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;scale_2_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s2">&quot;patches&quot;</span><span class="p">:</span> <span class="n">img_patches</span><span class="p">,</span> <span class="s2">&quot;latents&quot;</span><span class="p">:</span> <span class="n">latents</span><span class="p">,</span> <span class="s2">&quot;scale_patches&quot;</span><span class="p">:</span> <span class="n">scale_patches</span><span class="p">,</span> <span class="s2">&quot;scale_1_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;scale_2_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">[</span><span class="n">res_str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span> <span class="s2">&quot;patches&quot;</span><span class="p">:</span> <span class="n">img_patches</span><span class="p">,</span> <span class="s2">&quot;latents&quot;</span><span class="p">:</span> <span class="n">latents</span><span class="p">,</span> <span class="s2">&quot;scale_patches&quot;</span><span class="p">:</span> <span class="n">scale_patches</span><span class="p">,</span> <span class="s2">&quot;scale_1_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;scale_2_latents&quot;</span><span class="p">:</span> <span class="n">scale_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">score</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">resnet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resnet</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        
        <span class="c1"># counting datalist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_data_id_list</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># eval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_data_id_list</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create id list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_key_id_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_datalen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_id_list</span><span class="p">)</span>
        <span class="c1"># eval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_key_id_list</span><span class="p">(</span><span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_return_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key_id_list</span><span class="p">)</span></div>


        <span class="c1"># save datalist</span>
        <span class="c1"># if (not self.hdf5) and (self.save_name is not None):</span>
        <span class="c1">#    self.save_dataset(self.save_name)</span>
        
<div class="viewcode-block" id="MUSIQ_Score_Dataset.print_datacount">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.print_datacount">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">print_datacount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:::データセット情報(サイズ毎のデータ数):::&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data count list / data count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;eval count list / data count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_data_count</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span></div>

<div class="viewcode-block" id="MUSIQ_Score_Dataset.print_datacount_score">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Score_Dataset.print_datacount_score">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">print_datacount_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;:::データセット情報(スコア毎のデータ数):::&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data count list / data count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="p">(</span><span class="n">value</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">train_datalen</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">02.03f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;eval count list / data: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_score_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="p">(</span><span class="n">value</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_datalen</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">02.03f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">CONST_STR_KUGIRILINE_LEN</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__total_datalen__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_datalen</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_return_len</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_datalen</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="c1"># ターゲットとなるkeyを取り出す</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key_id_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_key_id_list</span><span class="p">(</span><span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_keys</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_key_id_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_data_id_list</span><span class="p">(</span><span class="n">target_key</span><span class="p">,</span> <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key_id_list</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_key_id_list</span><span class="p">()</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_id_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_data_id_list</span><span class="p">(</span><span class="n">target_key</span><span class="p">)</span>
        <span class="c1"># batch size分のデータを取り出す</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scale_1_latents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scale_2_latents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf5</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hdf5_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">:</span>
                    <span class="n">h5_target_base</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;eval&quot;</span><span class="p">]</span>
                    <span class="n">h5_target_key_base</span> <span class="o">=</span> <span class="n">h5_target_base</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                        <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">h5_target_data</span> <span class="o">=</span> <span class="n">h5_target_key_base</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span>
                        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;latents&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                        <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;scale_1&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                        <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;scale_2&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">h5_target_base</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span>
                    <span class="n">h5_target_key_base</span> <span class="o">=</span> <span class="n">h5_target_base</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                        <span class="n">target_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">h5_target_data</span> <span class="o">=</span> <span class="n">h5_target_key_base</span><span class="p">[</span><span class="n">target_id</span><span class="p">]</span>
                        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;latents&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                        <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;scale_1&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
                        <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">h5_target_data</span><span class="p">[</span><span class="s2">&quot;scale_2&quot;</span><span class="p">][</span><span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>
                    <span class="n">latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;latents&quot;</span><span class="p">])</span>
                    <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;scale_1_latents&quot;</span><span class="p">])</span>
                    <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;scale_2_latents&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">])</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">target_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_id_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;score&quot;</span><span class="p">])</span>
                    <span class="n">latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;latents&quot;</span><span class="p">])</span>
                    <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;scale_1_latents&quot;</span><span class="p">])</span>
                    <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_list</span><span class="p">[</span><span class="n">target_key</span><span class="p">][</span><span class="n">target_id</span><span class="p">][</span><span class="s2">&quot;scale_2_latents&quot;</span><span class="p">])</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>
        <span class="n">scale_1_latents</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scale_1_latents</span><span class="p">)</span>
        <span class="n">scale_2_latents</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">scale_2_latents</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span> <span class="s2">&quot;latent&quot;</span><span class="p">:</span> <span class="n">latents</span><span class="p">,</span> <span class="s2">&quot;s1_latent&quot;</span><span class="p">:</span> <span class="n">scale_1_latents</span><span class="p">,</span> <span class="s2">&quot;s2_latent&quot;</span><span class="p">:</span> <span class="n">scale_2_latents</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="Bottleneck">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Bottleneck">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">Bottleneck</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_relu</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
                               <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_relu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">SiLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">downsample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>

<div class="viewcode-block" id="Bottleneck.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Bottleneck.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">residual</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>


<div class="viewcode-block" id="ResNetBackbone">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.ResNetBackbone">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">ResNetBackbone</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">layers</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResNetBackbone</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">out_channels</span>
                <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">):</span>
                <span class="n">m</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
        

    <span class="k">def</span> <span class="nf">_make_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_relu</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span> <span class="o">!=</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">:</span>
            <span class="n">downsample</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">,</span>
                          <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">downsample</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span> <span class="o">=</span> <span class="n">planes</span> <span class="o">*</span> <span class="n">block</span><span class="o">.</span><span class="n">expansion</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">blocks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">blocks</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">output_relu</span><span class="o">=</span><span class="n">output_relu</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

<div class="viewcode-block" id="ResNetBackbone.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.ResNetBackbone.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer4</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span></div>
</div>


<div class="viewcode-block" id="resnet50_backbone">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.resnet50_backbone">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">resnet50_backbone</span><span class="p">(</span><span class="n">score_model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Constructs a ResNet-50 model_hyper.</span>
    <span class="n">torch_resnet50_url</span> <span class="o">=</span> <span class="s2">&quot;https://download.pytorch.org/models/resnet50-11ad3fa6.pth&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ResNetBackbone</span><span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    
    <span class="c1"># load pre-trained weights</span>
    <span class="kn">import</span> <span class="nn">torch.utils.model_zoo</span> <span class="k">as</span> <span class="nn">model_zoo</span>
    <span class="n">save_model</span> <span class="o">=</span> <span class="n">model_zoo</span><span class="o">.</span><span class="n">load_url</span><span class="p">(</span><span class="n">torch_resnet50_url</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">score_model_dir</span><span class="p">)</span>
    <span class="n">model_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
    <span class="n">state_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">save_model</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="n">model_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_dict</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="MultiHeadAttention">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MultiHeadAttention">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">MultiHeadAttention</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_head</span> <span class="o">=</span> <span class="n">n_head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_head</span> <span class="o">=</span> <span class="n">d_head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span> <span class="o">*</span> <span class="n">d_head</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span> <span class="o">*</span> <span class="n">d_head</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span> <span class="o">*</span> <span class="n">d_head</span><span class="p">)</span>
        <span class="c1"># SDPA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdpa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">scaled_dot_product_attention</span>
        <span class="c1"># Leniear</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n_head</span> <span class="o">*</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_enable_math</span> <span class="o">=</span> <span class="kc">True</span>
<div class="viewcode-block" id="MultiHeadAttention.enable_math">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MultiHeadAttention.enable_math">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">enable_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable_math</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_enable_math</span> <span class="o">=</span> <span class="n">enable_math</span></div>

<div class="viewcode-block" id="MultiHeadAttention.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MultiHeadAttention.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">attn_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># latents = [bs, x * y + scale1 + scale2 + cls, h_dim] -&gt; [bs, n_head, x*y+s1+s2+cls, d_head]</span>
        <span class="n">q_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_head</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">k_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_head</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">v_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_head</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_head</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attn_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># (bs, n_head, n_q_seq, n_k_seq)</span>
            <span class="n">attn_mask</span> <span class="o">=</span> <span class="n">attn_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_head</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># [bs, n_head, x*y+s1+s2+cls, d_head]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">sdp_kernel</span><span class="p">(</span><span class="n">enable_flash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_math</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">set_enable_math</span><span class="p">,</span> <span class="n">enable_mem_efficient</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdpa</span><span class="p">(</span><span class="n">q_s</span><span class="p">,</span> <span class="n">k_s</span><span class="p">,</span> <span class="n">v_s</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">)</span>
        <span class="c1"># [bs, x*y+s1+s2+cls, n_head * d_head]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_head</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_head</span><span class="p">)</span>
        <span class="c1"># [bs, x*y+s1+s2+cls, h_dim]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="c1"># [bs, x*y+s1+s2+cls, h_dim]</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>

    
<div class="viewcode-block" id="PoswiseFeedForwardNet">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.PoswiseFeedForwardNet">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">PoswiseFeedForwardNet</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_ff</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">gelu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<div class="viewcode-block" id="PoswiseFeedForwardNet.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.PoswiseFeedForwardNet.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="c1"># [bs, h_dim, x*y+s1+s2+cls]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin1</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="c1"># [bs, d_ff, x*y+s1+s2+cls]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin2</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="c1"># [bs, h_dim, x*y+s1+s2+cls]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="get_sinusoid_encoding_table">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.get_sinusoid_encoding_table">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">get_sinusoid_encoding_table</span><span class="p">(</span><span class="n">n_seq</span><span class="p">,</span> <span class="n">d_hidn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">cal_angle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">i_hidn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">position</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">i_hidn</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_hidn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_posi_angle_vec</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cal_angle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">i_hidn</span><span class="p">)</span> <span class="k">for</span> <span class="n">i_hidn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d_hidn</span><span class="p">)]</span>

    <span class="n">sinusoid_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_posi_angle_vec</span><span class="p">(</span><span class="n">i_seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">i_seq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_seq</span><span class="p">)])</span>
    <span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># even index sin </span>
    <span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">sinusoid_table</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># odd index cos</span>

    <span class="k">return</span> <span class="n">sinusoid_table</span></div>

<div class="viewcode-block" id="get_attn_pad_mask">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.get_attn_pad_mask">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">get_attn_pad_mask</span><span class="p">(</span><span class="n">seq_q</span><span class="p">,</span> <span class="n">seq_k</span><span class="p">,</span> <span class="n">i_pad</span><span class="p">):</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">len_q</span> <span class="o">=</span> <span class="n">seq_q</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">batch_size</span><span class="p">,</span> <span class="n">len_k</span> <span class="o">=</span> <span class="n">seq_k</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">pad_attn_mask</span> <span class="o">=</span> <span class="n">seq_k</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">i_pad</span><span class="p">)</span>
    <span class="n">pad_attn_mask</span><span class="o">=</span> <span class="n">pad_attn_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">len_q</span><span class="p">,</span> <span class="n">len_k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pad_attn_mask</span></div>

<div class="viewcode-block" id="Encoder_Layer">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Encoder_Layer">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">Encoder_Layer</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">MultiHeadAttention</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">layer_norm_epsilon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ffn</span> <span class="o">=</span> <span class="n">PoswiseFeedForwardNet</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">layer_norm_epsilon</span><span class="p">)</span>
<div class="viewcode-block" id="Encoder_Layer.enable_math">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Encoder_Layer.enable_math">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">enable_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable_math</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">enable_math</span><span class="p">(</span><span class="n">enable_math</span><span class="p">)</span></div>

<div class="viewcode-block" id="Encoder_Layer.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Encoder_Layer.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">attn_mask</span><span class="p">):</span>
        <span class="c1"># latents = [bs, x * y + scale1 + scale2 + cls, h_dim]</span>
        <span class="n">att_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">attn_mask</span><span class="p">)</span>
        <span class="c1"># [bs, x*y+s1+s2+cls, h_dim]</span>
        <span class="n">att_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln1</span><span class="p">(</span><span class="nb">input</span> <span class="o">+</span> <span class="n">att_output</span><span class="p">)</span>
        <span class="c1"># [bs, x*y+s1+s2+cls, h_dim]</span>
        <span class="n">ffn_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ffn</span><span class="p">(</span><span class="n">att_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln2</span><span class="p">(</span><span class="n">att_output</span> <span class="o">+</span> <span class="n">ffn_output</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="MUSIQ_Encoder">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Encoder">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">MUSIQ_Encoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span><span class="n">layer_norm_epsilon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># scale Embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sce_org_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sce_1_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sce_2_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Hash-based 2D Spatial Embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="n">grid_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hse_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">))</span>
        <span class="c1"># CLS token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_param</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>

        <span class="c1"># Transformer Layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">Encoder_Layer</span><span class="p">(</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layer</span><span class="p">)])</span>
<div class="viewcode-block" id="MUSIQ_Encoder.enable_math">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Encoder.enable_math">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">enable_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable_math</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">enable_math</span><span class="p">(</span><span class="n">enable_math</span><span class="p">)</span></div>

<div class="viewcode-block" id="MUSIQ_Encoder.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_Encoder.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">org_emb</span><span class="p">,</span> <span class="n">scale_1_emb</span><span class="p">,</span> <span class="n">scale_2_emb</span><span class="p">,</span> <span class="n">mask_input</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># latents = [bs, h_dim, x, y]</span>
        <span class="n">bs</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">org_emb</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">__</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">scale_1_emb</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">__</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">scale_2_emb</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="c1"># scale Embedding</span>
        <span class="n">scale_emb_org</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sce_org_param</span><span class="p">,</span> <span class="s2">&quot;() h () () -&gt; b h x y&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="n">scale_emb_1</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sce_1_param</span><span class="p">,</span> <span class="s2">&quot;() h () () -&gt; b h x y&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y1</span><span class="p">)</span>
        <span class="n">scale_emb_2</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sce_2_param</span><span class="p">,</span> <span class="s2">&quot;() h () () -&gt; b h x y&quot;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y2</span><span class="p">)</span>
        <span class="n">org_emb</span> <span class="o">+=</span> <span class="n">scale_emb_org</span>
        <span class="n">scale_1_emb</span> <span class="o">+=</span> <span class="n">scale_emb_1</span>
        <span class="n">scale_2_emb</span> <span class="o">+=</span> <span class="n">scale_emb_2</span>

        <span class="c1"># pos emb</span>
        <span class="n">spatial_org_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">org_emb</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
                <span class="n">t_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
                <span class="n">t_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">j</span><span class="o">/</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
                <span class="n">spatial_org_embed</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hse_param</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t_j</span><span class="p">]</span>
        <span class="n">spatial_org_embed</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">spatial_org_embed</span><span class="p">,</span> <span class="s1">&#39;() h x y -&gt; b h x y&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>

        <span class="n">spatial_1_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">org_emb</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y1</span><span class="p">):</span>
                <span class="n">t_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
                <span class="n">t_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">j</span><span class="o">/</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
                <span class="n">spatial_1_embed</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hse_param</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t_j</span><span class="p">]</span>
        <span class="n">spatial_1_embed</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">spatial_1_embed</span><span class="p">,</span> <span class="s1">&#39;() h x y -&gt; b h x y&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>

        <span class="n">spatial_2_embed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">org_emb</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y2</span><span class="p">):</span>
                <span class="n">t_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">i</span><span class="o">/</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
                <span class="n">t_j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">j</span><span class="o">/</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
                <span class="n">spatial_2_embed</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hse_param</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">t_j</span><span class="p">]</span>
        <span class="n">spatial_2_embed</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">spatial_2_embed</span><span class="p">,</span> <span class="s1">&#39;() h x y -&gt; b h x y&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>

        <span class="n">org_emb</span> <span class="o">+=</span> <span class="n">spatial_org_embed</span>
        <span class="n">scale_1_emb</span> <span class="o">+=</span> <span class="n">spatial_1_embed</span>
        <span class="n">scale_2_emb</span> <span class="o">+=</span> <span class="n">spatial_2_embed</span>

        <span class="c1"># latents = [bs, h_dim, x, y] -&gt; [bs, h_dim, x * y]</span>
        <span class="n">org_emb</span> <span class="o">=</span> <span class="n">org_emb</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scale_1_emb</span> <span class="o">=</span> <span class="n">scale_1_emb</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scale_2_emb</span> <span class="o">=</span> <span class="n">scale_2_emb</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># latents = [bs, h_dim, x, y] -&gt; [bs, h_dim, x * y + scale1 + scale2]</span>
        <span class="n">input_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">org_emb</span><span class="p">,</span> <span class="n">scale_1_emb</span><span class="p">,</span> <span class="n">scale_2_emb</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># latents = [bs, h_dim, x * y + scale1 + scale2] -&gt; [bs, h_dim, x * y + scale1 + scale2 + cls]</span>
        <span class="n">cls_emb</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_param</span><span class="p">,</span> <span class="s1">&#39;() h l -&gt; b h l&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>
        <span class="n">input_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">cls_emb</span><span class="p">,</span> <span class="n">input_emb</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># latents = [bs, h_dim, x * y + scale1 + scale2 + cls] -&gt; [bs, x * y + scale1 + scale2 + cls, h_dim]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">input_emb</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

        <span class="c1"># (bs, n_enc_seq+1, n_enc_seq+1)</span>
        <span class="n">attn_mask</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># get_attn_pad_mask(mask_input, mask_input, self.config.i_pad)</span>

        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">attn_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>


<div class="viewcode-block" id="MUSIQ">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">MUSIQ</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_encoder_dim</span> <span class="o">=</span> <span class="mi">2048</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h_dim</span> <span class="o">=</span> <span class="n">h_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_conv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_encoder_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_conv_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_encoder_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_conv_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_encoder_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_dim</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mhattn</span> <span class="o">=</span> <span class="n">MUSIQ_Encoder</span><span class="p">(</span><span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">)</span>

<div class="viewcode-block" id="MUSIQ.enable_math">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ.enable_math">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">enable_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable_math</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mhattn</span><span class="o">.</span><span class="n">enable_math</span><span class="p">(</span><span class="n">enable_math</span><span class="p">)</span></div>

<div class="viewcode-block" id="MUSIQ.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="n">scale_1_latents</span><span class="p">,</span> <span class="n">scale_2_latents</span><span class="p">):</span>
        <span class="c1"># latents[bs, x, y, resnet_dim * w * h]</span>
        <span class="c1"># scale_latents = [ latents_scale1,  latents_scale2, ...]</span>
        <span class="n">bs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">__</span><span class="p">,</span> <span class="n">s0_x</span><span class="p">,</span> <span class="n">s0_y</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">__</span><span class="p">,</span> <span class="n">s1_x</span><span class="p">,</span> <span class="n">s1_y</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="c1"># latents[bs, x, y, resnet_dim] -&gt; [bs, resnet_dim, x, y]</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">s0_latents</span> <span class="o">=</span> <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">s1_latents</span> <span class="o">=</span> <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

        <span class="c1"># Pre Encode</span>
        <span class="c1"># latents[bs, resnet_dim, x, y] -&gt; [bs, h_dim, x, y]</span>
        <span class="n">h_org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_conv</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>
        <span class="n">h_s0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_conv_1</span><span class="p">(</span><span class="n">s0_latents</span><span class="p">)</span>
        <span class="n">h_s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_conv_2</span><span class="p">(</span><span class="n">s1_latents</span><span class="p">)</span>
        <span class="c1"># </span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mhattn</span><span class="p">(</span><span class="n">h_org</span><span class="p">,</span> <span class="n">h_s0</span><span class="p">,</span> <span class="n">h_s1</span><span class="p">)</span>
        <span class="c1"># latents[bs, x*y + s1x*s1y + s2x*s2y, h_dim, x, y]</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>


<div class="viewcode-block" id="MLP">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MLP">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">pytorch_lightning</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_size</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span> <span class="n">h_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="n">input_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_size</span> <span class="o">=</span> <span class="n">h_size</span> <span class="k">if</span> <span class="n">h_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span><span class="o">//</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_size</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="o">//</span><span class="mi">8</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="o">//</span><span class="mi">32</span><span class="p">),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span><span class="o">//</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
<div class="viewcode-block" id="MLP.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MLP.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="MUSIQ_SCORE_Model">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_SCORE_Model">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">MUSIQ_SCORE_Model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">,</span> <span class="n">output_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">musiq</span> <span class="o">=</span> <span class="n">MUSIQ</span><span class="p">(</span><span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">h_dim</span> <span class="o">*</span> <span class="n">output_scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_scale</span><span class="o">=</span><span class="n">output_scale</span>
<div class="viewcode-block" id="MUSIQ_SCORE_Model.enable_math">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_SCORE_Model.enable_math">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">enable_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable_math</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">musiq</span><span class="o">.</span><span class="n">enable_math</span><span class="p">(</span><span class="n">enable_math</span><span class="p">)</span></div>

<div class="viewcode-block" id="MUSIQ_SCORE_Model.forward">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.MUSIQ_SCORE_Model.forward">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="n">scale_1_latents</span><span class="p">,</span> <span class="n">scale_2_latents</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_scale</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">musiq</span><span class="p">(</span><span class="n">latents</span><span class="p">,</span> <span class="n">scale_1_latents</span><span class="p">,</span> <span class="n">scale_2_latents</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">musiq</span><span class="p">(</span><span class="n">latents</span><span class="p">,</span> <span class="n">scale_1_latents</span><span class="p">,</span> <span class="n">scale_2_latents</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">output_scale</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>
</div>

<span class="c1"># モデル作成用</span>
<div class="viewcode-block" id="Create_MUSIQ_Model">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Create_MUSIQ_Model">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">Create_MUSIQ_Model</span><span class="p">(</span><span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">,</span> <span class="n">score_model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">resnet50_backbone</span><span class="p">(</span><span class="n">score_model_dir</span><span class="p">),</span> <span class="n">MUSIQ</span><span class="p">(</span><span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">)</span></div>

<div class="viewcode-block" id="Create_MUSIQ_SCORE_Model">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Create_MUSIQ_SCORE_Model">[ドキュメント]</a>
<span class="k">def</span> <span class="nf">Create_MUSIQ_SCORE_Model</span><span class="p">(</span><span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">,</span> <span class="n">score_model_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">resnet50_backbone</span><span class="p">(</span><span class="n">score_model_dir</span><span class="p">),</span> <span class="n">MUSIQ_SCORE_Model</span><span class="p">(</span><span class="n">n_layer</span><span class="p">,</span> <span class="n">h_dim</span><span class="p">,</span> <span class="n">n_head</span><span class="p">,</span> <span class="n">d_head</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">layer_norm_epsilon</span><span class="p">,</span> <span class="n">output_scale</span><span class="p">)</span></div>



<div class="viewcode-block" id="Score_Manager">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Score_Manager">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">Score_Manager</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">score_max</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">score_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">net_arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">net_arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npy_dot</span> <span class="o">=</span> <span class="s2">&quot;.npy&quot;</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span><span class="p">)</span>
            <span class="c1">#args.output = args.output + &quot;_x4&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npy_dot</span> <span class="o">=</span> <span class="s2">&quot;_x4.npy&quot;</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span><span class="p">)</span>
            <span class="c1">#args.output = args.output + &quot;_x9&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npy_dot</span> <span class="o">=</span> <span class="s2">&quot;_x9.npy&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">image_preprocess</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_preprocess</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;ViT-L/14&quot;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>  <span class="c1">#RN50x64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="o">.</span><span class="n">visual</span><span class="o">.</span><span class="n">input_resolution</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_preprocess</span> <span class="o">=</span> <span class="n">get_image_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">tokenize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="kc">None</span><span class="c1">#MLP(768*self.image_size)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">if</span> <span class="n">score_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score_max</span> <span class="o">=</span> <span class="n">score_max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score_max</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">model_path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;.pth&quot;</span><span class="p">:</span>
            <span class="n">model_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">.pth&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<div class="viewcode-block" id="Score_Manager.to_gpu">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Score_Manager.to_gpu">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">to_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span></div>

<div class="viewcode-block" id="Score_Manager.to_cpu">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Score_Manager.to_cpu">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">to_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Score_Manager.get_score">
<a class="viewcode-back" href="../../score_module.musiq_module.html#score_module.musiq_module.Score_Manager.get_score">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_image</span><span class="p">,</span> <span class="n">prompt</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="c1">#txt_id = self.tokenizer(prompt, truncate=True).to(self.device)</span>
            <span class="c1">#if txt_id.size(1) &gt; 77:</span>
            <span class="c1">#    print(f&quot;too long token({txt_id.size()}): {prompt}&quot;)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_preprocess</span><span class="p">(</span><span class="n">raw_image</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">image_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="o">.</span><span class="n">encode_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_preprocess</span><span class="p">(</span><span class="n">raw_image</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_size</span><span class="p">):</span>
                        <span class="n">image_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">image_features</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_model</span><span class="o">.</span><span class="n">encode_image</span><span class="p">(</span><span class="n">image</span><span class="p">[:,:,</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_size</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_size</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_size</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocess_size</span><span class="p">])],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
            <span class="c1">#txt_features = self.clip_model.encode_text(txt_id)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">image_features</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">score_max</span></div>
</div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">score_module_dir</span> <span class="o">=</span> <span class="s2">&quot;./score_module&quot;</span>
    <span class="n">model_params</span><span class="p">,</span> <span class="n">dataset_params</span><span class="p">,</span> <span class="n">train_params</span> <span class="o">=</span> <span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;./test_dataset&quot;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;musiq_clip&quot;</span><span class="p">,</span> <span class="n">eval_per</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hdf5_resume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hdf5_add_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">print_dict</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="s2">&quot;model params&quot;</span><span class="p">)</span>
    <span class="n">print_dict</span><span class="p">(</span><span class="n">dataset_params</span><span class="p">,</span> <span class="s2">&quot;dataset params&quot;</span><span class="p">)</span>
    
    <span class="n">test</span> <span class="o">=</span> <span class="n">MUSIQ_Score_Dataset</span><span class="p">(</span><span class="o">**</span><span class="n">dataset_params</span><span class="p">)</span>
    <span class="c1">#musiq_model = MUSIQ(2, 332, 5, 5, 5, 10, 0.1, 1e-9, score_module_dir)</span>
    <span class="n">pre_encoder</span><span class="p">,</span> <span class="n">musiq_model</span> <span class="o">=</span> <span class="n">Create_MUSIQ_SCORE_Model</span><span class="p">(</span><span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
    <span class="c1">#pre_encoder = resnet50_backbone(score_module_dir)</span>
    <span class="n">test</span><span class="o">.</span><span class="n">create_datalist</span><span class="p">(</span><span class="n">pre_encoder</span><span class="p">)</span>
    <span class="n">test</span><span class="o">.</span><span class="n">print_datacount</span><span class="p">()</span>
    <span class="n">test</span><span class="o">.</span><span class="n">print_datacount_score</span><span class="p">()</span>
    <span class="n">test</span><span class="o">.</span><span class="n">eval</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
    <span class="n">latents</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;latent&quot;</span><span class="p">]</span>
    <span class="n">scale_1_latents</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;s1_latent&quot;</span><span class="p">]</span>
    <span class="n">scale_2_latents</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;s2_latent&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;eval---------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;datalen: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;score: </span><span class="si">{</span><span class="n">scores</span><span class="si">}{</span><span class="n">scores</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">latents: </span><span class="si">{</span><span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s1_latents: </span><span class="si">{</span><span class="n">scale_1_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s2_latents: </span><span class="si">{</span><span class="n">scale_2_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">scale_2_latents</span><span class="p">)</span>
    <span class="n">test</span><span class="o">.</span><span class="n">eval</span><span class="o">=</span><span class="kc">False</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
    <span class="n">latents</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;latent&quot;</span><span class="p">]</span>
    <span class="n">scale_1_latents</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;s1_latent&quot;</span><span class="p">]</span>
    <span class="n">scale_2_latents</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;s2_latent&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;train---------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;datalen: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;score: </span><span class="si">{</span><span class="n">scores</span><span class="si">}{</span><span class="n">scores</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">latents: </span><span class="si">{</span><span class="n">latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s1_latents: </span><span class="si">{</span><span class="n">scale_1_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;s2_latents: </span><span class="si">{</span><span class="n">scale_2_latents</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">scale_2_latents</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to cuda&quot;</span><span class="p">)</span>
    <span class="n">musiq_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test run&quot;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">musiq_model</span><span class="p">(</span><span class="n">latents</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">),</span> <span class="n">scale_1_latents</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">),</span> <span class="n">scale_2_latents</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">lora_dataset_toolsy</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>ナビゲーション</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">モジュールコード</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, NEXTAltair.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.0.2</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>