# Issue #7: AutoCrop Margin Logic Implementation Plan (修正版)

**作成日**: 2025-11-29  
**Issue**: #7 AutoCropマージンロジックのレビューと改善  
**対象ファイル**: `src/lorairo/editor/autocrop.py:347`  
**推定作業時間**: 3.5-4.75時間（スコープ縮小版）

## 問題定義

### 現状の課題
- **ハードコード**: 5ピクセル固定マージン（Line 347-351）
- **根拠不明**: なぜ5pxなのか文書化されていない
- **仕様書の疑問**: `docs/specs/core/image_processing.md` L46で設定可能化を検討中
- **テストギャップ**: マージンロジックの検証テストが存在しない

### 成功基準
1. マージン計算の根拠を明確化
2. バウンディングボックスサイズに応じた適切なマージン
3. 負のクロップ領域を確実に防止
4. 既存21テストケースが全てパス（リグレッション回避）
5. コード・仕様書に設計判断が文書化

## 採用ソリューション: バウンディングボックスベースの動的マージン

### 設計原則

**マージン計算の基準**:
- ❌ **誤り**: 画像全体のサイズ（`min(height, width)`）
- ✅ **正解**: 検出されたバウンディングボックスのサイズ（`x_max - x_min`, `y_max - y_min`）

**理由**:
大きなキャンバス中央に小さく写っている被写体の場合、画像全体を基準にすると巨大なマージンが適用され被写体を切り落とします。マージンは実際に検出されたコンテンツ領域を基準に計算する必要があります。

### 実装式

```python
# バウンディングボックスのサイズを取得
bbox_width = x_max - x_min
bbox_height = y_max - y_min

# 各軸のマージンを個別に計算（0.5%、最小2px）
margin_x = max(2, int(bbox_width * 0.005))
margin_y = max(2, int(bbox_height * 0.005))

# 負のクロップ領域を防ぐ安全性チェック
if bbox_width > 2 * margin_x and bbox_height > 2 * margin_y:
    x_min = max(0, x_min + margin_x)
    y_min = max(0, y_min + margin_y)
    x_max = min(width, x_max - margin_x)
    y_max = min(height, y_max - margin_y)
    logger.debug(f"Applied margin: x={margin_x}px, y={margin_y}px")
else:
    logger.debug(
        f"Bbox too small for margin (bbox: {bbox_width}x{bbox_height}, "
        f"required: >{2*margin_x}x{2*margin_y}), skipping margin"
    )
```

### 設計の根拠

1. **軸ごとの計算**: 非正方形バウンディングボックスに適切に対応
2. **安全性チェック**: `bbox_width > 2 * margin_x` で負の寸法を確実に防止
3. **最小マージン**: 2px下限で極小バウンディングボックスを保護
4. **ログ出力**: デバッグ時にマージン適用状況を確認可能

## 実装計画（スコープ縮小版）

### Phase 1: コアロジック実装（1-1.5時間）

**対象**: `src/lorairo/editor/autocrop.py` L346-354

**変更内容**:
- バウンディングボックスベースのマージン計算
- 安全性チェック追加
- デバッグログ追加
- FIXMEコメント削除
- docstring更新

### Phase 2: 基本テスト実装（1.5-2時間）

**対象**: `tests/unit/test_autocrop.py`

**追加テストクラス**: `TestAutoCropMarginLogic`（5テストケース）
1. バウンディングボックスベースのマージン計算
2. 非正方形バウンディングボックスでの軸ごと計算
3. 小さすぎるバウンディングボックスでのマージンスキップ
4. 安全性チェックによる負の寸法防止
5. デバッグログ出力

**リグレッション**: 既存21テストケース全パス確認

### Phase 3: 手動検証（30-45分）

**検証方法**: 既存テスト画像で手動確認
- 小画像: `tests/resources/img/under-512/`
- 中画像: `tests/resources/img/under-1024/`
- ログ出力確認

### Phase 4: ドキュメント更新（30分）

**対象**: `docs/specs/core/image_processing.md` Section 2.2

**重要**: 確認事項2を**削除せず**、現在の実装を追記する形で残す

## 変更ファイル一覧

1. `src/lorairo/editor/autocrop.py` (L346-354)
2. `tests/unit/test_autocrop.py` (5テストケース追加)
3. `docs/specs/core/image_processing.md` (Section 2.2)

## リスク評価

### リスク1: バウンディングボックスが予期せず小さい
- 可能性: 中 / 影響: 中
- 対策: デバッグログで記録、手動検証で頻度確認

### リスク2: 後方互換性
- 可能性: 高 / 影響: 低～中
- 対策: バウンディングボックス基準が正しい設計判断、文書化

### リスク3: 安全性チェックのロジックミス
- 可能性: 低 / 影響: 高
- 対策: 専用テストで境界条件を網羅

## 推定作業時間

| Phase | 時間 | 説明 |
|-------|------|------|
| Phase 1 | 1-1.5時間 | コアロジック |
| Phase 2 | 1.5-2時間 | テスト実装 |
| Phase 3 | 30-45分 | 手動検証 |
| Phase 4 | 30分 | 仕様書更新 |
| **合計** | **3.5-4.75時間** | 現実的なスコープ |

## 成功指標

**実装成功**:
- ✅ バウンディングボックスベースのマージン計算実装
- ✅ 安全性チェックで負の寸法を確実に防止
- ✅ 既存テスト全パス（21/21）
- ✅ 新規テスト全パス（5/5）

**検証成功**:
- ✅ 手動検証で小/中画像が適切にクロップ
- ✅ デバッグログでマージン適用状況を確認
- ✅ バウンディングボックスが小さい場合のマージンスキップ確認

**ドキュメント成功**:
- ✅ コード内に設計根拠が明記
- ✅ 仕様書に計算式と例が追記
- ✅ 確認事項2が残り、将来の設定可能化の余地を保持

## 補足事項

- 定数0.005（0.5%）は今後の検証結果に基づき調整可能
- 将来的な拡張: `config/lorairo.toml`でマージン係数を設定可能化
- デバッグログレベル: `logger.debug()` で通常運用時はノイズにならない
