# ページネーション機能 アプローチ比較検討

**日付**: 2026-02-05
**Issue**: 18,252件の検索結果表示でタイムアウト発生
**ログ**: `lorairo.log` - 検索完了後に処理キャンセル

## 問題の背景

### 現状の実装
- **サムネイル表示**: QGraphicsScene + QGraphicsView（非仮想化）
- **データ取得**: 全件取得（LIMIT/OFFSETなし）
- **メモリ管理**: 全件QPixmapキャッシュ（表示範囲最適化なし）

### 現在のメモリ保持状況

| データ | 保持場所 | 内容 |
|--------|---------|------|
| メタデータ | `SearchResult.image_metadata` | dict形式（ID, パス, タグ等）— 軽量 |
| 画像ファイル | `ThumbnailSelectorWidget.image_cache` | QPixmap形式で全件保持 |
| スケール済み画像 | `ThumbnailSelectorWidget.scaled_cache` | サイズ変更用キャッシュ |

### 問題の本質
18,252件のQPixmapを全てメモリに保持している点が重い原因：
```
18,252件 × 512×512px × 4bytes(RGBA) ≈ 18GB（非圧縮時）
```
実際はQt内部で圧縮されるが、数GBのメモリを消費している可能性あり。

---

## 検討した4つのアプローチ

### 1. 従来型ページネーション（ページ番号ナビゲーション）

```
[< 前へ] [1] [2] [3] ... [183] [次へ >]  (100件/ページ)
```

**実装方法**:
- DBクエリに `LIMIT/OFFSET` 追加
- ページ切り替え時に新規クエリ実行
- UI下部にページネーションバー追加

| 項目 | 評価 |
|------|------|
| 実装難易度 | ⭐ 低（最も単純） |
| メモリ効率 | ⭐⭐⭐ 高（1ページ分のみ保持） |
| UX | ⭐⭐ 中（ページ遷移の操作が必要） |
| 既存コードへの影響 | ⭐⭐ 中（検索パイプライン修正） |

**メリット**:
- 実装がシンプル、予測可能な動作
- メモリ使用量が一定（ページサイズ × サムネイルサイズ）
- 総件数の把握が容易

**デメリット**:
- ページ遷移のたびに待機時間が発生
- 連続スクロールでの閲覧体験が途切れる
- 複数選択がページをまたぐと複雑になる

---

### 2. 無限スクロール（Lazy Loading）

```
スクロール末尾到達 → 追加100件読み込み → 表示に追加
```

**実装方法**:
- スクロール位置監視（viewport末尾検出）
- 追加データ読み込み（cursor-based または offset-based）
- 既存アイテムに追加

| 項目 | 評価 |
|------|------|
| 実装難易度 | ⭐⭐ 中 |
| メモリ効率 | ⭐⭐ 中（スクロール量に比例して増加） |
| UX | ⭐⭐⭐ 高（シームレスなスクロール） |
| 既存コードへの影響 | ⭐⭐ 中 |

**メリット**:
- 自然なスクロール体験
- 初期読み込みが高速
- SNS/画像サイトで馴染みのあるパターン

**デメリット**:
- 長時間スクロールするとメモリが増加し続ける
- 「最後に戻る」が困難
- 総件数の位置感覚がつかみにくい

---

### 3. 仮想スクロール（Virtual Scrolling）

```
表示領域のアイテムのみレンダリング、スクロールバーは全体サイズを反映
```

**実装方法**:
- オプションA: QListView + QAbstractItemModel（Qt標準の仮想化）
- オプションB: QGraphicsViewでカスタム仮想化実装
- 表示範囲計算 → 必要なアイテムのみ生成/描画

| 項目 | 評価 |
|------|------|
| 実装難易度 | ⭐⭐⭐ 高（アーキテクチャ変更） |
| メモリ効率 | ⭐⭐⭐ 高（表示分のみ保持） |
| UX | ⭐⭐⭐ 高（高速スクロール） |
| 既存コードへの影響 | ⭐⭐⭐ 高（ThumbnailWidget大幅改修） |

**メリット**:
- 18,000件でも100件でも同じパフォーマンス
- スクロールバーで全体位置が把握可能
- メモリ使用量が一定

**デメリット**:
- QGraphicsView → QListViewへの移行が必要（または複雑なカスタム実装）
- 高速スクロール時のちらつき対策が必要
- 実装工数が最も大きい

---

### 4. ハイブリッド（仮想スクロール＋ページ区切り）

```
[ページ1-10: 1000件] ← 仮想スクロール → [ページ11-20へ]
```

**実装方法**:
- 大きなページ単位（例：1000件）でDBから取得
- ページ内は仮想スクロールで表示
- ページ境界でナビゲーション

| 項目 | 評価 |
|------|------|
| 実装難易度 | ⭐⭐⭐ 高 |
| メモリ効率 | ⭐⭐⭐ 高 |
| UX | ⭐⭐⭐ 高（バランス良好） |
| 既存コードへの影響 | ⭐⭐⭐ 高 |

**メリット**:
- 仮想スクロールの利点を享受
- 大量データでもDB負荷を分散

**デメリット**:
- 実装が最も複雑
- 両方の仕組みを理解・保守する必要

---

## 比較マトリクス

| アプローチ | 実装コスト | メモリ効率 | UX | 推奨シナリオ |
|-----------|-----------|-----------|-----|------------|
| 1. 従来型ページネーション | 低 | 高 | 中 | 短期解決、MVP |
| 2. 無限スクロール | 中 | 中 | 高 | SNS風UI |
| 3. 仮想スクロール | 高 | 高 | 高 | 長期的ベスト |
| 4. ハイブリッド | 高 | 高 | 高 | 超大規模データ |

---

## ユーザーとの議論ポイント

### Q1: DBクエリの重さ
**ユーザー回答**: 「DBから全件取得は今の段階では重くない」
**結論**: DB層の変更は不要、表示側のみ改善

### Q2: 現在のメモリ保持内容
**質問**: 画像ファイルもメモリに保持している？サムネ用512px？
**回答**:
- メタデータ: 全件dict保持（軽量）
- 画像: QPixmap形式で全件保持（512px優先だが重い）

### Q3: 改善提案
**ユーザー提案**: 「DBの情報は全件、サムネイルは1ページ分+余裕を見たページ数で、それ以後はページ遷移に伴って表示切り替え中に読み込む」

---

## 採用アプローチ：表示側ページネーション + プリフェッチ

### コンセプト
```
[全件メタデータ] + [表示ページ + 前後Nページ分のサムネイル]
```

### 動作イメージ
```
Page 1 表示中:
  [Page 1] [Page 2] [Page 3] ← メモリ保持（先読み2ページ）
  [Page 4] [Page 5] ...     ← 未読み込み

Page 3 に遷移:
  読み込み中表示 → [Page 2][Page 3][Page 4][Page 5] をバックグラウンドロード
  [Page 1] ← キャッシュから解放（オプション）
```

### 実装構成

| コンポーネント | 責務 |
|--------------|------|
| `PaginationState` | 現在ページ、総ページ数、ページサイズ管理 |
| `ThumbnailCache` | LRUキャッシュでページ単位の画像管理 |
| `PaginationWidget` | ページナビゲーションUI |
| `ThumbnailSelectorWidget` | キャッシュ連携、表示更新 |

### パラメータ案

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `page_size` | 100件 | 1ページあたりの表示件数 |
| `prefetch_pages` | 2 | 前後に先読みするページ数 |
| `max_cached_pages` | 5 | キャッシュに保持する最大ページ数 |

### メモリ使用量比較
- **現状**: 18,252件分のQPixmap
- **改善後**: 5ページ × 100件 = 500件分のQPixmap（**約3%に削減**）

---

## 選定理由

1. **即効性**: 現在のタイムアウト問題を最小コストで解決
2. **UX維持**: プリフェッチにより遷移時の待機時間を最小化
3. **既存アーキテクチャ活用**: ThumbnailSelectorWidgetの拡張で対応可能
4. **将来の拡張性**: 仮想スクロール移行への足がかりとなる

---

## 次のステップ

1. Plan Modeで詳細設計
2. 実装フェーズ（ThumbnailCache, PaginationWidget, ThumbnailSelectorWidget改修）
3. テスト（大量データでのパフォーマンス検証）

---

**関連ファイル**:
- `src/lorairo/gui/widgets/thumbnail.py` - ThumbnailSelectorWidget
- `src/lorairo/gui/workers/thumbnail_worker.py` - ThumbnailWorker
- `src/lorairo/gui/services/pipeline_control_service.py` - 検索パイプライン

**関連Issue**: なし（新規機能）
