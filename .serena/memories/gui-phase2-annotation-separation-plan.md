# Phase 2: アノテーション系責任分離計画書

## 🎯 **Phase概要**
**目的**: アノテーション系ウィジェットのモノリシック構造を責任分離し、統一アーキテクチャを適用

**優先度**: 高  
**推定工数**: 8-12時間  
**前提条件**: Phase 1のFilterSearchPanel統一化パターンが確立済み  
**成果物**: 責任分離されたAnnotationControlWidget + 新規ModelManager + 簡素化ModelSelectionWidget

## 📋 **対象ウィジェット分析**

### **現状の問題**
- **AnnotationControlWidget**: UI/ロジック/設定管理が混在するモノリシック構造
- **ModelSelectionWidget**: 動的UI生成とビジネスロジックが結合
- **AnnotationCoordinator**: 調整機能は良好だが、他ウィジェットとの連携に改善余地

### **責任分離戦略**
- **UI層**: 表示・ユーザーインタラクション専用
- **ロジック層**: モデル管理・設定管理専用（新規ModelManager）
- **状態層**: DatasetStateManager統合による統一状態管理

## 📋 **詳細タスク分割** (12タスク)

### 🔍 **Task 2.1: 現状ウィジェット責任分析** (1-2時間)
**目的**: 現在の責任範囲と課題の詳細把握  
**状態**: 未開始  
**依存関係**: なし  

**実行内容**:
- AnnotationControlWidget の責任範囲分析
- ModelSelectionWidget の機能分析
- AnnotationCoordinator の連携パターン分析
- 責任混在ポイントの特定と分離対象の明確化

**成果物**:
- [ ] 責任分析レポート
- [ ] 分離対象機能リスト
- [ ] 現状アーキテクチャ図

### 🏗️ **Task 2.2: 責任分離アーキテクチャ設計** (1-2時間)
**目的**: Phase 1パターンを適用した責任分離設計  
**状態**: 未開始  
**依存関係**: Task 2.1完了  

**実行内容**:
- UI/ロジック/状態の明確な分離設計
- 新規ModelManagerサービスクラス設計
- DatasetStateManager統合パターン適用
- AnnotationCoordinatorとの連携設計更新

**成果物**:
- [ ] 責任分離アーキテクチャ設計書
- [ ] ModelManagerクラス設計
- [ ] 統合パターン設計書

### ⚙️ **Task 2.3: ModelManagerサービス設計** (1時間)
**目的**: モデル管理ロジックの独立サービス化  
**状態**: 未開始  
**依存関係**: Task 2.2完了  

**実行内容**:
- モデル情報管理ロジックの抽出設計
- モデル選択・フィルタリング・検証ロジック設計
- AnnotatorLibAdapter連携インターフェース設計
- キャッシュ・パフォーマンス最適化設計

**成果物**:
- [ ] ModelManagerサービス詳細設計
- [ ] API仕様書
- [ ] パフォーマンス最適化計画

### 🎨 **Task 2.4: AnnotationControlWidget UI分離実装** (2-3時間)
**目的**: UI表示専用ウィジェットへの変換  
**状態**: 未開始  
**依存関係**: Task 2.2完了  

**実行内容**:
- UI表示専用ロジックの実装
- ビジネスロジックの除去とModelManager連携
- DatasetStateManager統合実装
- シグナル/スロット整理・最適化

**成果物**:
- [ ] UI専用AnnotationControlWidget実装
- [ ] ModelManager連携実装
- [ ] 状態管理統合実装

### 🔧 **Task 2.5: ModelManager実装** (2時間)
**目的**: 独立モデル管理サービスの実装  
**状態**: 未開始  
**依存関係**: Task 2.3完了  

**実行内容**:
- モデル情報管理機能実装
- 動的モデル取得・フィルタリング実装
- モデル選択ロジック・検証機能実装
- AnnotatorLibAdapter統合実装

**成果物**:
- [ ] 完全なModelManager実装
- [ ] モデル管理API実装
- [ ] テスト済み機能確認

### 🖼️ **Task 2.6: ModelSelectionWidget簡素化** (1-2時間)
**目的**: UI生成専用ウィジェットへの変換  
**状態**: 未開始  
**依存関係**: Task 2.5完了  

**実行内容**:
- 動的UI生成ロジックの簡素化
- ModelManager連携による機能移譲
- UI更新・表示専用ロジックの実装
- パフォーマンス最適化

**成果物**:
- [ ] 簡素化されたModelSelectionWidget
- [ ] ModelManager連携実装
- [ ] UI性能最適化実装

### 🔗 **Task 2.7: AnnotationCoordinator統合更新** (1時間)
**目的**: 新アーキテクチャとの調整役最適化  
**状態**: 未開始  
**依存関係**: Task 2.4, 2.6完了  

**実行内容**:
- 新ウィジェット構成との連携更新
- ワークフロー調整の最適化
- エラーハンドリング・状態管理の改善
- パフォーマンス向上のための最適化

**成果物**:
- [ ] 最適化されたAnnotationCoordinator
- [ ] 新アーキテクチャ連携実装
- [ ] ワークフロー最適化

### 🏢 **Task 2.8: MainWorkspaceWindow統合更新** (30分)
**目的**: メインウィンドウでの新構成統合  
**状態**: 未開始  
**依存関係**: Task 2.7完了  

**実行内容**:
- 新ウィジェット構成のインスタンス化
- ModelManagerサービスの統合
- 既存接続の更新・最適化
- 統合動作確認

**成果物**:
- [ ] MainWorkspaceWindow統合実装
- [ ] サービス統合確認
- [ ] 動作検証完了

### 🧪 **Task 2.9: 単体テスト作成** (2時間)
**目的**: 分離された各コンポーネントの品質保証  
**状態**: 未開始  
**依存関係**: Task 2.4, 2.5, 2.6完了 (部分並行実行可能)  

**実行内容**:
- ModelManager単体テスト作成
- 分離されたAnnotationControlWidget単体テスト作成
- 簡素化ModelSelectionWidget単体テスト作成
- DatasetStateManager連携テスト作成

**成果物**:
- [ ] 完全な単体テストスイート
- [ ] カバレッジ75%以上確保
- [ ] モック戦略実装

### 🔗 **Task 2.10: AnnotationCoordinatorテスト** (1時間)
**目的**: ワークフロー調整機能の品質保証  
**状態**: 未開始  
**依存関係**: Task 2.7完了  

**実行内容**:
- AnnotationCoordinator統合テスト作成
- ワークフロー動作テスト実装
- エラーケース・例外処理テスト
- パフォーマンステスト実行

**成果物**:
- [ ] AnnotationCoordinator統合テスト
- [ ] ワークフロー検証完了
- [ ] 例外処理テスト完了

### 🔍 **Task 2.11: 統合テスト・回帰テスト** (1時間)
**目的**: アノテーション機能全体の動作確認  
**状態**: 未開始  
**依存関係**: Task 2.8, 2.9, 2.10完了  

**実行内容**:
- アノテーションワークフロー統合テスト
- ModelManager連携テスト
- MainWorkspaceWindow統合テスト
- 既存機能の回帰テスト実行

**成果物**:
- [ ] 統合テスト結果レポート
- [ ] 回帰テスト合格確認
- [ ] パフォーマンス検証結果

### 🧹 **Task 2.12: リファクタリング完了・クリーンアップ** (30分)
**目的**: 不要コード除去と文書更新  
**状態**: 未開始  
**依存関係**: Task 2.11完了  

**実行内容**:
- 分離前の古いロジック除去
- インポート文・依存関係の整理
- ドキュメント・コメント更新
- コード品質最終確認

**成果物**:
- [ ] クリーンな実装
- [ ] 更新されたドキュメント
- [ ] 品質確認完了

## ⏱️ **推定時間詳細**
- **高優先度タスク**: 6-8時間 (Task 2.1, 2.2, 2.4, 2.5, 2.6)
- **中優先度タスク**: 4-5時間 (Task 2.3, 2.7, 2.9, 2.10, 2.11)  
- **低優先度タスク**: 1時間 (Task 2.8, 2.12)
- **合計**: 11-14時間

## 🎯 **成功基準**
- [ ] **責任分離完了**: UI/ロジック/状態の明確な分離実現
- [ ] **ModelManager独立**: モデル管理の完全なサービス化
- [ ] **UI簡素化**: 表示専用ウィジェットへの変換完了
- [ ] **テストカバレッジ75%以上**: 品質保証基準満足
- [ ] **ワークフロー維持**: 既存アノテーション機能の100%互換性

## 🔗 **Phase間依存関係**
- **Phase 1からの継承**: DatasetStateManager統合パターンの適用
- **Phase 3への影響**: 責任分離パターンの標準化
- **全体への影響**: サービス層分離パターンの確立

## 📋 **並行実行可能性**
- **Task 2.3**: Task 2.2完了後、Task 2.4と部分並行実行可能
- **Task 2.9（部分）**: Task 2.4, 2.5, 2.6完了後の部分並行実行
- **設計フェーズ並行**: Task 2.1-2.3の一部重複実行可能

## 🔄 **技術的チャレンジ**
- **モデル管理の複雑性**: 200+モデルの効率的管理
- **動的UI生成**: パフォーマンスを維持した簡素化
- **ワークフロー調整**: 既存機能を壊さない段階的移行

## 🔄 **次フェーズ準備**
- Phase 3でのプレビュー系への責任分離パターン適用
- Master調整での統合アーキテクチャパターンの標準化
- 全体品質向上のための知見共有

---
**作成日**: 2025/08/02  
**フェーズ**: Phase 2 - アノテーション系責任分離  
**ステータス**: 計画完了・Phase 1完了後実行可能  
**前提条件**: Phase 1の統一アーキテクチャパターン確立