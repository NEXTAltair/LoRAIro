# MCP使用ルール（cipher/serena）

## 役割分担

### serena（読む・まとめる）
- **役割**: コード/ドキュメントの読解、要約、差分把握、計画草案作成
- **入出力**: `.serena/memories/`（機械メモリ）にのみ書き込み
- **制約**: コード編集、コマンド実行、外部MCP呼出などの副作用のある操作は行わない

### cipher（実行・編成する）
- **役割**: 実装/編集、コマンド実行、他MCP呼出、ドキュメント/タスク反映
- **入出力**: `docs/` と `tasks/` を更新（必要に応じて `.serena/memories/` の要点を同期）
- **制約**: 変更は必ず関連ドキュメント更新とテスト/リンタ実行を伴う

## 保存場所と原本
- **機械メモリの原本**: `.serena/memories/`（serenaが管理）
- **人間向け計画の原本**: `tasks/`（cipherが更新）
- **設計/仕様の原本**: `docs/`（cipherが更新）

## 運用フロー
1. **PLAN（調査/設計）**
   - serena が `docs/` と `src/` を読んで要約/差分/計画草案を `.serena/memories/` に記録
   - 必要箇所のみを cipher が `tasks/` に鏡像（要約や次アクション）
2. **ACT（実装/検証）**
   - cipher がコード編集/コマンド実行/テスト・Lint/ドキュメント更新
   - 重要知見は必要に応じて `.serena/memories/` に反映（要点のみ）

## 使い分け判断基準
- 「読む/理解/棚卸/比較/計画案作成」→ serena
- 「編集/実行/検証/公開/記録反映」→ cipher
- 「他MCP（web検索等）が必要」→ cipher
- 不明点が多い場合は serena で解像度を上げ、その結果を受けて cipher が実行

## 禁止事項
- serena がコードや `tasks/` を直接編集すること
- cipher がドキュメント未参照のまま編集すること
- シークレットや API キーをMCPログ/プロンプトに出力すること

## 実行ガイドライン（cipher）
- コマンドは非対話フラグを付与（`--yes` 等）
- 長時間/常駐ジョブはバックグラウンド実行
- 変更後は Lint/型/テスト（該当範囲）を実行し、失敗時は修正してから完了とする
- 変更点は `docs/` と `tasks/` を同期し、必要なら `.serena/memories/` にも要点を反映

## ドキュメント更新義務
- 設計/仕様変更時は `docs/` を更新
- タスク/進行は `tasks/active_context.md` と `tasks/tasks_plan.md` を更新
- serena の学習結果は `.serena/memories/` に保存（mirror は最小限）