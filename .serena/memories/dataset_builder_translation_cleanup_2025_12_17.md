# Dataset Builder - ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½è¿½åŠ 

## æ—¥ä»˜
2025å¹´12æœˆ17æ—¥

## èƒŒæ™¯

tags_v4.dbã«èµ·å› ã™ã‚‹ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã®å“è³ªå•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’è¿½åŠ :

1. **ä¸­å›½èªã®èª¤ç™»éŒ²**: language='ja' ã«ä¸­å›½èªãŒæ··å…¥ï¼ˆä¾‹: æ–°å¹´å¿«æ¨‚ï¼‰
2. **è‹±å˜èªã®èª¤ç™»éŒ²**: language='ja' ã«è‹±å˜èªãŒæ··å…¥ï¼ˆä¾‹: helloï¼‰
3. **è¨˜å·ãƒ»çµµæ–‡å­—ã®æ··å…¥**: language='ja/zh/ko' ã«å¿…é ˆæ–‡å­—ç¨®ã‚’å«ã¾ãªã„ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹: ï¼ï¼ã€abcï¼‰
4. **å…¨è§’è¨˜å·ã®æ··åœ¨**: ã‚¿ã‚°æ­£è¦åŒ–æ™‚ã«å…¨è§’ã‚³ãƒ­ãƒ³ç­‰ãŒæ®‹ç•™

## å®Ÿè£…å†…å®¹

### 1. æ–°è¦é–¢æ•°è¿½åŠ ï¼ˆbuilder.pyï¼‰

#### `_normalize_language_value(value: str) -> str`
- è¨€èªå€¤ã‚’æ­£è¦åŒ–ï¼ˆjapanese â†’ jaã€zh-Hant â†’ zhï¼‰
- tags_v4.dbã®languageå€¤ã«é©ç”¨

#### `_delete_ja_translations_by_value_list(conn, values: list[str]) -> int`
- ç‰¹å®šã®ç¿»è¨³å€¤ãƒªã‚¹ãƒˆã«ä¸€è‡´ã™ã‚‹ language='ja' ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
- TEMPè¡¨ã‚’ä½¿ç”¨ã—ãŸåŠ¹ç‡çš„ãªå‰Šé™¤ï¼ˆ10,000ä»¶å˜ä½ã§ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼‰
- æˆ»ã‚Šå€¤: å‰Šé™¤ã•ã‚ŒãŸè¡Œæ•°

#### `_delete_translations_ascii_only_for_languages(conn, languages: set[str]) -> int`
- æŒ‡å®šè¨€èªã®ã†ã¡ã€ASCIIæ–‡å­—ã®ã¿ã®ç¿»è¨³ã‚’å‰Šé™¤
- å¯¾è±¡: ja/zh/koï¼ˆromajiä½œå“åç­‰ã¯ä¸è¦ã¨åˆ¤æ–­ï¼‰

#### `_delete_translations_missing_required_script(conn, language: str) -> int`
- è¨€èªã”ã¨ã®å¿…é ˆæ–‡å­—ç¨®ã‚’å«ã¾ãªã„ç¿»è¨³ã‚’å‰Šé™¤
- ja: ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠ/æ¼¢å­—ï¼ˆCJKï¼‰ã®ã„ãšã‚Œã‹å¿…é ˆ
- zh: æ¼¢å­—ï¼ˆCJKï¼‰å¿…é ˆ
- ko: ãƒãƒ³ã‚°ãƒ«å¿…é ˆ
- æ­£è¦è¡¨ç¾ã§Unicodeãƒ¬ãƒ³ã‚¸åˆ¤å®š

#### `_load_column_values_from_csv(csv_path, column_name, ...) -> list[str]`
- CSVã‹ã‚‰ç‰¹å®šã‚«ãƒ©ãƒ ã®å€¤ã‚’ãƒªã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
- é‡è¤‡é™¤å¤–ãƒ»ç©ºå€¤é™¤å¤–
- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡å€¤ã®å–å¾—ã«ä½¿ç”¨

### 2. Phase 1ã®å¤‰æ›´

tags_v4.dbã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«languageå€¤ã‚’æ­£è¦åŒ–:
```python
normalized_lang = _normalize_language_value(row["language"])
conn.execute(
    "INSERT OR IGNORE INTO TAG_TRANSLATIONS (...) VALUES (...)",
    (..., normalized_lang, ...)
)
```

### 3. Phase 2å¾Œã®æ–°è¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†

#### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä»•æ§˜A: ç‰¹å®šCSVã¨ã®é‡è¤‡å‰Šé™¤

å¯¾è±¡CSVï¼ˆinclude/excludeãƒ•ã‚£ãƒ«ã‚¿ã§ä»Šå›ãƒ“ãƒ«ãƒ‰ã«å«ã¾ã‚Œã‚‹å ´åˆã®ã¿å®Ÿè¡Œï¼‰:

1. **Tags_zh_full.csv** (CC0):
   - ã‚«ãƒ©ãƒ : `zh-Hant`
   - å‡¦ç†: ã“ã®å€¤ã¨ä¸€è‡´ã™ã‚‹ language='ja' ã‚’å‰Šé™¤
   - ç†ç”±: ä¸­å›½èªãŒjaã«èª¤ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ä¿®æ­£

2. **EnglishDictionary.csv** (MIT):
   - ã‚«ãƒ©ãƒ : `source_tag`
   - å‡¦ç†: ã“ã®å€¤ã¨ä¸€è‡´ã™ã‚‹ language='ja' ã‚’å‰Šé™¤
   - ç†ç”±: è‹±å˜èªãŒjaã«èª¤ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ä¿®æ­£

å®Ÿè£…ç®‡æ‰€: Phase 2ã®å…¨ã‚½ãƒ¼ã‚¹å‡¦ç†å¾Œã€Phase 2.5ã®å‰ã«å®Ÿè¡Œ

#### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä»•æ§˜B: å¿…é ˆæ–‡å­—ç¨®ãƒã‚§ãƒƒã‚¯

å¯¾è±¡è¨€èª: ja, zh, ko

å„è¨€èªã§å¿…é ˆæ–‡å­—ç¨®ã‚’å«ã¾ãªã„ç¿»è¨³ã‚’å‰Šé™¤:
- çµµæ–‡å­—ã®ã¿ï¼ˆä¾‹: ğŸ˜Šï¼‰
- è¨˜å·ã®ã¿ï¼ˆä¾‹: ï¼ï¼ã€ï¼šï¼šï¼‰
- ASCIIæ–‡å­—ã®ã¿ï¼ˆä¾‹: abcã€Digimon Universeï¼šAppli Monstersï¼‰

### 4. æ­£è¦åŒ–æ©Ÿèƒ½å¼·åŒ–ï¼ˆcore/normalize.pyï¼‰

å…¨è§’è¨˜å·ã‚’åŠè§’ASCIIè¨˜å·ã«å¤‰æ›:
```python
fullwidth_to_ascii = str.maketrans({
    "ï¼š": ":", "ï¼Œ": ",", "ï¼": ".", "ï¼›": ";",
    "ï¼": "!", "ï¼Ÿ": "?", "ï¼ˆ": "(", "ï¼‰": ")",
    "ï¼»": "[", "ï¼½": "]", "ï½›": "{", "ï½": "}",
    "ï¼": "/", "ï¼¼": "\\", "ï¼‹": "+", "ï¼": "=",
    "ï¼": "-", "ï¼Š": "*", "ï¼†": "&", "ï¼…": "%",
    "ï¼ƒ": "#", "ï¼ ": "@", "ï¼¾": "^", "ï½": "~",
    "ï½œ": "|", "ï¼œ": "<", "ï¼": ">", "ã€€": " ",
})
s = s.translate(fullwidth_to_ascii)
```

### 5. ãƒ©ã‚¤ã‚»ãƒ³ã‚¹åŒºåˆ†å¤‰æ›´

- `danbooru_klein10k_jp.csv` ã‚’MITã‹ã‚‰CC0ã¸ç§»å‹•
  - `license_builds/include_mit_sources.txt`: å‰Šé™¤
  - `license_builds/include_cc0_sources.txt`: è¿½åŠ 

### 6. ãƒ†ã‚¹ãƒˆè¿½åŠ 

`tests/unit/test_translation_cleanup.py`:
- `test_delete_ja_translations_by_value_list_deletes_only_ja`: jaç¿»è¨³ã®ã¿å‰Šé™¤ç¢ºèª
- `test_delete_ja_translations_by_value_list_empty_is_noop`: ç©ºãƒªã‚¹ãƒˆã§no-opç¢ºèª
- `test_load_column_values_from_csv_reads_zh_hant`: CSVèª­ã¿è¾¼ã¿ç¢ºèª
- `test_normalize_language_value_maps_names`: è¨€èªåæ­£è¦åŒ–ç¢ºèª
- `test_delete_translations_ascii_only_for_languages`: ASCIIæ–‡å­—å‰Šé™¤ç¢ºèª
- `test_delete_translations_missing_required_script_ja`: å¿…é ˆæ–‡å­—ç¨®ãƒã‚§ãƒƒã‚¯ç¢ºèª

## ãƒ†ã‚¹ãƒˆçµæœ

- å…¨125ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: âœ… PASS
- ã‚«ãƒãƒ¬ãƒƒã‚¸: 61.48%ï¼ˆè¦æ±‚55%è¶…ï¼‰

## å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

1. `src/genai_tag_db_dataset_builder/builder.py`: +295è¡Œ, -6è¡Œ
   - æ–°è¦é–¢æ•°5ã¤è¿½åŠ 
   - Phase 1/2ã®å¤‰æ›´
   - Phase 2å¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†è¿½åŠ 

2. `src/genai_tag_db_dataset_builder/core/normalize.py`:
   - å…¨è§’è¨˜å·â†’åŠè§’å¤‰æ›è¿½åŠ 

3. `license_builds/include_cc0_sources.txt`:
   - danbooru_klein10k_jp.csv è¿½åŠ 

4. `license_builds/include_mit_sources.txt`:
   - danbooru_klein10k_jp.csv å‰Šé™¤

5. `tests/unit/test_translation_cleanup.py`: æ–°è¦è¿½åŠ ï¼ˆ6ãƒ†ã‚¹ãƒˆï¼‰

## åŠ¹æœ

- ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã®å“è³ªå‘ä¸Šï¼ˆèª¤ç™»éŒ²è¨€èªã®é™¤å¤–ï¼‰
- ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ··å…¥ãƒªã‚¹ã‚¯ã®ä½æ¸›ï¼ˆCC0/MITåŒºåˆ†ã®æ˜ç¢ºåŒ–ï¼‰
- ã‚¿ã‚°æ­£è¦åŒ–ã®ä¸€è²«æ€§å‘ä¸Šï¼ˆå…¨è§’è¨˜å·ã®çµ±ä¸€ï¼‰
- source_effects.tsv ã®ç²¾åº¦å‘ä¸Šï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚‚è¨˜éŒ²ï¼‰

## é‹ç”¨æ³¨æ„ç‚¹

- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡CSVãŒ include/exclude ãƒ•ã‚£ãƒ«ã‚¿ã§é™¤å¤–ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯å®Ÿè¡Œã•ã‚Œãªã„
- CC0ç‰ˆã¨MITç‰ˆã§ç•°ãªã‚‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒé©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼ˆinclude ãƒªã‚¹ãƒˆã®é•ã„ï¼‰
